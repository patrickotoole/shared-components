<!DOCTYPE html>
<html>

<head>
    <title>Google Analytics</title>
    <style type="text/css">
    body {
        background-color: #F0F4F7 !important;
    }
    
    div.wrapper {
        position: relative;
        width: 1080px;
        margin: 0 auto;
        overflow: auto;
    }
    
    .topbar {
        margin-left: 0px !important;
        text-align: right;
    }
    
    .topbar a {
        color: #fff;
        font-size: 1.3em;
        line-height: 50px;
    }
    </style>
</head>

<body>
    <div class="topbar">
        <div class="wrapper">
            <a href="signout">Sign out</a>
        </div>
    </div>

    <div class="wrapper" id="content"></div>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic%7CUbuntu:300,300italic,400,400italic,500,500italic,700,700italic%7CInconsolata:400,400italic,700,700italic%7CLato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic">
    <link type="text/css" rel="stylesheet" href="/static/css/jquery.toast.css" />
    <link type="text/css" rel="stylesheet" href="/static/js/chosen/chosen.min.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/bootstrap.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/fonts.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/bootstrap-switch.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/bootstrap-select.css" />
    <link type="text/css" rel="stylesheet" href="/static/js/typeahead.js/typeahead.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/chartist.min.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/prism.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/style.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/font-awesome.min.css" />
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/start/build/start.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/filter/build/filter.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/media_plan/build/media_plan.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/sidebar.js"></script>
    <script type="text/javascript" src="/static/js/d3.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/rockerbox/turnip/build/turnip.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/components/build/components.js"></script>
    <script type="text/javascript" src="/static/js/queue.js"></script>
    <script type="text/javascript" src="/static/js/jquery.min.js"></script>
    <script type="text/javascript" src="/static/js/crossfilter.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.toast.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/routes/routes.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/routes/routes.navigation.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/menu/menu.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/menu/menu.navbar.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/menu/menu.selectbar.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/helper.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/subscribe.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/api.helpers.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/api.endpoints.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/api.js"></script>
    <script type="text/javascript" src="/static/js/advertiser/info.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/permissions.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/component.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/pie.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/metrics.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/action/init.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/funnel/wait.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/funnel/show.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/funnel/domains.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/funnel/avails.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/funnel/idf.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/funnel/init.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/funnel/final.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/controller.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/controller.funnel.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/controller.action.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/controller.campaign.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/controller.lookalike.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.gettingstarted.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.settings.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.subscription.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.pixel.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.home.js"></script>
    <!--<script type="text/javascript" src="/static/js/rockerbox/crusher/ui.vendors.js"></script>-->
    <script type="text/javascript" src="/static/js/rockerbox/crusher/vendor/build/vendors.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.vendors.table.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.vendors.expanded.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.keywords.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.dashboard.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.domains.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.clusters.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.comparison.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.full_url.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.top_keywords.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.behavior.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.tabs.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.timing.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.funnel.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.funnel.action.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.funnel.show.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.funnel.edit.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.funnel.campaign.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.funnel.campaign.lookalike.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.action.pattern.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/dashboard/build/dashboard.js"></script>
    <!--<script type="text/javascript" src="/static/js/rockerbox/crusher/mock.json"></script>-->
    <script type="text/javascript" src="/static/js/rockerbox/rho/ui.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/rho/ui.filter.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/crusher/ui.helpers.js"></script>
    <script type="text/javascript" src="/static/js/rockerbox/visit_urls.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-switch.js"></script>
    <script type="text/javascript" src="/static/js/jquery.serialize-object.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-select.js"></script>
    <script type="text/javascript" src="/static/js/typeahead.js/typeahead.bundle.js"></script>
    <script type="text/javascript" src="/static/js/chosen/chosen.jquery.min.js">
    </script>
    <script type="text/javascript" src="/static/js/chartist.min.js"></script>
    <script type="text/javascript" src="/static/js/prism.js" data-default-language="markup"></script>
    <script type="text/javascript" src="/static/js/cookie-toasts.js"></script>
    <script type="text/javascript">
    function d3_updateable(target, selector, type, data, joiner) {
        var type = type || "div"
        var updateable = target.selectAll(selector).data(
            function(x) {
                return data ? [data] : [x]
            },
            joiner || function(x) {
                return [x]
            }
        )

        updateable.enter()
            .append(type)

        return updateable
    }

    function d3_splat(target, selector, type, data, joiner) {
        var type = type || "div"
        var updateable = target.selectAll(selector).data(
            data || function(x) {
                return x
            },
            joiner || function(x) {
                return x
            }
        )

        updateable.enter()
            .append(type)

        return updateable
    }
    </script>
    <script type="text/javascript">
    var target = d3.select('#content');

    /*
        Site selector
    */

    var site_selector_wrapper = d3_updateable(target, '.site_selector_wrapper', 'section')
        .classed('site_selector_wrapper bar series col-md-12', true)
        .html('<div class="col-md-2"><strong>Select your site:</strong></div>');

    var site_selector = d3_updateable(site_selector_wrapper, '.site_selector', 'select')
        .classed('site_selector', true)
        .on('change', function(x, y, z) {
            loadData(this.value);
        });

    pubsub.subscriber("google_analytics_sites", ["google_analytics_sites"])
        .run(function(site_options) {
            var site_selector_options = d3_splat(site_selector, 'option', 'option', site_options, function(x){return x.id;})
                .text(function(x) {
                    return x.name;
                })
                .attr('value', function(x){
                    return x.id;
                })
                .datum(function(x){
                    return x;
                });
        })
        .unpersist(true)
        .trigger()

    /*
      Timeseries
    */
    var timeseries_chart = d3_updateable(target, '.timeseries_card', 'section')
        .classed('timeseries_card bar series col-md-12 show-loading', true)
        .style('min-height', '245px');

    timeseries_chart.exit().remove();

    /*
      Table
    */
    var table_wrapper = d3_updateable(target, '.table_card', 'section')
        .classed('table_card bar series col-md-12 show-loading', true);

    var table_data = {
        header: [{
            key: 'key',
            title: 'URL'
        }, {
            key: 'users',
            title: 'Unique users'
        }, {
            key: 'sessions',
            title: 'Sessions'
        }, {
            key: 'hits',
            title: 'Hits'
        }, {
            key: 'conversions',
            title: 'Conversions'
        }],
        body: []
    };

    var domains_table = components.table(table_wrapper)
        .data(table_data)
        .draw();

    var loadData = function(view_id) {
        pubsub.subscriber("google_analytics", ["google_analytics_data"])
            .run(function(data) {
                var visitors_per_day = {};
                var visitors_per_url = {};

                data['reports'][0]['data']['rows'].forEach(function(row) {
                    var page_url = row['dimensions'][1];
                    var date = row['dimensions'][2];
                    var visitor_count = parseInt(row['metrics'][0]['values'][0]);
                    var sessions_count = parseInt(row['metrics'][0]['values'][1]);
                    var hits_count = parseInt(row['metrics'][0]['values'][2]);
                    var conversion_count = parseInt(row['metrics'][0]['values'][2]);

                    // Map data per day for timeseries chart
                    if (typeof visitors_per_day[page_url] === typeof undefined) {
                        visitors_per_day[page_url] = {};
                    }
                    if (typeof visitors_per_day[page_url][date] === typeof undefined) {
                        visitors_per_day[page_url][date] = 0;
                    }

                    visitors_per_day[page_url][date] += visitor_count;

                    // Map data per url for table
                    if (typeof visitors_per_url[page_url] === typeof undefined) {
                        visitors_per_url[page_url] = {
                            url: page_url,
                            visitors: 0,
                            sessions: 0,
                            hits: 0,
                            conversions: 0
                        };
                    }

                    visitors_per_url[page_url].visitors += visitor_count;
                    visitors_per_url[page_url].sessions += sessions_count;
                    visitors_per_url[page_url].hits += hits_count;
                    visitors_per_url[page_url].conversions += conversion_count;
                });


                var changeTimeseries = function(page_url) {
                    var timeseries_data = [];
                    Object.keys(visitors_per_day[page_url]).forEach(function(x) {
                        var formatted_date = new Date([x.substr(0, 4), x.substr(4, 2), x.substr(6, 2)].join('-'));

                        timeseries_data.push({
                            date: formatted_date,
                            key: formatted_date,
                            views: visitors_per_day[page_url][x],
                            url_pattern: [x]
                        })
                    });

                    var visitor_chart = RB.rho.ui.buildTimeseries(timeseries_chart, timeseries_data, "Views", ["views"], undefined, false, 200)
                }


                // Add data to table
                Object.keys(visitors_per_url).forEach(function(page_url) {
                    var entry = visitors_per_url[page_url];

                    table_data['body'].push({
                        key: page_url,
                        users: entry.visitors,
                        sessions: entry.sessions,
                        hits: entry.hits,
                        conversions: entry.conversions
                    });
                });

                domains_table
                    .data(table_data)
                    .draw();

                changeTimeseries('/')

                d3.selectAll('.table_body_row')
                    .style('cursor', 'pointer')
                    .on('click', function(x) {
                        changeTimeseries(x.key);
                    });
            })
            .data({
                'period': '20daysago/today',
                'view_id': view_id
            })
            .unpersist(true)
            .trigger()
        }

        loadData(site_options[0].id)
    </script>
</body>

</html>
