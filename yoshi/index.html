{% autoescape None %}

<script data-require="d3@3.5.3" data-semver="3.5.3" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>
<script>

    var openWindows = function(href,pos,id) {
      return window.open(href,"_BLANK"+pos)
    }
    var closeWindows = function(windows) {
      windows.map(function(w){
        w.close()
      })
    }

    var run = function(domains){
        if (domains.length > 0){
            var domain = domains[0]
            console.log(domain['key'])
            var urls = Array.from(new Set(domain['values'].map(function(d){return d['url']})))
            var windows = urls.map(function(d,i) {
                console.log(d)
                return openWindows(d,i)
            }).filter(function(x){return x != null })

            window.focus()
            setTimeout(closeWindows, 26000, windows)

            var advertiser_id = domain['values'][0]['advertiser_id']

            d3.xhr("/create?advertiser="+ advertiser_id).post(JSON.stringify(domain))
            setTimeout(run ,40000, domains.slice(1))
        }
    }


    var dd = {{domains}}

    dd = dd.filter(function(d){
        return d['line_item_id'] != 0
    })
    dd = dd.filter(function(d){
        return d['url'] != 0
    })

    var domains = d3.nest().key(function(d){return d['domain']}).entries(dd)

    run(domains)

</script>
