{% autoescape None %}

<script data-require="d3@3.5.3" data-semver="3.5.3" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>
      <script type = "text/javascript" 
         src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<style>
.button {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
}
table {
    font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
    border-collapse: collapse;
    width: 100%;
}

table td, #customers th {
    border: 1px solid #ddd;
    padding: 8px;
}

table tr:nth-child(even){background-color: #f2f2f2;}

table tr:hover {background-color: #ddd;}

.failure {background-color: #FBC3C3;}

td {
    text-align: center; /* center checkbox horizontally */
    vertical-align: middle; /* center checkbox vertically */
}


table th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: #305496;
    color: white;
}
</style>


<div id="setup">
    <button id="Save">Save</button>
    <br>
    <button id="Add">add</button>

</div>



<script>

    var make_table_text = function(selection, columns, data){

        var table = selection.append('table').classed('table',true)
      
        thead = table.append('thead')

        thead.append('tr')
            .selectAll('th')
            .data(columns).enter()
            .append('th')
            .text(function(x){return x['name']});
                
            tbody = table.append('tbody')

            var trows = tbody
                .selectAll('tr')
                .data(data).enter()
                .append('tr')
          
          
            trows.selectAll('td')
                .data(function(row) {
                    return columns.map(function(c){
                  
                        var cell = {}
                        cell['name'] = c['name']
                        cell['value'] = row[c['name']]
                        cell['type'] = c['type']
                        cell['text'] = c['text']
                        cell['class'] = c['class']
                    
                    return cell 
                })
            })
            .enter()
            .append('td')
            .attr('class',function(x){
                return x['class']
            })
            .text(function(x){
                var k = x['text']!= null ? x['text'] : x['value']
                return k
            })

            trows.selectAll('td').append(function(d){
                return document.createElement(d['type'])
            })
        return table
    }
    var draw = function(wrapper, columns, data, line_items, media_plans){
        wrapper.selectAll("table").remove()
        var table = make_table_text(wrapper, columns, data)
        table.selectAll('td').selectAll('input').classed('input-small', true)
        table.selectAll('td').selectAll('textarea').property("value", function(x){
            return x['value']
        })

        var liSelector = table.selectAll('td.line_item_name').append('select')

        liSelector.selectAll('option').data(line_items)
            .enter()
            .append('option')
            .text(function(d){ return d })
            .property('value', function(d){return d})
            
        liSelector.on('change', function(x){
            d3.select(this.parentNode).selectAll('textarea').property("value", this.value)        
        })

        var mplanSelector = table.selectAll('td.mediaplan').append('select')

        mplanSelector.selectAll('option').data(media_plans)
            .enter()
            .append('option')
            .text(function(d){ return d })
            .property('value', function(d){return d})
            
        mplanSelector.on('change', function(x){
            d3.select(this.parentNode).selectAll('textarea').property("value", this.value)        
        })

    }
    var getQueryString = function ( field, url ) {
        var href = url ? url : window.location.href;
        var reg = new RegExp( '[?&]' + field + '=([^&#]*)', 'i' );
        var string = reg.exec(href);
        return string ? string[1] : null;
    };

    var columns = [
    {
        'name': 'line_item_name',
        'class' : 'line_item_name',
        'type': 'textarea',
        'text': ""
    },
    {
        'name': 'mediaplan',
        'class': 'mediaplan',
        'type': 'textarea',
        'text': ""
    },
    {
        'name': 'num_domains',
        'type': 'input'
    },
    {
        'name': 'active',
        'type': 'input'
    }]
  
    

    var data = {{data}}
    var wrapper = d3.select("#setup")
    var add = wrapper.select("#add")
    var save = wrapper.select("#save")

    var advertiser = getQueryString("advertiser", window.location.href)

    draw(wrapper, columns, data['setup'], data['line_items'], data['media_plans'])

    
    add.on("click", function(x){
        var new_item = {}
        for(i = 0; i < columns.length; i++){ 
            new_item[columns[i]['name']] = 0 
        } 
        data['setup'].push(new_item)
        draw(wrapper, columns, data['setup'], data['line_items'], data['media_plans'])
    })

    save.on("click", function(x){

        wrapper.selectAll("table").selectAll("tbody").selectAll("td").selectAll('input').each(function(d){
            this.parentNode.parentNode.__data__[d['name']] = this.value != "" ? this.value : this.parentNode.__data__['value'] 
        })
        
        wrapper.selectAll("table").selectAll("tbody").selectAll("td").selectAll('textarea').each(function(d){
            this.parentNode.parentNode.__data__[d['name']] = this.value != "" ? this.value : this.parentNode.__data__['value'] 
        })
        
        var new_data = wrapper.selectAll("table").selectAll("tbody").selectAll('tr')[0].map(function(d){
          return d.__data__
        })

        for (i = 0; i< new_data.length; i++){
            dd = new_data[i]
            if( data['line_items'].indexOf(dd['line_item_name']) <= -1 )   {
                alert('Invalid Line Item!')
            }
            else if( data['media_plans'].indexOf(dd['mediaplan']) <= -1 )   {
                alert('Invalid Media Plan!')
            }

            else{
                d3.xhr("/setup?advertiser="+ advertiser).post(JSON.stringify([dd]))
            }

        }




        debugger;

    })




    

</script>
