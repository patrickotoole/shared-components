{% autoescape None %}
<style>
.hidden { display:none }
.build-form .row { padding:1px; padding-left:5px; }
.form-description { padding-bottom: 20px }
.label { display:inline-block; width:175px; vertical-align:top }
.field { display:inline-block; width:200px; vertical-align:top }
.field select, .field input { width: 180px }
.description{ display:inline-block; width:500px; vertical-align:top }
.row span { min-width:250px; display:inline-block }
</style>
<script data-require="d3@3.5.3" data-semver="3.5.3" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>
<script src="js/forms/build/form_builder.js"></script>
<script src="js/state/build/state.js"></script>
<script src="js/table/build/table.js"></script>


<script>
var d3_updateable = function(target,selector,type,data,joiner) {
var type = type || "div"
var updateable = target.selectAll(selector).data(
function(x){return data ? [data] : [x]},
joiner || function(x){return [x]}
)
updateable.enter()
.append(type)
return updateable
}
var d3_splat = function(target,selector,type,data,joiner) {
var type = type || "div"
var updateable = target.selectAll(selector).data(
data || function(x){return x},
joiner || function(x){return x}
)
updateable.enter()
.append(type)
return updateable
}

</script>
<h3>Saved Optimizations</h3>
<div id="saved" style="width:800px">
  <!--{{saved_html}}-->
</div>

<script>
  var xx = {{saved}}

  xx.map(function(row) {
    row.link = "/optimize" + state.qs().to(JSON.parse(row.state))
  })

  var t = table.table(d3.select("#saved"))
    .headers(["name","advertiser_id","active"].map(function(x) { return {key: x, value: x} }))
    .render("advertiser_id",function(x) { 
      var dthis = d3.select(this)
        .text(this.parentNode.__data__[x.key])
    })
    .render("name",function(x) { 
      var dthis = d3.select(this)
        .append("a")
        .text(this.parentNode.__data__[x.key])
        .attr("href","/optimize" + state.qs().to(JSON.parse(this.parentNode.__data__["state"])))
    })
    .data({"values":xx})
    .draw()

  
  
</script>
<br>
<button onclick=" window.location.pathname = '/optimize' ">New Optimization</button>

<h3>Scheduled Optimizations</h3>
{{scheduled_html}}

<h3>Schedule a Saved Optimization</h3>
<div id="new"></div>
<script>
var fields = {{saved}}

fields.map(function(x) {
  x.value = x.id
  x.key = x.name + " - " + x.advertiser_id 
})

var form = {
  "description": null, "script": "build_python_marathon_app", "deleted": 0, "fields": [
      {"name":"optimization", "values": fields, "type":"select"}
    , {"name":"day", "values": "Mon,Tues,Wed,Thurs,Fri,Sat,Sun".split(","), "type":"multi_select"}
    , {"name":"time", "values": d3.range(24).map(function(x) { return x < 10 ? "0" + x : x }), "type":"multi_select"}
  ]
}

      form_builder.forms(d3.select("#new"))
        .fields([
          
        ])
        .data(form)
        .on("submit", function(_data) { 
          var d = _data.data.reduce(function(p,c) { p[c.key] = c.value; return p} , {})
          d3.xhr("/schedule").post(JSON.stringify(d))
        })
        .draw()
</script>




