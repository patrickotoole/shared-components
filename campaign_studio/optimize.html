
{% autoescape None %}
<head>
  <style>
    .hidden { display:none }
    .debug { display:none }
    .show-debug .debug { display:inherit }
  </style>
  <script>

    function d3_class(target,cls,type) {
      return d3_updateable(target,"." + cls, type || "div")
        .classed(cls,true)
    }

    function d3_select(target, data, key, is_selected) {
      var select = d3_updateable(target,"select","select")

      d3_splat(select,"option","option",data, key)
        .text(key)
        .property("selected",is_selected)

      return select

    }

    function showOptimization() {}

  </script>
  <script data-require="d3@3.5.3" data-semver="3.5.3" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>

  <script src="js/state/build/state.js"></script>
  <script src="js/filter/build/filter.js"></script>
  <script src="js/table/build/table.js"></script>

  <script src="/static/utils.js"></script>
  <script src="/static/custom_filter.js"></script>
  <script src="/static/custom_transform.js"></script>
  <script src="/static/optimize/build/optimize.js"></script>



  <script src="/static/create/build/campaign_analysis.js"></script>

  <script>

    var qs_state = state.qs().from(document.location.search)
    var _state = state.state(qs_state)

      
  </script>
  
</head>

<body class="show-debug" style="width:1200px;margin-left:auto;margin-right:auto">
  <h3 style="margin-bottom:0px">Optimize from Reporting</h3>

  <div id="extract-target"></div>

  <br> <hr> 
  <h4>Analyze</h4>
    
  <div class="row">Transform:</div>
  <div class="row">

    <div class="transform-row"> </div>
    <button id="new-transform">Add Transform</button>
    <script>


      var drawTransforms = function(tt) {

        d3.select("#new-transform").on("click",function() { 
          var p = JSON.parse(JSON.stringify(_state._state.transforms || []))
          
          var transforms = p

          if (transforms.filter(function(x) { return x.name == "" }).length == 0) {
            transforms.push({"name":"","eval":""})
          }

          _state.publish("transforms",transforms)
          return 
        })

        var trow = d3.selectAll(".transform-row").data([tt])

        var transform = d3_splat(trow,".transform","div",function(x) { return x }, function(x,i) { return x.name })
          .classed("transform",true)
          .style("margin-left","10px")

        transform.exit().remove()


        var name_wrap = d3_updateable(transform,".name-wrap","div")
          .classed("name-wrap",true)
          .style("display","inline-block")

        d3_updateable(name_wrap,"span","span").text("New Column Name:")
        d3_updateable(name_wrap,"input","input").attr("value",function(x){ return x.name })
          .attr("placeholder","e.g., CPM")
          .on("change",function(x) {
            //x.name = this.value // This is bad
            var _j = JSON.parse(JSON.stringify(tt))
            var matched = _j.filter(function(z) { return z.name == x.name })[0]

            matched.name = this.value

            _state.publish("transforms",_j)
          })

        var eval_wrap = d3_updateable(transform,".eval-wrap","div")
          .classed("eval-wrap",true)
          .style("display","inline-block")

        d3_updateable(eval_wrap,"span","span").text("Expression:")
        d3_updateable(eval_wrap,"input","input").attr("value",function(x){ return x.eval })
          .attr("placeholder","e.g., row['imps']/row['cost']")
          .on("change",function(x) {
         
            var _j = JSON.parse(JSON.stringify(tt))
            var matched = _j.filter(function(z) { return z.name == x.name })[0]

            matched.eval = this.value

            _state.publish("transforms",_j)
          })
        
      }


      
    </script>
  </div>

  </div>
  <br>

  <div class="row"> Filter: </div>
  <div class="row">

    <div class="filter-row"> </div>
    <script>

      function buildUIFilters(headers,data,ff) { 

        var ops = headers.map(function(x) {
          return [
              {"key": "equals"}
            , {"key":"does not contain"}
            , {"key":"does not equal"}
            , {"key": "between"}
            , {"key": "greater than"}
            , {"key": "less than"}
          ]
        })

        filter.filter(d3.selectAll(".filter-row"))
          .fields(headers)
          .ops(ops)
          .data(ff)
          .render_op("between",function(filter,value) {
            var self = this

            value.value = typeof(value.value) == "object" ? value.value : [0,24]

            d3_updateable(filter,"input.value.low","input")
              .classed("value low",true)
              .style("margin-bottom","10px")
              .style("padding-left","10px")
              .style("width","90px")
              .attr("value", value.value[0])
              .on("keyup", function(x){
                var t = this
              
                self.typewatch(function() {
                  value.value[0] = parseFloat(t.value)
                  //value.fn = self.buildOp(value)
                  self.on("update")(self.data())
                },1000)
              })

            d3_updateable(filter,"span.value-and","span")
              .classed("value-and",true)
              .text(" and ")

            d3_updateable(filter,"input.value.high","input")
              .classed("value high",true)
              .style("margin-bottom","10px")
              .style("padding-left","10px")
              .style("width","90px")
              .attr("value", value.value[1])
              .on("keyup", function(x){
                var t = this
              
                self.typewatch(function() {
                  value.value[1] = parseFloat(t.value)
                  //value.fn = self.buildOp(value)
                  self.on("update")(self.data())
                },1000)
              })


          })
          .on("update",function(x) {
            var filters = x.map(function(z) {
              return { 
                  "field": z.field
                , "op": z.op
                , "value": z.value
              }
            }).filter(function(x) { return x.value !== undefined } )
  
            var filtered_data = buildModifiedFilter(data,filters)
  
            if (filters.length == x.length) {
              _state.publish("filters",filters)
              _state.publishStatic("filtered_data",filtered_data)
            }
  
            d3.select(".summary").html("Total rows: " + data.length + "<br>" + " Rows remaining after filter: " + filtered_data.length + "<br><br>")
  
            if (filtered_data.length == 0) d3.selectAll(".outer-table-wrapper").html("")
  
          })
          .draw()

      }
    </script>
  </div>

  <br> <hr> <br>
  

  <div class="row"> Summary: </div>
  <div class="summary"></div>

  <div class="row"> Results: </div>

  <div style="height:250px;overflow:scroll;position:relative" class="outer-table-wrapper"></div>
  <script>
    function buildTable(data) {
      
      var tt = d3.selectAll(".outer-table-wrapper")


      table.table(tt)
        .data({"key":"Data","values":data}) 
        .render("ctr",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(d3.format(".3%")(t)) })
        .render("placement_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("venue_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("campaign_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("line_item_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("pixel_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("user_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("auction_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("publisher_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("sellers",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .draw()

    }
  </script>

  <br><hr>

  <div class="setup" style="display:inline-block">

    <h4>Setup</h4>


    <div class="row">
      <div style="width:300px;display:inline-block">Advertiser ID: </div>
      <select id='advertiser' style="width:200px"></select> 
    </div>

    <div class="row">
      <div style="display:inline-block;width:300px">Optimization Type: </div>
      <div style="display:inline-block;width:250px">
        <select id="duplicate" >
          <option value="" disabled selected>Select your optimization</option>
          <option>Duplicate (profile includes)</option>
          <option>Replace</option>
          <option>Modify (profile excludes)</option>
          <option>Deactivate</option>
          <option disabled=disabled>Create</option>
        </select>
        <script>
          d3.select("#duplicate").on("change",function() {
            var value = this.selectedOptions[0].value.toLowerCase().split(" ")[0]

            var options = d3.selectAll(".setup .row.optional").classed("hidden",true)
            d3.selectAll(".setup .optional.row." + value).classed("hidden",false)
          })
        </script>
      </div>
    </div>

    

    

    <div class="row create hidden optional">
      <div style="width:250px;display:inline-block">Template Campaign (if create): </div>
      <input id="template_campaign" style="width:200px"></input> 
    </div>

    <div class="row duplicate replace hidden optional">
      <div style="width:300px;display:inline-block">Line Item ID (if not modify): </div>
      <input id="line_item_id" style="width:200px"></input> 
    </div>

    <div class="row duplicate replace modify hidden optional">
      <div style="display:inline-block;width:300px">Group or Breakout: </div>
      <div style="display:inline-block;width:250px">
        <select id="breakout" >
          <option>Group</option>
          <option>Breakout</option>
        </select>
      </div>
    </div>

    <div class="row create hidden optional">
      <div style="width:250px;display:inline-block">Group by (if create):</div>
      <input id="create_group" style="width:200px"></input> 
    </div>


    <div class="row duplicate replace modify hidden optional">
      <div style="display:inline-block;width:300px">Override or Append fields: </div>
      <div style="display:inline-block;width:250px">
        <select id="append" >
          <option>Override</option>
          <option>Append</option>
        </select>
      </div>
    </div>

    <br>
    <a id="show-override" href="#overrides">Show Overrides (+)</a>
    <script>
      d3.select("#show-override").on("click",function() {
        var or = d3.selectAll(".overrides")
        d3.select("#show-override").text(!or.classed("hidden") ? "Show Overrides (+)" : "Hide Overrides (-)")
        or.classed("hidden",!or.classed("hidden"))
        
      })
    </script>

    <div id="overrides" class="row overrides hidden">

      <br>

      <div style="width:250px;display:inline-block">Imp Budget Override:</div>
      <input id="imp_budget" style="width:200px"></input> 
      <div style="width:250px;display:inline-block">Spend Budget Override:</div>
      <input id="spend_budget" style="width:200px"></input> 
      <br>

      <div style="width:250px;display:inline-block">Imp Bid Override:</div>
      <input id="imp_bid" style="width:200px"></input> 
      <div style="width:250px;display:inline-block">Spend Bid Override:</div>
      <input id="spend_bid" style="width:200px"></input> 
      <br>
      <div style="width:250px;display:inline-block">Imp Lifetime Budget Override:</div>
      <input id="lifetime_imp_budget" style="width:200px"></input> 
      <div style="width:250px;display:inline-block">Spend Lifetime Budget Override:</div>
      <input id="lifetime_spend_budget" style="width:200px"></input> 



    </div>
  </div>



  <br><br>
  <hr>



  <div style="text-align:center" class="build">
    <input id="name"></input>
    <button id="save" >Save State</button>
    <button id="create" >Create Campaigns</button>
    <br><br>
    <pre style="text-align:left;margin:auto;width:600px" id="obj"></pre>
    <script>

    var buildSummary = function() {
      var summary = []
      summary.push({"key":"append","value":d3.select("#append").node().selectedOptions[0].value })
      summary.push({"key":"opt_type","value":d3.select("#duplicate").node().selectedOptions[0].value.split(" ")[0] })
      summary.push({"key":"breakout","value":d3.select("#breakout").node().selectedOptions[0].value })

      summary.push({"key":"line_item_id","value":d3.select("#line_item_id").node().value})
      summary.push({"key":"template_campaign","value":d3.select("#template_campaign").node().value})
      summary.push({"key":"create_group","value":d3.select("#create_group").node().value})


      summary.push({"key":"advertiser","value":d3.select("#advertiser").node().value})
      summary.push({"key":"report_advertiser","value":d3.select("#report_advertiser").node().value})
      summary.push({"key":"sql_advertiser","value":d3.select("#sql_advertiser").node().value})

      summary.push({"key":"imp_budget","value":d3.select("#imp_budget").node().value})
      summary.push({"key":"spend_budget","value":d3.select("#spend_budget").node().value})

      return summary
    }

    function getReportJSON() {
      try { 
        return JSON.parse(d3.select("#report").node().value).report
      } catch(e) {
        return undefined
      }
    }

      d3.select("#save").on("click",function(x){

        var summary = buildSummary()

        var advertiser = summary.filter(function(x) { return x.key == "advertiser" })[0].value

        var data = {
          "name": d3.select("#name").node().value,
          "advertiser":advertiser,
          "type": "optimization",
          "report": getReportJSON(),
          "sql": d3.select("#sql").node().value,
          "settings": summary,
          "transforms": _state._state.transforms,
          "filters": _state._state.filters
        }

        d3.select("#obj").text(JSON.stringify(data,null,2))

        d3.xhr("/save")
          .post( JSON.stringify(data) )

      })

      d3.select("#create").on("click",function(x){
        var summary = buildSummary()

        var dd = _state._state.filtered_data


        var data = {
          "name": d3.select("#name").node().value,
          "data": dd,
          "params": summary
        }

        d3.xhr("/optimize")
          .post( JSON.stringify(data) )
      })
    </script>
    </br>
  </div>




  <script>
    
    var advertisers = {{advertisers}},
      templates = {{campaign_templates}},
      profile_templates = {{profile_templates}};

    var a2 = advertisers.map(function(x) { return {key: x.pixel_source_name, value: x.external_advertiser_id} })

    _state.publishStatic("advertisers", a2)

    var select_advertiser = d3.selectAll("#advertiser").data([advertisers])
    select_advertiser.selectAll("option").data(function(x) { return x } )
      .enter()
        .append("option")
        .text(function(x) { return x.pixel_source_name })
        .attr("value",function(x){ return x.external_advertiser_id })

    var select_advertiser = d3.selectAll("#report_advertiser").data([advertisers])
    select_advertiser.selectAll("option").data(function(x) { return x } )
      .enter()
        .append("option")
        .text(function(x) { return x.pixel_source_name })
        .attr("value",function(x){ return x.external_advertiser_id })

    var select_advertiser = d3.selectAll("#sql_advertiser").data([advertisers])
    select_advertiser.selectAll("option").data(function(x) { return x } )
      .enter()
        .append("option")
        .text(function(x) { return x.pixel_source_name })
        .attr("value",function(x){ return x.external_advertiser_id })

    showOptimization()

    _state
      .subscribe("extract",function(err,values) {

        optimize.extract(d3.select("#extract-target"))
          .data(values)
          .on("select",function(selected_option){
            _state.publish("extract_type",selected_option.value)
          })
          .on("upload",function(result){
            var process = campaign_analysis.parse(result)
     
            var headers = process.headers()
            var data = process.data()
     
            _state.publishStatic("headers",headers)
            _state.publishStatic("data",data)
     
          })
          .on("sql",function(values) {
            
            if (!values.sql) return false;
    
            d3.xhr("/run-sql")
              .post( JSON.stringify(values), function(err, data){
                var jj = JSON.parse(data.response)

                _state.publishStatic("headers",Object.keys(jj[0]))
                _state.publishStatic("data",jj)
                
              })

          })
          .on("report",function(v) {
            try {
              var values = JSON.parse(v.report)
            } catch(e) { return }

            values['report_advertiser'] = v.report_advertiser

            _state.publish("report",JSON.parse(v.report))

            var settings = JSON.parse(JSON.stringify(_state._state.settings || []))
              .filter(function(x) { return x.key !== "report_advertiser" })

            settings
              .push({"key":"report_advertiser","value":v.report_advertiser})


            _state.publish("settings",settings)
    
            d3.xhr("/reporting")
              .post( JSON.stringify(values), function(err, data){
                var jj = JSON.parse(data.response)
    
                _state.publishStatic("headers",Object.keys(jj[0]))
                _state.publishStatic("data",jj)

              })
          })
          .draw()

      })
      .subscribe("sql",function(err,values) {
        var sql = values.sql;
        //d3.select("#sql").text(sql)
        //if (sql) showOptimization("sql")
      })
      .subscribe("report",function(err,values) {
        var report = values.report
        //d3.select("#report").text(JSON.stringify({"report":report,"report_advertiser":d3.select("#report_advertiser").node().value},null,2))
        //if (report) showOptimization("report")
      })
      .subscribe("transforms",function(err,values) {
        var transforms = values.transforms

        drawTransforms(transforms || [])
        if (transforms) runTransforms(transforms,values, function(values) {
          _state.setStatic("headers",Object.keys(values.data[0]))
          _state.publishStatic("data",values.data)
        })
      })
      .subscribe("filters",function(err,values) {
        var filters = values.filters
      })
      .subscribe("settings", function(err,values) {
        var settings = values.settings || []

        settings.map(function(row) {
          var selected = d3.selectAll("#" + row.key)
          if (selected.size() == 0) return

          if (selected.node().type == "select-one")
            return selected.selectAll("option").property("selected",function(x) { return this.value == row.value ? "selected" : undefined})

          if (selected.node().type == "text") return selected.property("value", row.value)
          
          if (selected.node().tagName == "DIV") {
            return selected.selectAll("input")
              .filter(function(x) { return x == row.value})
              .property("checked",function(x) { return x == row.value ? "checked" : undefined})
          }
          
        })
      })
      .subscribe("new_data.data", function(err,data,values) {
        _state.publishStatic("filtered_data",data)
      })
      .subscribe("data.filtered_data", function(err,data,values) {
        var headers = values.headers;

        buildUIFilters(headers, values.data, values.filters || [])
        buildTable(data)

      })

    _state.publish(qs_state)
    //d3.select("#sql-action").on("click")()

  </script>
</body>
