
{% autoescape None %}
<head>
  <style>
    .hidden { display:none }
    .debug { display:none }
    .show-debug .debug { display:inherit }
  </style>
  <script>

    function d3_class(target,cls,type) {
      return d3_updateable(target,"." + cls, type || "div")
        .classed(cls,true)
    }

    function d3_select(target, data, key, is_selected) {
      var select = d3_updateable(target,"select","select")

      d3_splat(select,"option","option",data, key)
        .text(key)
        .property("selected",is_selected)

      return select
    }



  </script>
  <script data-require="d3@3.5.3" data-semver="3.5.3" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>

  <script src="js/state/build/state.js"></script>
  <script src="js/filter/build/filter.js"></script>
  <script src="js/table/build/table.js"></script>

  <script src="/static/utils.js"></script>
  <script src="/static/custom_filter.js"></script>
  <script src="/static/custom_transform.js"></script>
  <script src="/static/optimize/build/optimize.js"></script>



  <script src="/static/create/build/campaign_analysis.js"></script>

  <script>

    var qs_state = state.qs().from(document.location.search)
    qs_state.settings = qs_state.settings || []
    var _state = state.state(qs_state)

      
  </script>
  
</head>

<body class="show-debug" style="width:1200px;margin-left:auto;margin-right:auto">

  <h3 style="margin-bottom:0px">Optimize from Reporting</h3>
  <div id="extract-target"></div>

  <div class="divider"> <br><hr> </div>
  <div class="row transform-row"> </div>

  <div class="divider"> <br><hr> </div>
  <div class="row filter-row"></div>

  <div class="divider"> <br><hr> </div>
  <div class="row summary"></div>

  <div class="row results">
    <h4>Results: </h4>
    <div style="height:250px;overflow:scroll;position:relative" class="outer-table-wrapper"></div>
  </div>

  <br><hr>

  <div class="row setup"></div>

  <br><br>
  <hr>

  <div class="row save"></div>


  <script>
    
    var advertisers = {{advertisers}},
      templates = {{campaign_templates}},
      profile_templates = {{profile_templates}};

    var a2 = advertisers.map(function(x) { return {key: x.pixel_source_name, value: x.external_advertiser_id} })


var formatAsText = function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) }
var formatAsPercent = function(x) {var dthis = d3.select(this);var t = this.parentNode.__data__[x.key];return dthis.text(d3.format(".3%")(t))}


    _state.publishStatic("advertisers", a2)



    _state
      .subscribe("extract",function(err,values) {

        optimize.extract(d3.select("#extract-target"))
          .data(values)
          .on("select.sql_advertiser",function(v){
            var settings = JSON.parse(JSON.stringify(_state._state.settings || []))
              .filter(function(x) { return x.key !== "sql_advertiser" })

            settings
              .push({"key":"sql_advertiser","value":v.value})

            _state.publish("settings",settings)


          })

          .on("select",function(selected_option){
            _state.publish("extract_type",selected_option.value)
          })
          .on("upload",function(result){
            var process = campaign_analysis.parse(result)
     
            var headers = process.headers()
            var data = process.data()
     
            _state.publishStatic("headers",headers)
            _state.publishStatic("data",data)
     
          })
          .on("sql",function(values) {
            
            if (!values.sql) return false;
    
            d3.xhr("/run-sql")
              .post( JSON.stringify(values), function(err, data){
                var jj = JSON.parse(data.response)

                _state.publishStatic("headers",jj.length ? Object.keys(jj[0]) : [])
                _state.publishStatic("data",jj)
                
              })

          })
          .on("report",function(v) {
            try {
              var values = JSON.parse(v.report)
            } catch(e) { return }

            values['report_advertiser'] = v.report_advertiser

            _state.publish("report",JSON.parse(v.report))

            var settings = JSON.parse(JSON.stringify(_state._state.settings || []))
              .filter(function(x) { return x.key !== "report_advertiser" })

            settings
              .push({"key":"report_advertiser","value":v.report_advertiser})


            _state.publish("settings",settings)
    
            d3.xhr("/reporting")
              .post( JSON.stringify(values), function(err, data){
                var jj = JSON.parse(data.response)
    
                _state.publishStatic("headers",Object.keys(jj[0]))
                _state.publishStatic("data",jj)

              })
          })
          .draw()

      })
      .subscribe("transforms",function(err,values) {
        var transforms = values.transforms

        optimize.transform(d3.selectAll(".transform-row"))
          .data(transforms || [])
          .on("change",function(values) {
            _state.publish("transforms",values)
          })
          .on("new",function() {
            var transforms = JSON.parse(JSON.stringify(_state._state.transforms || []))
            
            if (transforms.filter(function(x) { return x.name == "" }).length == 0) {
              transforms.push({"name":"","eval":""})
            }

            _state.publish("transforms",transforms)
            return 
          })
          .draw()

        if (transforms) runTransforms(transforms,values, function(values) {
          _state.setStatic("headers",Object.keys(values.data[0]))
          _state.publishStatic("data",values.data)
        })
      })
      .subscribe("filters",function(err,values) {
        var filters = values.filters
      })
      .subscribe("settings", function(err,values) {
        var settings = values.settings || []

        settings.map(function(row) {
          var selected = d3.selectAll("#" + row.key)
          if (selected.size() == 0) return

          if (selected.node().type == "select-one")
            return selected.selectAll("option").property("selected",function(x) { return this.value == row.value ? "selected" : undefined})

          if (selected.node().type == "text") return selected.property("value", row.value)
          
          if (selected.node().tagName == "DIV") {
            return selected.selectAll("input")
              .filter(function(x) { return x == row.value})
              .property("checked",function(x) { return x == row.value ? "checked" : undefined})
          }
          
        })

        optimize.setup(d3.select(".setup"))
          .data(values)
          .on("update",function(x) {
            var settings = JSON.parse(JSON.stringify(_state._state.settings))

            settings = settings.map(y => {
              if (x.key == y.key) return x
              return y
            })

            _state.publish("settings",settings)
          })
          .on("advertiser",function(x) {
            var settings = JSON.parse(JSON.stringify(_state._state.settings))

            settings.map(y => {
              if (y.key == "advertiser") y.value = x.value
            })

            _state.publish("settings",settings)
            _state.publish("advertiser",x.value)
          })
          .on("opt_type",function(x) {
            var settings = JSON.parse(JSON.stringify(_state._state.settings))

            settings.map(y => {
              if (y.key == "opt_type") y.value = x.value
            })

            _state.publish("settings",settings)
          })
          .draw()

        optimize.save(d3.select(".row.save"))
          .on("update",function(x){ 
            _state.publish("name",x)
            return 
          })
          .on("save",function(){ 

            var data = {
              "name": _state._state.name,
              "advertiser": _state._state.advertiser,
              "type": _state._state.type || "optimization",
              "report": _state._state.report,
              "sql": _state._state.sql,
              "settings": _state._state.settings,
              "transforms": _state._state.transforms,
              "filters": _state._state.filters
            }

            d3.xhr("/save")
              .post( JSON.stringify(data) )


            return 
          })
          .on("run",function(){ 
            return 
          })


          .draw()
      })
      .subscribe("new_data.data", function(err,data,values) {
        _state.publishStatic("filtered_data",data)
      })
      .subscribe("data.filtered_data", function(err,data,values) {

        var headers = values.headers
          , data = values.data
          , ff = values.filters || []


        var ops = headers.map(function(x) {
          return [
              {"key": "equals"}
            , {"key":"does not contain"}
            , {"key":"does not equal"}
            , {"key": "between"}
            , {"key": "greater than"}
            , {"key": "less than"}
          ]
        })

        d3_updateable(d3.selectAll(".filter-row"),"h4","h4",1).text("Filter")

        filter.filter(d3.selectAll(".filter-row"))
          .fields(headers)
          .ops(ops)
          .data(ff)
          .render_op("between",function(filter,value) {
            var self = this

            value.value = typeof(value.value) == "object" ? value.value : [0,24]

            d3_updateable(filter,"input.value.low","input")
              .classed("value low",true)
              .style("margin-bottom","10px")
              .style("padding-left","10px")
              .style("width","90px")
              .attr("value", value.value[0])
              .on("keyup", function(x){
                var t = this
              
                self.typewatch(function() {
                  value.value[0] = parseFloat(t.value)
                  self.on("update")(self.data())
                },1000)
              })

            d3_updateable(filter,"span.value-and","span")
              .classed("value-and",true)
              .text(" and ")

            d3_updateable(filter,"input.value.high","input")
              .classed("value high",true)
              .style("margin-bottom","10px")
              .style("padding-left","10px")
              .style("width","90px")
              .attr("value", value.value[1])
              .on("keyup", function(x){
                var t = this
              
                self.typewatch(function() {
                  value.value[1] = parseFloat(t.value)
                  self.on("update")(self.data())
                },1000)
              })


          })
          .on("update",function(x) {
            var filters = x.map(function(z) {
              return { 
                  "field": z.field
                , "op": z.op
                , "value": z.value
              }
            }).filter(function(x) { return x.value !== undefined } )
  
            var filtered_data = buildModifiedFilter(data,filters)
  
            if (filters.length == x.length) {
              _state.publish("filters",filters)
              _state.publishStatic("filtered_data",filtered_data)
            }
  
  
            if (filtered_data.length == 0) d3.selectAll(".outer-table-wrapper").html("")
  
          })
          .draw()


        var tt = d3.selectAll(".outer-table-wrapper")


        table.table(tt)
          .data({"key":"Data","values":data}) 
          .render("ctr",formatAsPercent)
          .render("placement_id",formatAsText)
          .render("venue_id",formatAsText)
          .render("campaign_id",formatAsText)
          .render("line_item_id",formatAsText)
          .render("pixel_id",formatAsText)
          .render("user_id",formatAsText)
          .render("auction_id",formatAsText)
          .render("id",formatAsText)
          .render("publisher_id",formatAsText)
          .render("sellers",formatAsText)
          .draw()



      })

    _state.publish(qs_state)

  </script>
</body>
