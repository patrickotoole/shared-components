
{% autoescape None %}
<head>
  <style>
    .hidden { display:none }
    .debug { display:none }
    .show-debug .debug { display:inherit }
  </style>
  <script data-require="d3@3.5.3" data-semver="3.5.3" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>

  <script src="js/state/build/state.js"></script>
  <script src="js/filter/build/filter.js"></script>
  <script src="js/table/build/table.js"></script>

  <script src="/static/utils.js"></script>
  <script src="/static/custom_filter.js"></script>

  <script>
    var qs_state = state.qs().from(document.location.search)
    var _state = state.state(qs_state)
      .subscribe("sql",function(err,values) {
        var sql = values.sql;

        d3.select("#sql").text(sql)
        if (sql) showOptimization("sql")
      })
      .subscribe("report",function(err,values) {
        var report = values.report

        d3.select("#report").text(JSON.stringify({"report":report,"report_advertiser":d3.select("#report_advertiser").node().value},null,2))
        if (report) showOptimization("report")
      })
      .subscribe("transforms",function(err,values) {
        var transforms = values.transforms
      })
      .subscribe("filters",function(err,values) {
        var filters = values.filters
      })
      .subscribe("settings", function(err,values) {
        var settings = values.settings

        settings.map(function(row) {
          var selected = d3.selectAll("#" + row.key)
          if (selected.size() == 0) return

          if (selected.node().type == "select-one")
            return selected.selectAll("option").property("selected",function(x) { return this.value == row.value ? "selected" : undefined})

          if (selected.node().type == "text") return selected.property("value", row.value)
          
          if (selected.node().tagName == "DIV") {
            return selected.selectAll("input")
              .filter(function(x) { return x == row.value})
              .property("checked",function(x) { return x == row.value ? "checked" : undefined})
          }
          
        })
      })
      .subscribe("data.data", function(err,data,values) {
        var headers = values.headers;

        runBuild(data, headers)

      })
    setTimeout(function() {
      _state.publish(qs_state)

      d3.select("#sql-action").on("click")()
    },10)

      
  </script>
  
</head>

<body class="show-debug" style="width:1200px;margin-left:auto;margin-right:auto">
  <h3 style="margin-bottom:0px">Optimize from Reporting</h3>
  <h4>Load Save</h4>
  <div>

    <div class="row debug"> Load saved state: 
      <textarea style="width:300px; height:20px" id="preload"></textarea> 
      <button id="preload-action">Load</button>
    </div>
    <script>

        
        d3.select("#preload").text(JSON.stringify(qs_state))


        d3.select("#preload-action").on("click",function(){
          var values = JSON.parse(d3.select("#preload").node().value)

          var filters = values.filters
            , settings = values.settings
            , report = values.report
            , sql = values.sql;

          if (report) {

            d3.xhr("/reporting")
              .post(d3.select("#report").node().value, function(err, data){
                var jj = JSON.parse(data.response)
                runBuild(jj,Object.keys(jj[0]))

                if (filters.length && window.data_filter) {
                  window.data_filter
                    .data(filters)
                    .draw()

                  window.data_filter
                    .on("update")(filters)
                }
              })
            
          } else {
            if (filters.length && window.data_filter) {
              window.data_filter
                .data(filters)
                .draw()

              window.data_filter
                .on("update")(filters)
            }

          }
          
        })
      </script>
    </div>
    <br><hr>
    <h4>Extract Data</h4>


    <div class="row"> 

      Select Data Source: <select id="show-type">
        <option>CSV</option>
        <option>Report</option>
        <option>SQL</option>
      </select>

      <script>

        function showOptimization(selected) {

          var show_type = d3.select("#show-type")

          show_type
            .selectAll("option").filter(function() { return this.value.toLowerCase() == selected })
            .property("selected","selected")

          show_type.on("change",function(x) {
            var selected = this.selectedOptions[0].value.toLowerCase()
            showOptimization(selected)
          })

          var showable = d3.selectAll("#show-display")

          showable
            .selectAll(".showable").classed("hidden",true)

          showable
            .selectAll("." + selected).classed("hidden",false)
        }

        

      </script>

      <div id="show-display">
        <div class="showable csv hidden">
          Upload a file: <input id="upload" type="file" /> 
        </div>
        <div class="showable report hidden">
          <span style="display:inline-block">
            <span style="width:100px;display:inline-block"></span>
            <span style="width:200px;display:inline-block">Use Appnexus Report:</span> 
            <textarea id="report" type="file" style="width:200px"></textarea> 
            <br>
            <span style="width:100px;display:inline-block"></span>
            <span style="width:200px;display:inline-block">Report Advertiser ID:</span>
            <select id='report_advertiser'></select>
          </span>


          <button id="report-action">Get</button>
          <script>
            d3.select("#report-action").on("click",function(){
                var values = JSON.parse(d3.select("#report").node().value)
                values['report_advertiser'] = d3.select("#report_advertiser").node().value
      
                d3.xhr("/reporting")
                  .post( JSON.stringify(values), function(err, data){
                    var jj = JSON.parse(data.response)
      
                    runBuild(jj,Object.keys(jj[0]))
                  } )
              })
          </script>
        </div>

        <div class="showable sql hidden">
          Enter SQL: <textarea id="sql" style="width:200px"></textarea>
          <br>
          Choose Advertiser: <select id='sql_advertiser'></select>

          <button id="sql-action">Get</button>
          <script>
            d3.select("#sql-action").on("click",function(){
                var values = {"sql":d3.select("#sql").node().value}
                values['sql_advertiser'] = d3.select("#sql_advertiser").node().value

      
                d3.xhr("/run-sql")
                  .post( JSON.stringify(values), function(err, data){
                    var jj = JSON.parse(data.response)

                    _state.publishStatic("headers",Object.keys(jj[0]))
                    _state.publishStatic("data",jj)

                    
                  })
              })
          </script>
        </div>
      </div>
    </div>

  <br> <hr> 

  <h4>Analyze</h4>
    
  <div class="row"> Transform: </div>

  <div class="row">

    <div class="transform-row"> </div>
    <button id="new-transform">Add Transform</button>
    <script>

      var drawTransforms = function(tt) {

        var transform = d3_splat(d3.selectAll(".transform-row"),".transform","div",tt,function(x) { return x.name })
          .classed("transform",true)
          .style("margin-left","10px")

        transform.exit().remove()


        var name_wrap = d3_updateable(transform,".name-wrap","div")
          .classed("name-wrap",true)
          .style("display","inline-block")

        d3_updateable(name_wrap,"span","span").text("New Column Name:")
        d3_updateable(name_wrap,"input","input").text(function(x){ return x.name })
          .attr("placeholder","e.g., CPM")
          .on("change",function(x) {
            x.name = this.value
          })

        var eval_wrap = d3_updateable(transform,".eval-wrap","div")
          .classed("eval-wrap",true)
          .style("display","inline-block")

        d3_updateable(eval_wrap,"span","span").text("Expression:")
        d3_updateable(eval_wrap,"input","input").text(function(x){ return x.eval })
          .attr("placeholder","e.g., row['imps']/row['cost']")
        
      }

      var transforms = []

      d3.select("#new-transform").on("click",function() { 
        if (transforms.filter(function(x) { return x.name == "" }).length == 0) {
          transforms.push({"name":"","eval":""})
        }
        console.log(transforms.length, transforms)
        drawTransforms(transforms)
        return 
      })
    </script>
  </div>

  </div>
  <br>


  <div class="row"> Filter: </div>

  <div class="row">

    <div class="filter-row"> </div>
    <script>

      function buildUIFilters(headers) { 

        var ops = headers.map(function(x) {
          return [
              {"key": "equals"}
            , {"key":"does not contain"}
            , {"key":"does not equal"}
            , {"key": "between"}
            , {"key": "greater than"}
            , {"key": "less than"}
          ]
        })

        window.data_filter = filter.filter(d3.selectAll(".filter-row"))
          .fields(headers)
          .ops(ops)
          .data([])
          .render_op("between",function(filter,value) {
            var self = this

            value.value = typeof(value.value) == "object" ? value.value : [0,24]

            d3_updateable(filter,"input.value.low","input")
              .classed("value low",true)
              .style("margin-bottom","10px")
              .style("padding-left","10px")
              .style("width","90px")
              .attr("value", value.value[0])
              .on("keyup", function(x){
                var t = this
              
                self.typewatch(function() {
                  value.value[0] = parseFloat(t.value)
                  //value.fn = self.buildOp(value)
                  self.on("update")(self.data())
                },1000)
              })

            d3_updateable(filter,"span.value-and","span")
              .classed("value-and",true)
              .text(" and ")

            d3_updateable(filter,"input.value.high","input")
              .classed("value high",true)
              .style("margin-bottom","10px")
              .style("padding-left","10px")
              .style("width","90px")
              .attr("value", value.value[1])
              .on("keyup", function(x){
                var t = this
              
                self.typewatch(function() {
                  value.value[1] = parseFloat(t.value)
                  //value.fn = self.buildOp(value)
                  self.on("update")(self.data())
                },1000)
              })
              d3.select(".summary").text(window.data_filter.length)


          })
          .draw()

        return window.data_filter

      }
    </script>
  </div>

  <br> <hr> <br>
  

  <div class="row"> Summary: </div>
  <div class="summary"></div>

  <div class="row"> Results: </div>

  <div style="height:250px;overflow:scroll;position:relative" class="outer-table-wrapper"></div>

  <br><hr>

  <div class="setup" style="display:inline-block">

    <h4>Setup</h4>


    <div class="row">
      <div style="width:300px;display:inline-block">Advertiser ID: </div>
      <select id='advertiser' style="width:200px"></select> 
    </div>
    <div class="row">
      <div style="width:300px;display:inline-block">Line Item ID (if not modify): </div>
      <input id="line_item_id" style="width:200px"></input> 
    </div>



    <div>
      <div style="display:inline-block;width:300px">Duplicate/replace/modify/create: </div>
      <div style="display:inline-block;width:250px">
        <select id="duplicate" >
          <option>Duplicate</option>
          <option>Replace</option>
          <option>Modify</option>
          <option>Deactivate</option>
          <option disabled=disabled>Create</option>
        </select>
      </div>

      <div style="width:250px;display:inline-block">Template Campaign (if create): </div>
      <input id="template_campaign" style="width:200px"></input> 
    </div>

    <div>
      <div style="display:inline-block;width:300px">Group or Breakout: </div>
      <div style="display:inline-block;width:250px">
        <select id="breakout" >
          <option>Group</option>
          <option>Breakout</option>
        </select>
      </div>

      <div style="width:250px;display:inline-block">Group by (if create):</div>
      <input id="create_group" style="width:200px"></input> 
    </div>


    <div>
      <div style="display:inline-block;width:300px">Override or Append fields: </div>
      <div style="display:inline-block;width:250px">
        <select id="append" >
          <option>Override</option>
          <option>Append</option>
        </select>
      </div>

      <div style="width:250px;display:inline-block">Imp Budget Override:</div>
      <input id="imp_budget" style="width:200px"></input> 

      <div style="width:300px;height:15px;display:inline-block"></div>
      <div style="width:250px;height:15px;display:inline-block"></div>

      <div style="width:250px;display:inline-block">Spend Budget Override:</div>
      <input id="spend_budget" style="width:200px"></input> 


    </div>


    <br>

    <div>
      Fields to add: 
      <div id='template-fields'></div>

      <script src="/static/create/build/campaign_analysis.js"></script>
      <script>


      </script>
    </div>
    <br>


  </div>



  <br><br>
  <hr>



  <div style="text-align:center" class="build">
    <input id="name"></input>
    <button id="save" >Save State</button>
    <button id="create" >Create Campaigns</button>
    <br><br>
    <pre style="text-align:left;margin:auto;width:600px" id="obj"></pre>
    <script>

    var buildSummary = function() {
        var summary = template_fields.summarize()
        summary.push({"key":"append","value":d3.select("#append").node().selectedOptions[0].value })
        summary.push({"key":"duplicate","value":d3.select("#duplicate").node().selectedOptions[0].value })
        summary.push({"key":"breakout","value":d3.select("#breakout").node().selectedOptions[0].value })

        summary.push({"key":"line_item_id","value":d3.select("#line_item_id").node().value})
        summary.push({"key":"template_campaign","value":d3.select("#template_campaign").node().value})
        summary.push({"key":"create_group","value":d3.select("#create_group").node().value})


        summary.push({"key":"advertiser","value":d3.select("#advertiser").node().value})
        summary.push({"key":"report_advertiser","value":d3.select("#report_advertiser").node().value})
        summary.push({"key":"sql_advertiser","value":d3.select("#sql_advertiser").node().value})

        summary.push({"key":"imp_budget","value":d3.select("#imp_budget").node().value})
        summary.push({"key":"spend_budget","value":d3.select("#spend_budget").node().value})




        return summary

    }

    function getReportJSON() {
      try { 
        return JSON.parse(d3.select("#report").node().value).report
      } catch(e) {
        return undefined
      }
    }

    d3.select("#save").on("click",function(x){

        var summary = buildSummary()

        var advertiser = summary.filter(function(x) { return x.key == "advertiser" })[0].value

        var data = {
          "name": d3.select("#name").node().value,
          "advertiser":advertiser,
          "type": "optimization",
          "report": getReportJSON(),
          "sql": d3.select("#sql").node().value,
          "settings": summary,
          "filters": window.data_filter.data()
        }

        d3.select("#obj").text(JSON.stringify(data,null,2))

        d3.xhr("/save")
          .post( JSON.stringify(data) )

      })

      d3.select("#create").on("click",function(x){
        var summary = buildSummary()

        var dd = window.filtered_data


        var data = {
          "data": dd,
          "params": summary
          //"fields": fields.map(function(x) { return x.name }),
          //"line_item": line_item,
          //"advertiser": advertiser,  
          //"template": template
        }

        d3.xhr("/optimize")
          .post( JSON.stringify(data) )
      })
    </script>
    </br>
  </div>


  <script>

    function buildTable(data) {
      
      var tt = d3.selectAll(".outer-table-wrapper")


      table.table(tt)
        .data({"key":"Data","values":data}) 
        .render("ctr",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(d3.format(".3%")(t)) })
        .render("placement_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("venue_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("campaign_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("line_item_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("pixel_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("user_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("auction_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })




        .render("publisher_id",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .render("sellers",function(x) { var dthis = d3.select(this); var t = this.parentNode.__data__[x.key]; return dthis.text(t) })
        .draw()

    }
    
    campaign_analysis.upload(d3.select("#upload"))
      .on("load", function parseFile(result){

        var process = campaign_analysis.parse(result)

        headers = process.headers()
        var data = process.data()

        runBuild(data,headers)
      })

      function runBuild(data,headers) {
        window.filtered_data = data;

        var header_mappings = {
            "seller_id": "member_targets"
          , "segment_id" : "segment_group_targets"
          , "venue_id" : "venue_targets"
          , "placement_id": "platform_placement_targets"
          , "site_domain": "domain_targets"
        }

        var values = headers.map(function(f) {
          return header_mappings[f]
        }).filter(function(x) { return x} )

        window.template_fields = campaign_analysis.fields(d3.selectAll("#template-fields"))
          .fields(values)
          .draw()




        var filters = buildUIFilters(headers)
          .on("update",function(x) {
            var y = x.map(function(z) {

              return { 
                  "field": z.field
                , "op": z.op
                , "value": z.value
              }
            }).filter(function(x) { return x.value !== undefined } )

            var filters = y

            window.filtered_data = buildModifiedFilter(data,filters)
            buildTable(window.filtered_data)

            d3.select(".summary").html("Total rows: " + data.length + "<br>" + " Rows remaining after filter: " + window.filtered_data.length + "<br><br>")

            if (window.filtered_data.length == 0) {
              d3.selectAll(".outer-table-wrapper").html("")
            }
            

          })
      
      buildTable(data)

      return data


    }

    


  </script>


      <script>

        var campaignPreview = function(template) {
          var campaign_entries = d3.entries(
            JSON.parse(
              template.replace(/\%\(.*?\)s/g,"'MACRO'").replace(/:'MACRO',/g,':"MACRO",')
            )
          ).filter(function(xx) { return xx.value })
           .sort(function(p,q) { return d3.ascending(p.key,q.key) })

          var items = d3.select(".campaign").selectAll(".items").data(campaign_entries,function(x){ return JSON.stringify(x) })
          var new_items = items
            .enter()
            .append("div").classed("items",true)
            .style("font-size","14px")

          new_items.append("div").text(function(x) { return x.key }).style("width","50%").style("display","inline-block")
          new_items.append("div").text(function(x) { return x.value }).style("width","49%").style("display","inline-block")

          items.exit().remove()

          items.order()

        }

        var profilePreview = function(templates) {

          var obj = {}

          templates.map(function(x) {
            var template = x.template.replace(/\%\(.*?\)s/g,"'MACRO'").replace(/"'MACRO'"/g,'"MACRO"').replace(/'MACRO'/g,'"MACRO"')


            obj[x.name] = JSON.parse(template)

            return x
          })

          var profile_entries = d3.entries(obj).filter(function(xx) { return xx.value })
            .sort(function(p,q) { return d3.ascending(p.key,q.key) })

          var items = d3.select(".profile").selectAll(".items").data(profile_entries)
          var new_items = items
            .enter()
            .append("div").classed("items",true)
            .style("font-size","14px")

          new_items.append("div").text(function(x) { return x.key }).style("width","50%").style("display","inline-block")
          new_items.append("div").text(function(x) { return JSON.stringify(x.value) }).style("width","49%").style("display","inline-block")

          items.exit().remove()

          items.order()

        }
        
        var advertisers = {{advertisers}},
          templates = {{campaign_templates}},
          profile_templates = {{profile_templates}};

        var select_advertiser = d3.selectAll("#advertiser").data([advertisers])
        select_advertiser.selectAll("option").data(function(x) { return x } )
          .enter()
            .append("option")
            .text(function(x) { return x.pixel_source_name })
            .attr("value",function(x){ return x.external_advertiser_id })

        var select_advertiser = d3.selectAll("#report_advertiser").data([advertisers])
        select_advertiser.selectAll("option").data(function(x) { return x } )
          .enter()
            .append("option")
            .text(function(x) { return x.pixel_source_name })
            .attr("value",function(x){ return x.external_advertiser_id })

        var select_advertiser = d3.selectAll("#sql_advertiser").data([advertisers])
        select_advertiser.selectAll("option").data(function(x) { return x } )
          .enter()
            .append("option")
            .text(function(x) { return x.pixel_source_name })
            .attr("value",function(x){ return x.external_advertiser_id })





        var select = d3.selectAll("#templates").data([templates])

        select.on("change",function(x) {
          var dd = this.selectedOptions[0].__data__

          campaignPreview(dd.template)
          
          var xx = profile_templates.filter(function(z) { return z.type == dd.name })

          var required_fields = []
          xx.map(function(f) {
            if (f.required_columns) required_fields.push.apply(required_fields,f.required_columns.split(","))
          })

          console.log(required_fields)

          profilePreview(xx)

          var field = d3.selectAll("#template-fields")
            .data([xx])

          field.enter()
            .append("div")
            .attr("id","template-fields")

          var spans = field.selectAll("span.yo").data(function(x) {return x},function(x) { return x.name })

          spans
            .enter().append("span")
            .classed("yo",true)
            .attr("style","padding: 0px 10px; display: inline-block; width: 250px; height: 20px; overflow: hidden")

          spans.exit().remove()

          spans.selectAll("input").data(function(x) { return [x]}).enter().append("input")
            .attr("type","checkbox")
            .attr("checked","checked")
            .classed("template-field",true)

          spans.selectAll("span").data(function(x) { return [x]}).enter().append("span")
            .text(function(x) { return x.name })

          console.log(xx)

        })

        select.selectAll("option").data(function(x) { return x })
          .enter()
          .append("option").text(function(x) { return x.name })
      </script>
</body>
