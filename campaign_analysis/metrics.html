{% autoescape None %}

<!DOCTYPE html>
<meta charset="utf-8">

<head>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.5/nv.d3.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/nv.css">
<script src="/static/campaign_metrics.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
</head>

<style>
/*    .media_cost svg {
      height: 300px;
      width: 1000px;
    }*/
    .chart svg {
      height: 300px;
      width: 1000px;
    }
    .node {
        cursor: pointer;
    }
    .node circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    .node text {
      font: 10px sans-serif;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }

</style>

<body>

        
<!-- <div style="float: left;" id="campaignTree"></div>
 --><div  id="campaignTree" style="position:absolute; left:10px;"></div>

<!-- <div style="float: right;" id="metricsSummary"> 
 --><div  id="metricsSummary" style="position:absolute; left:1000px; top:20px"> 

    
    <div id="media_cost"><svg></svg></div>
    
    <div id="cpa"><svg></svg></div>

</div>


<script>

    var metricsSummary = function(data, obj){
        
        d3.select("#metricsSummary").selectAll("*").remove()

        d3.select("#metricsSummary").append("h3").text("Choose grouping and metrics")
        d3.select("#metricsSummary").append("br")

        var form = d3.select("#metricsSummary").append("form") 
        form.selectAll("*").remove()

        form.append("input")
            .attr('type', 'radio')
            .attr('value', 'self')
            .attr('name', 'level')
            .property('checked', true)

        form.append("label").text(obj['name'])
        form.append("br")

        if (obj.children && obj.children.length > 0){
            form.append("input")
                .attr('type', 'radio')
                .attr('value', obj.children[0].level)
                .attr('name', 'level')
            form.append("label").text(obj.children[0].level)
            form.append("br")
        }

        if (obj._children && obj._children.length > 0){
            form.append("input")
                .attr('type', 'radio')
                .attr('value', obj._children[0].level)
                .attr('name', 'level')
            form.append("label").text(obj._children[0].level)
            form.append("br")
        }
        form.style("margin","10px")

        form.selectAll("input").on("click", function(d){

            if(this.value == "self"){
                drawMetrics(data, null, obj['name'])
            } else{
                drawMetrics(data, this.value)
            }
        })

        drawMetrics(data, null, obj['name'])


    }

    var drawMetrics = function(data, group, name){
        d3.select("#metricsSummary").selectAll(".chart").remove()


        function getSummedDates(data, startDate, endDate){

            var allDates = d3.time.scale().domain([new Date(startDate), new Date(endDate)])
                            .ticks(d3.time.days, 1)
                            .map(function(d){ return  d3.time.format('%Y-%m-%d 00:00:00')(d)})

            var summed =  d3.nest().key(function(d){return d['date']})
                            .rollup(function(byDate){
                                return {
                                    'imps':  d3.sum(byDate, function(x) {return x['imps']}),
                                    'media_cost':  d3.sum(byDate, function(x) {return x['media_cost']}),
                                    'conv':  d3.sum(byDate, function(x) {return x['conv']})
                                }
                            })
                            .entries(data)

            var dates = summed.map(function(x){return x.key})
            allDates.map(function(d){

                if (dates.indexOf(d)==-1){
                    summed.push({'key':d, 'values':{'imps':0,'media_cost':0,'conv':0} })
                }
            })
            summed = summed.sort(function(a,b){return d3.ascending(a.key, b.key)})
            return summed
        }
        
        var [startDate, endDate] = d3.extent(data, function(d){return d.date})
        
        var grouped;

        if (group){

            grouped = d3.nest().key(function(d){ return d[group] })
                                .rollup(function(group){
                                    return getSummedDates(group, startDate, endDate)
                                })
                                .entries(data)            
        } else{
            grouped = getSummedDates(data, startDate, endDate)
            grouped = [{'key':name, 'values': grouped}]
        }
        
        grouped.map(function(d){
            d.values.map(function(x){
                x['values']['CPA'] = x['values']['conv'] >0 ? x['values']['media_cost'] / x['values']['conv'] : NaN
                return x
            })
            return d
        })

        nv.addGraph(function() {
            var chart = nv.models.stackedAreaChart()
                        .x(function(d) { return  parseInt(new Date(d.key).getTime()) })
                        .y(function(d) {  return d.values.media_cost })
                        .clipEdge(true)
                        .useInteractiveGuideline(true);
            chart.xAxis
                .showMaxMin(false)
                .tickFormat(function(d) {  return d3.time.format('%x')(new Date(d)) });

            chart.yAxis.tickFormat(d3.format('$,.2f'));

            var wrapper = d3.select('#metricsSummary').append("div")
            wrapper.classed("chart",true)

            wrapper.append('svg')
                .datum(grouped)
                .classed("chart",true)
                .transition()
                .duration(500).call(chart);

            nv.utils.windowResize(chart.update);

            return chart;
        });

        nv.addGraph(function() {
            var chart = nv.models.stackedAreaChart()
                        .x(function(d) { return  parseInt(new Date(d.key).getTime()) })
                        .y(function(d) {  return d.values.conv })
                        .clipEdge(true)
                        .useInteractiveGuideline(true);
            chart.xAxis
                .showMaxMin(false)
                .tickFormat(function(d) {  return d3.time.format('%x')(new Date(d)) });

            chart.yAxis.tickFormat(d3.format(',.0f'));

            var wrapper = d3.select('#metricsSummary').append("div")
            wrapper.classed("chart",true)

            wrapper.append('svg')
                .datum(grouped)
                .classed("chart",true)
                .transition()
                .duration(500).call(chart);

            nv.utils.windowResize(chart.update);

            return chart;
        });

        nv.addGraph(function() {
            var chart = nv.models.lineChart()
                        .x(function(d){return parseInt(new Date(d.key).getTime())})
                        .y(function(d){return d.values['CPA']})
                        .useInteractiveGuideline(true)
                        .clipEdge(true)
            chart.xAxis
                .showMaxMin(false)
                .tickFormat(function(d) {  return d3.time.format('%x')(new Date(d)) });
            chart.yAxis.tickFormat(d3.format('$,.2f'));

            var wrapper = d3.select('#metricsSummary').append("div")
            wrapper.classed("chart",true)

            wrapper.append('svg')
                .datum(grouped)
                .classed("chart",true)
                .transition()
                .duration(500).call(chart);
                

            nv.utils.windowResize(chart.update);
            return chart
        });
    }


    var data = {{data}}

    var svg = d3.select("#campaignTree").selectAll("svg").data([data]).enter().append("svg")

    var margin = {top: 20, right: 120, bottom: 20, left: 120},
    width = 960 - margin.right - margin.left,
    height = 1500 - margin.top - margin.bottom;

    var i = 0,
        duration = 750,
        root;

    var tree = d3.layout.tree()
        .size([height, width]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });


    svg.attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
    
    var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var root = {{tree}}
    root.x0 = height / 2;
    root.y0 = 0;

    function collapse(d) {
        if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
        }
    }
    root.children.forEach(collapse);

    update(root)


    d3.select(self.frameElement).style("height", "800px");

    function update(source) {

        // Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
            links = tree.links(nodes);

        // Normalize for fixed-depth.
        nodes.forEach(function(d) { d.y = d.depth * 180; });

        // Update the nodesâ€¦
        var node = g.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
            .on("click", click);

        nodeEnter.append("circle")
            .attr("r", 1e-6)
            .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

        var nodeLink = nodeEnter.append("a")
        nodeLink.append("text")
            .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
            .attr("dy", ".35em")
            .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
            .text(function(d) { return d.name; })
            .style("fill-opacity", 1e-6)
            .style({ "font": "12px sans-serif" });

        nodeLink.on("click", function(d){

            var data  = d3.select("#campaignTree").selectAll("svg").datum()

            data = data.filter(function(x){return x[d.level] == d.name})
            if (d.parent && d.parent.level){
                data = data.filter(function(x){return x[d.parent.level] == d.parent.name})
            }
            metricsSummary(data, d)
        })


        nodeEnter.append("text")
            .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
            .attr("dx", "1.5em")
            .attr("dy", "2em")
            .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
            .text(function(d) {  return "7d CPA : "+ d3.format('$,.2f')(d['metrics']['cpa_7d']); })
        
        nodeEnter.append("text")
            .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
            .attr("dx", "1.5em")
            .attr("dy", "3.5em")
            .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
            .text(function(d) { return "Yest Spend : "+ d3.format('$,.2f')(d['metrics']['media_cost_yest']); })


        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeUpdate.select("circle")
            .attr("r", 4.5)
            .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);

        // Update the linksâ€¦
        var link = g.selectAll("path.link")
            .data(links, function(d) { return d.target.id; });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
                var o = {x: source.x0, y: source.y0};
                return diagonal({source: o, target: o});
            });

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
                var o = {x: source.x, y: source.y};
                return diagonal({source: o, target: o});
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Toggle children on click.
    function click(d) {
        if (d.children) {
          d._children = d.children;
          d.children = null;
        } else {
          d.children = d._children;
          d._children = null;
        }
        update(d);
    }


    





</script>
</body>