{% autoescape None %}

<!DOCTYPE html>
<meta charset="utf-8">

<head>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.5/nv.d3.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/nv.css">
<script src="/static/campaign_metrics.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
</head>

<style>

/*    .chart svg {
      height: 350px;
      width: 700px;
    }*/

    .chart {
      height: 350px;
      width: 850px;
    }
    .node {
        cursor: pointer;
    }
    .node circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    .node text {
      font: 10px sans-serif;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
    select {
        margin:10px;
    }

</style>

<body>

        
    <div id="campaignTree" style="position:absolute; left:10px;"></div>

    <div id="metricsSummary" style="position:absolute; left:1300px; top:20px"> 

        <div id="selector" style="display:inline-block">
            <h3>Choose grouping and metrics</h3>
            <div class="grouping" style = "float:left; width:50%; margin:5px;"></div>
            <div class="metrics" style = "float:right; width:50%; margin:5px;"></div>
        </div>

        <div id="charts" style="display:inline-block; width:2000px">
            <div class="single" style = "float:left; width:50%"></div>
            <div class="groups" style = "float:right; width:50%"></div>
        </div>
    </div>

<script>

    var metricsSummary = function(data, obj){

        // d3.select("#metricsSummary").select('#selector').selectAll("h3").remove()
        // d3.select("#metricsSummary").select('#selector').append("h3").text("Choose grouping and metrics")

        d3.select("#metricsSummary").selectAll("select").remove()

        var selectWrapper = d3.select("#metricsSummary").select("#selector").select(".grouping")
        var select = selectWrapper.append("select").attr('multiple',true)

        select.append("option")
                .property("selected",true)
                .property("value", "single")
                .text(obj["name"]) 

        if (obj.children && obj.children.length > 0){
            select.append("option")
                    .property("value","groups")
                    .text(obj.children[0].level)
        }
        if (obj._children && obj._children.length > 0){
            select.append("option")
                    .property("value", "groups")
                    .text(obj._children[0].level)
        }

        var metricSelectWrapper = d3.select("#metricsSummary").select("#selector").select(".metrics")
        metricSelectWrapper.selectAll("select").remove()

        metricSelectWrapper
            .append("select")
            .attr('multiple',true)

        metricSelectWrapper.select("select").selectAll("option").data(['media_cost',"imps",'conv','CPA_7d','CPA_proj','conv_rate_7d','CPM'])
        .enter()
        .append("option")
        .property("value", function(d){return d})
        .text(function(d){return d})
        .property("selected", function(d){
            if(d == "media_cost" || d == "conv"){
                return true
            } else{
                return false
            }
        })

        d3.select("#metricsSummary").select("#selector").on("change", function(x){

            var metrics = d3.select(this).select(".metrics").selectAll("option").filter(function (d, i) { return this.selected })[0].map(function(d){return d.value })

            d3.select("#metricsSummary").select("#charts").selectAll("svg").remove()
            d3.select(this).select(".grouping").selectAll("option").filter(function (d, i) { return this.selected }).each(function(d, i){

                var wrapper;
                var group  = null;

                if(this.value == "single"){
                    wrapper = d3.select("#metricsSummary").select("#charts").selectAll("div.single")
                }

                else if (this.value == "groups"){
                    wrapper = d3.select("#metricsSummary").select("#charts").selectAll("div.groups")
                    group = this.text
                }

                drawMetrics(wrapper, data, group, obj['name'], metrics)

            })
        })

        var metrics = d3.select("#selector").select(".metrics").selectAll("option").filter(function (d, i) { return this.selected })[0].map(function(d){return d.value })
        
        drawMetrics(d3.select("#metricsSummary").select("#charts").selectAll("div.single"), data, null, obj['name'], metrics)

        // select.on("click", function(x){

        //     d3.select(this).selectAll("option").filter(function (d, i) { return this.selected }).each(function(d, i){
                
        //         var wrapper;
        //         var group  = null;

        //         if(this.value == "single"){
        //             wrapper = d3.select("#metricsSummary").select("#charts").selectAll("div.single")
        //         }

        //         else if (this.value == "groups"){
        //             wrapper = d3.select("#metricsSummary").select("#charts").selectAll("div.groups")
        //             group = this.text
        //         }
        //         drawMetrics(wrapper, data, group, obj['name'])

        //     })
        // }) 
    }

    var drawMetrics = function(wrapper, data, group, name, metrics){

        function getSummedDates(data, startDate, endDate){

            var allDates = d3.time.scale().domain([new Date(startDate), new Date(endDate)])
                            .ticks(d3.time.days, 1)
                            .map(function(d){ return  d3.time.format('%Y-%m-%d 00:00:00')(d)})

            var summed =  d3.nest().key(function(d){return d['date']})
                            .rollup(function(byDate){
                                return {
                                    'imps':  d3.sum(byDate, function(x) {return x['imps']}),
                                    'media_cost':  d3.sum(byDate, function(x) {return x['media_cost']}),
                                    'conv':  d3.sum(byDate, function(x) {return x['conv']})
                                }
                            })
                            .entries(data)

            var dates = summed.map(function(x){return x.key})
            allDates.map(function(d){

                if (dates.indexOf(d) <= -1){
                    summed.push({'key':d, 'values':{'imps':0,'media_cost':0,'conv':0} })
                }
            })
            summed = summed.sort(function(a,b){return d3.ascending(a.key, b.key)})

            summed = summed.map(function(d,i){

                d['values']['imps_7d'] = d3.sum(summed.slice(Math.max(0,i-6),i+1), function(x) {return x.values['imps']})
                d['values']['media_cost_7d'] = d3.sum(summed.slice(Math.max(0,i-6),i+1), function(x) {return x.values['media_cost']})
                d['values']['conv_7d'] = d3.sum(summed.slice(Math.max(0,i-6),i+1), function(x) {return x.values['conv']})                
                return d
            })

            summed = summed.map(function(d){
                d['values']['CPA'] = d['values']['conv'] >0 ? d['values']['media_cost'] / d['values']['conv'] : NaN
                d['values']['CPM'] = d['values']['imps'] >0 ? d['values']['media_cost']*1000 / d['values']['imps'] : NaN
                d['values']['conv_rate_7d'] = d['values']['imps'] >0 ? d['values']['conv_7d'] / d['values']['imps_7d'] : NaN
                d['values']['CPA_7d'] = d['values']['conv_7d'] >0 ? d['values']['media_cost_7d'] / d['values']['conv_7d'] : NaN
                d['values']['CPA_proj'] = d['values']['conv_rate_7d'] >0 ? (d['values']['CPM']/1000) / d['values']['conv_rate_7d'] : NaN
                return d
            })
            return summed
        }
        
        var [startDate, endDate] = d3.extent(data, function(d){return d.date})

        var grouped;

        if (group){

            var top = d3.nest().key(function(d){ return d[group] }).rollup(function(d){return d3.sum(d, function(x){return x['imps']})}).entries(data)
                            .sort(function(a,b){return d3.descending(a.values, b.values)}).slice(0,5).map(function(d){return d.key})

            var tranformed = data.map(function(d){
                if(top.indexOf(d[group]) <= -1  ){
                    d[group] = "Other"
                }
                return d
            })

            grouped = d3.nest().key(function(d){ return d[group] })
                                .rollup(function(group){
                                    return getSummedDates(group, startDate, endDate)
                                })
                                .entries(tranformed)            
        } else{
            grouped = getSummedDates(data, startDate, endDate)
            grouped = [{'key':name, 'values': grouped}]
        }

        var divs = wrapper.selectAll("div").data(metrics)
        divs.enter().append('div')
        divs.classed("chart",true)
        divs.exit().remove()

        divs.each(function(d){

            var self = d3.select(this)
            self.selectAll("*").remove()

            self.append("h2").text(d)

            var chart;
            if ( d.indexOf("media_cost") > -1 || d.indexOf("imps") > -1 || d == "conv" ){
                chart = nv.models.stackedAreaChart()
            }
            else {
                chart = nv.models.lineChart()
                    .interpolate("basis")
                    .options({'strokeWidth':5})
            }
            chart
                .x(function(x){return parseInt(new Date(x.key).getTime())})
                .y(function(x){return x.values[d]})
                .useInteractiveGuideline(true)
                .clipEdge(true)
            
            chart.xAxis
                .showMaxMin(false)
                .tickFormat(function(x) {  return d3.time.format('%x')(new Date(x)) });
            

            if(d.indexOf("media_cost") > -1 || d.indexOf('CPM')>-1 || d.indexOf('CPA') > -1){
                chart.yAxis.tickFormat(d3.format('$,.2f'));
            }
            else if (d.indexOf("rate") > -1){
                chart.yAxis.tickFormat(d3.format(".4%"));
            }
            else{
                chart.yAxis.tickFormat(d3.format(",.0f"));
            }

            self.append('svg').datum(grouped).classed("chart",true)
                    .transition().duration(500).call(chart);

        })

    }


    var data = {{data}}

    var svg = d3.select("#campaignTree").selectAll("svg").data([data]).enter().append("svg")

    var margin = {top: 20, right: 120, bottom: 20, left: 120},
    width = 1000 - margin.right - margin.left,
    height = 1500 - margin.top - margin.bottom;

    var i = 0,
        duration = 750,
        root;

    var tree = d3.layout.tree()
        .size([height, width]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });


    svg.attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
    
    var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var root = {{tree}}
    root.x0 = height / 2;
    root.y0 = 0;

    function collapse(d) {
        if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
        }
    }
    root.children.forEach(collapse);

    update(root)


    d3.select(self.frameElement).style("height", "800px");

    function update(source) {

        // Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
            links = tree.links(nodes);

        // Normalize for fixed-depth.
        nodes.forEach(function(d) { d.y = d.depth * 180; });

        // Update the nodes…
        var node = g.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
            .on("click", click);

        nodeEnter.append("circle")
            .attr("r", 1e-6)
            .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

        var nodeLink = nodeEnter.append("a")
        nodeLink.append("text")
            .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
            .attr("dy", ".35em")
            .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
            .text(function(d) { return d.name; })
            .style("fill-opacity", 1e-6)
            .style({ "font": "14px sans-serif" });

        nodeLink.on("click", function(d){

            var data  = d3.select("#campaignTree").selectAll("svg").datum()
            if(d.level){
                data = data.filter(function(x){return x[d.level] == d.name})
                if (d.parent && d.parent.level){
                    data = data.filter(function(x){return x[d.parent.level] == d.parent.name})
                }   
            }

            metricsSummary(data, d)
        })


        nodeEnter.append("text")
            .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
            .attr("dx", "1.5em")
            .attr("dy", "2em")
            .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
            .text(function(d) { return "Yest Spend : "+ d3.format('$,.2f')(d['metrics']['media_cost_yest']); })

        nodeEnter.append("text")
            .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
            .attr("dx", "1.5em")
            .attr("dy", "3.5em")
            .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
            .text(function(d) { return "Yest CPA : "+ d3.format('$,.2f')(d['metrics']['cpa_yest']); })

        nodeEnter.append("text")
            .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
            .attr("dx", "1.5em")
            .attr("dy", "5em")
            .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
            .text(function(d) {  return "7d CPA : "+ d3.format('$,.2f')(d['metrics']['cpa_7d']); })


        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeUpdate.select("circle")
            .attr("r", 4.5)
            .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);

        // Update the links…
        var link = g.selectAll("path.link")
            .data(links, function(d) { return d.target.id; });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
                var o = {x: source.x0, y: source.y0};
                return diagonal({source: o, target: o});
            });

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
                var o = {x: source.x, y: source.y};
                return diagonal({source: o, target: o});
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Toggle children on click.
    function click(d) {
        if (d.children) {
          d._children = d.children;
          d.children = null;
        } else {
          d.children = d._children;
          d._children = null;
        }
        update(d);
    }


    





</script>
</body>