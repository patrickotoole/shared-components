{% autoescape None %}

{% block page_header %}Work Queue Log{% end %}

<style>
pre {
margin : 1px;
}
</style>


<div id='messages'>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<div>
Enter Appname or word filter
<input id="wordfilter"></input>
<button onclick=WebSocketClient.init()>Start</button>
</div>

<script>
new function() {
    var ws = null;
    var connected = false;

    var serverUrl;
    var connectionStatus;
    var sendMessage;
    
    var connectButton;
    var disconnectButton; 
    var sendButton;

    var open = function() {
        //var url = 'ws://192.168.99.100:8888/admin/websocket?id=154'
        //var url = 'ws://portal.getrockerbox.com/admin/websocket?id=1776';
        random_id = Math.round(Math.random() * 1000);
        URL = 'ws://portal.getrockerbox.com/admin/websocket?id=' + String(random_id)
        var url = URL
        ws = new WebSocket(url);
        ws.onopen = onOpen;
        ws.onclose = onClose;
        ws.onmessage = onMessage;
        ws.onerror = onError;
    }
    
    var close = function() {
        if (ws) {
            console.log('CLOSING ...');
            ws.close();
        }
        connected = false;
    }
    
    var clearLog = function() {
        $('#messages').html('');
    }
    
    var onOpen = function() {
        console.log('OPENDD')
        connected = true;
        var msg = 'initialize';
        addMessage(msg, 'SENT');
        ws.send(msg);
        var msg = 'start';
        addMessage(msg, 'SENT');
        ws.send(msg);
        var msg = '{"streams":["application_log"]}'
        addMessage(msg, 'SENT');
        ws.send(msg)
    };
    
    var onClose = function() {
        console.log('CLOSED: ' + serverUrl.val());
        ws = null;
    };
    
    var onMessage = function(event) {
        var data = event.data;
        var filter_word = $( "#wordfilter" ).val();
        console.log(filter_word);
        if (String(data).indexOf(filter_word) !== -1){
            var parsed_data  = JSON.parse(data);
            for(var i=0; i<parsed_data['application_log'].length; i++){
                var parsed_msg = parsed_data['application_log'][i]['timestamp'] + " "+parsed_data['application_log'][i]['log_message']
                addMessage(parsed_msg);
            }
            //addMessage(data);
        }
    };
    
    var onError = function(event) {
        alert(event.data);
    }
    
    var addMessage = function(data, type) {
        var msg = $('<pre>').text(data);
        if (type === 'SENT') {
            msg.addClass('sent');
        }
        var messages = $('#messages');
        messages.prepend(msg);
        
        var msgBox = messages.get(0);
        while (msgBox.childNodes.length > 1000) {
            msgBox.removeChild(msgBox.firstChild);
        }
        msgBox.scrollTop = msgBox.scrollHeight;
    }

    WebSocketClient = {
        init: function() {
            close();
            open();

        }
    };
}

//$(function() {
//    WebSocketClient.init();
//});
</script>

