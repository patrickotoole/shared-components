{% autoescape None %}
{% block scripts_top %}
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic%7CUbuntu:300,300italic,400,400italic,500,500italic,700,700italic%7CInconsolata:400,400italic,700,700italic%7CLato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic">
<link type="text/css" rel="stylesheet" href="/static/js/chosen/chosen.min.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap.min.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/fonts.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap-switch.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap-select.css"/>

<link type="text/css" rel="stylesheet" href="/static/css/style.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/font-awesome.min.css"/>

<script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.min.js"></script>

<script type="text/javascript" src="/static/js/bootstrap-select.js"></script>


<script type="text/javascript" src="/static/js/d3.js" charset="utf-8"></script>

<script type="text/javascript" src="/js/api/build/api.js"></script>
<script type="text/javascript" src="/js/state/build/state.js"></script>

<script type="text/javascript" src="/js/start/build/start.js"></script>
<script type="text/javascript" src="/js/filter/build/filter.js"></script>
<script type="text/javascript" src="/js/table/build/table.js"></script>
<script type="text/javascript" src="/js/media_plan/build/media_plan.js"></script>
<script type="text/javascript" src="/js/dashboard/build/dashboard.js"></script>
<script type="text/javascript" src="/js/tabular/build/tabular.js"></script>

<script type="text/javascript" src="/js/selectize.js/dist/js/standalone/selectize.js"></script>
<link type="text/css" rel="stylesheet" href="/js/selectize.js/dist/css/selectize.css"/>


<script type="text/javascript" src="/static/js/rockerbox/helper.js"></script>

<style> 
body {
  background:#F0F4F7;
  padding-top:0px;
}
.advertiser {
  display:inline-block;
}
.advertiser-wrap {
  width:150px;
  height:150px;
}
.advertiser-wrap .title {
  font-size:14px;
  font-weight:bold;
  line-height:30px;
}
.advertiser-wrap .total {
  font-size:48px;
  font-weight:bold;
  line-height:48px;
  text-align:center;
}
h4 {
  /*
  text-align:center;
  font-weight:bold;
  font-size:32px;
  line-height:48px*/

    font-weight: bold;
    font-size: 14px;
    line-height: 22px;
    text-transform: uppercase;
    color: rgb(136, 136, 136);
    letter-spacing: 0.05em;
}

.form-wrap {
  width:500px;
  display:inline-block
}

.row {

  padding-top:3px;
  display:flex
}

.row div {
  text-transform:uppercase;
    margin: 2px 10px 2px 0px;
    line-height: 32px;
    color: inherit;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
    background: rgb(227, 235, 240);
}

.row * {
  line-height:31px;
  font-size:14px;

  padding-left: 10px;
  flex:1;
}

.main {
  font-size:12px
}

input {
  border-radius:4px;
  border: 1px solid #ccc;
}

a.button {
    display:inline-block;
    line-height:36px;
    text-decoration:none;
    text-transform:uppercase;
    font-weight:bold;
    vertical-align: bottom;
    height: 36px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
    margin-left: 10px;
    padding-left: 10px;
    padding-right: 10px;
}
</style>

<script>

function accessor(attr, val) {
  if (val === undefined) return this["_" + attr]
  this["_" + attr] = val
  return this
}

function d3_class(target,cls,type,data) {
  return d3_updateable(target,"." + cls, type || "div",data)
    .classed(cls,true)
}


class Action {
  constructor(target) {
    this._target = target
    this._on = {}
  }

  data(val) { return accessor.bind(this)("data",val) } 

  on(action,fn) {
    if (fn === undefined) return this._on[action] || function() {};
    this._on[action] = fn;
    return this
  }

  draw() {

    self = this

    var fields = [
        {key: "action_name",value: "Name" }
      , {key: "url_pattern", value: "Pattern"}
    ]

    var outer_wrap = d3_updateable(this._target,".outer-wrap","div",fields, _ => 1)
      .classed("outer-wrap",true)

    var wrap = d3_class(outer_wrap,"form-wrap").datum(fields)

    var rows = d3_splat(wrap,".row","div",x => x, x => x.key )
      .classed("row",true)

    var label = d3_class(rows,"label-wrap").text(x => x.value)
    var input = d3_class(rows,"input","input").text(x => x.value)

    d3_class(outer_wrap,"button","a").text("Create Segment")
      .on("click",function() {
        var obj = {advertiser:self.data()}
        input.each(function(x) {
          obj[x.key] = x.key == "url_pattern" ? [this.value] : this.value
        })
        self.on("submit")(obj)
      })


    

    
    return this
  }
}

</script>


{% end %}
{% block scripts_bottom %}{% end %}
{% block content %}
<div class="main" style="width:1000px;margin:auto;padding-top:0px"></div>
<script>
(function() {

  var s = state.state()
    .subscribe("load.actions", function(error,sub,state) {

      
      var main = d3.select(".main")

      d3_updateable(main,"h4.create","h4").text("Create New Segment").classed("create",true)

      var new_action = (new Action(main))
        .data(sub[0].advertiser)
        .on("submit",function(action) {
          api.action.create(action,(_,resp) => {
            var new_actions = sub.concat([resp])
            s.publishStatic("actions",new_actions)
          })
        })
        .draw()

      d3_updateable(main,"h4.existing","h4").text("View Existing Segments").classed("existing",true)

      table.table(main)
        .data({"values":sub})
        .skip_option(true)
        .headers([
            {key:"action_name",value:"name"}
          , {key:"url_pattern",value:"pattern"}
          , {key:"has_filter",value:"sub filters?"}

        ])
        .draw()
    })

  s.publishStatic("actions",api.action.getAll)




  window.s = s

})();
</script>


{% end %}
