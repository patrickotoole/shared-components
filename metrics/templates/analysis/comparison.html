{% extends "base.html" %}
{% block scripts_top %}
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic%7CUbuntu:300,300italic,400,400italic,500,500italic,700,700italic%7CInconsolata:400,400italic,700,700italic%7CLato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic">
<link type="text/css" rel="stylesheet" href="/static/js/chosen/chosen.min.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap.min.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/fonts.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap-switch.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap-select.css"/>

<link type="text/css" rel="stylesheet" href="/static/css/style.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/font-awesome.min.css"/>

<script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.min.js"></script>

<script type="text/javascript" src="/static/js/bootstrap-select.js"></script>


<script type="text/javascript" src="/static/js/d3.js" charset="utf-8"></script>

<script type="text/javascript" src="/js/start/build/start.js"></script>
<script type="text/javascript" src="/js/filter/build/filter.js"></script>
<script type="text/javascript" src="/js/table/build/table.js"></script>
<script type="text/javascript" src="/js/media_plan/build/media_plan.js"></script>
<script type="text/javascript" src="/js/dashboard/build/dashboard.js"></script>
<script type="text/javascript" src="/js/state/build/state.js"></script>
<script type="text/javascript" src="/js/tabular/build/tabular.js"></script>


<script type="text/javascript" src="/static/js/rockerbox/crusher/sidebar.js"></script>

<script type="text/javascript" src="/static/js/rockerbox/routes/routes.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/routes/routes.navigation.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/menu/menu.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/menu/menu.navbar.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/menu/menu.selectbar.js"></script>

<script type="text/javascript" src="/static/js/rockerbox/helper.js"></script>






<script type="text/javascript">
  /*
    Google analytics
  */
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50457693-2', 'auto');
  ga('send', 'pageview');
</script>
{% end %}
{% block scripts_bottom %}{% end %}
{% block content %}
<div class="hidden" style="position:fixed;width:200px;top:0px;left:0px;height:100%;background:black">
  <div class="row col-md-12">
    <a href="/crusher/funnel/action?source=baublebar">Action</a>
  </div>
  <div class="row col-md-12">
    <a href="/crusher/funnel?source=baublebar">Funnel</a>
  </div>
</div>
<div class="container" style="width:inherit"></div>
<style>

  .head-wrap {
    height: 150px;
    border-bottom:1px solid #ddd
  }
  .body-wrap {
    overflow:hidden
  }
  .head-wrap .item, .body-wrap .item {
    display:table-cell;
    width:50px;
    height:50px;
    position:relative;
    vertical-align:top
  }

  .head-wrap .item {
    display:table-cell;
    width:50px;
    height:150px;
    position:relative
  }

  .tabular-wrapper {
    width:900px
  }

  .head-wrap .item span {
    transform: rotate(-45deg);
    display: block;
    position: absolute;
    bottom: 50px;
    width: 155px;
    text-transform: uppercase;
    font-size: .85em;
    font-weight: normal;
    border-bottom: solid 1px #DDD;
    line-height: 30px;
    right: -120px;
  }
  .versus {

    margin-top:10px;
    margin-right:10px;
    display:inline-block;

    padding:10px;
    border-radius:10px;
    border: 1px solid #ccc;
  }
  a.versus:hover {
    text-decoration:none;

  }

  .versus.selected, .square.selected {
    background-color:white
  }
</style>
<script>
(function() {

  RB.menu.routes.roots = [
      {
        "name": "Segments",
        "push_state": "/crusher/action/existing",
        "class": "fa fa-users",
        "selection": "All Segments",
        "values_key": "action_name"
      }, {
        "name": "Create Segment",
        "push_state": "/crusher/action/recommended",
        "class": "glyphicon glyphicon-plus",
        "values_key": "action_name",
        "hide_href": true
      }, {
        "name": "Settings",
        "push_state": "/crusher/settings",
        "class": "glyphicon glyphicon-cog"
      }
    ]
  RB.menu.render(d3.select("body"),true)

  var centered = d3_updateable(d3.select(".container"),"div","div")
    .style("width","900px")
    .style("margin-left","auto")
    .style("margin-right","auto")

  var buttons = d3_updateable(centered,"div.button-row","div")
    .classed("button-row",true)

  var description = d3_updateable(centered,"div.description-row","div")
    .classed("description-row",true)
    .style("padding-top","20px")
    .style("font-size","16px")
    .style("max-width","600px")
    .style("display","block")


  var action = d3_updateable(centered,"div.action-row","div")
    .classed("action-row",true)
    .style("padding-top","20px")
    .style("font-size","12px")
    .style("max-width","600px")
    .style("display","block")




  var PERCENT_TEXT = "<h4 style='font-weight:bold'>Percentage of Time Spent Off-site</h4>This view summarizes how a user spends time when they are not on your site. <br><br> Each row represents the likelihood that a user will be on a particular type of site, given that that have viewed a specific page on your site. <br><br> A row for the population is included to compare against a generic internet user's behavior."

  var DIFFERENCE_TEXT = "<h4 style='font-weight:bold'>Time Spent Off-site Compared to Population</h4>This view shows how your user's activity compares to a standard web browser.<br><br>Each row represents the increase (or decrease) in likelihood that a user will be on a particular type of site, given that that have viewed a specific page on your site. <br><br> For example, a positive percentage means that a user is more likely to be on that type of site than a typical web browser."

  var CALC_TEXT = "<h4 style='font-weight:bold'>Time Spent Off-site Compared to a Segment</h4>This view shows how your user's activity compares to a selected segment of users from your site.<br><br>Each row represents the difference in off-site behavior given they have viewed one page versus another.<br><br> For example, if you compare a segment that generates revenue to all of the users on your site, you can see the off-site attributes that help predict that a user will convert."


  var comparisons = [
      {
          "field": "percent"
        , "title": "Percentage of Time Spent"
        , "text": PERCENT_TEXT
      }
    , {
          "field": "index"
        , "title": "Difference Versus Population"
        , "text": DIFFERENCE_TEXT
      }
    , {
          "field": "calc"
        , "title": "Difference Versus Segment"
        , "text": CALC_TEXT
        , "callback": function(data) {

            d3_updateable(action,"h4","h4",data.data)
              .style("font-weight","bold")
              .text("Compare to Segment:")

    
            var select = d3_updateable(action,"select","select",data.data)
              .on("change",function() { 
                var data = s._state.formatted_data
                var x = this.selectedOptions[0].__data__
                data.calc_row = x.key
                s.publish("formatted_data",data)
              })
            d3_splat(select,"option","option",function(x) { return x}, function(x) { return x.key })
              .text(function(x) { return x.key })
              
            
          }
      }
  ]
  


  var versus = d3_splat(buttons,".versus","a",comparisons, function(x) { return x.title } )
    .classed("versus",true)
    .text(function(x) { return x.title })
    .on("click",function(x){
      versus.classed("selected",false);
      d3.select(this).classed("selected",true)

      var field = x.field
      description.html(x.text)
      var data = s._state.formatted_data
      data.field = field
      data.calc_row = "population"

      action.html("")

      x.callback && x.callback(data)
      s.publish("formatted_data",data)
  
    })



  d3.select(versus.node()).classed("selected",true)

  function convertHex(hex,opacity){
    hex = hex.replace('#','');
    r = parseInt(hex.substring(0,2), 16);
    g = parseInt(hex.substring(2,4), 16);
    b = parseInt(hex.substring(4,6), 16);

    result = 'rgba('+r+','+g+','+b+','+opacity/100+')';
    return result;
  }


  function buildPop(idf) {

    var category_pop = 
      d3.entries(idf)
        .filter(function(x) { return x.key != "" && x.key != "World Localities" })
        .map(function(kv) {
          kv.value = kv.value.pct_users/200000

          return kv
        })

    var summed = d3.sum(category_pop,function(r){ return r.value })

    category_pop.map(function(kv) {
       kv.value = kv.value/summed
      })

    return [{"key":"name","value":"population"}].concat(category_pop)

  }

  function prepData(value) {

      var min = 1
        , max = 0
      
      var data = d3.entries(value.user_categories).map(function(row) { 
        var values = d3.entries(row.value).map(function(kv) { 
          min = Math.min(min,kv.value)
          max = Math.max(max,kv.value)

          return kv 
        })
        row.value = [{"key":"name","value":row.key}].concat(values)
        return  row
      })


      var category_pop = buildPop(value.category_idf)
      var category_order = category_pop.reduce(function(p,c) {p[c.key] = c.value; return p},{})

      data = [{"key":"population","value":category_pop}].concat(data)

      data.map(function(row){
        row.value.map(function(item){

          if (item.key == "name") return ;

          var value = category_order[item.key]

          item.percent = item.value
          item.index = 0 
          if (item.value > 0) item.index = -(value - item.value)/value 
          //item.value = item.index

        })
      })

      return {"data":data,"min": min, "max": max, "category_order": category_order }

  }

  var NAME_WIDTH = 200

  var s = state.state()
    .subscribe("table.formatted_data", function(error,d) {

      var field = d.field || "percent"
        , data = d.data
        , min = d.min
        , max = d.max
        , sortby = d.sort_row || "population"
        , row_direction = d.row_direction || "forward"
        , linear = d.scale
        , ryg = d3.scale.threshold().range([ 
                  "#d73027", "#fc8d59", "#fee08b", "#ffffff",
                  "#d9ef8b", "#91cf60", "#1a9850",
                ]).domain([-.2,-.1,0,.05,.1,.2]);

      var formatter = {
          "percent": function(x) { return "rgba(70, 130, 180, " + linear(x.value) + " )" }
        , "index": function(x) { return ryg(x.index) != "#ffffff" ? convertHex(ryg(x.index ),60) : convertHex(ryg(x.index ),1) }
        , "calc": function(x) { try{ return ryg(x.calc) != "#ffffff" ? convertHex(ryg(x.calc),60) : convertHex(ryg(x.calc),1) }  catch(e) { debugger}  }

      }

      if (field == "calc") {
        var calc_row = d.calc_row || "population"
        var values = data.filter(function(row) { return row.key == calc_row })[0].value

        var order = values.reduce(function(p,c) {p[c.key] = c.value; return p},{})

        data.map(function(row) {
          row.value.map(function(item) {

            if (item.key == "name") return ;

            var value = order[item.key]
            item.calc = 0
            if (item.value > 0) item.calc = -(value - item.value)/value 
            if (item.calc == Infinity) item.calc = -0
            if (item.calc == NaN) item.calc = -0

          })
        })
      }


      var table = tabular.tabular(centered)
        .data(data)

      table._target.selectAll(".row").classed("hidden",function(row) { return (["index","calc"].indexOf(field) > -1) ? row.key == d.calc_row : false }) 

      var order = d.data
        .filter(function(x) { return x.key == sortby})[0].value
        .reduce(function(p,c) {p[c.key] = c[field]; return p},{})

      var headers = table.headers()
        .sort(function(p,q) { return (order[q] || 0) - (order[p] || 0) })

      if (row_direction == "reverse") headers.reverse()

      headers = ["name"].concat(headers)
     
      table.headers(headers)

      table
        .render_header(function(d,i) {
          if (d == "name") {
            var h = d3_updateable(d3.select(this),"div","div")
              .style("height","50px")
              .style("width",NAME_WIDTH + "px")
              .style("margin-top","100px")
              .style("padding-left","20px")
              .style("line-height","50px")
              .style("text-transform", "uppercase")
              //.style("border-right","1px solid #ddd")
              .text(d)

            return
          }

          var h = d3_updateable(d3.select(this),"div","div")
            .style("width","50px")


          d3_updateable(h,"span","span")
            .text(JSON.stringify)

          var width = table._target
            .style("width").replace("px","")

          var value = NAME_WIDTH + (i)*50

          h.style("display",value > 900 ? "none" : undefined)

        })
        .render_item(function(d) {
          var sq = d3_updateable(d3.select(this),".square","div")
            .classed("square",true)
            .style("width","50px")
            .style("height","50px")
            .style("line-height","50px")
            .style("text-align","center")
            .style("overflow","hidden")
            .style("border-bottom"," 1px solid #eee")
            .style("border-right"," 1px solid #eee")

          if (d.key != "name") sq.text(function(x) { return x[field] == -0 ? " - " : d3.format("%")(x[field]) })
            .style("background-color", formatter[field])


          if (d.key == "name") {

           

            sq.style("width",NAME_WIDTH + "px")
              .style("text-align","left")
              .style("border-bottom"," 1px solid #ddd")
              .style("border-right"," 1px solid #ddd")
              .classed("selected",function(d) { return s._state.formatted_data.sort_row == d.value})


            d3_updateable(sq,"span.text","span")
              .classed("text",true)
              .style("width",(NAME_WIDTH - 25) + "px")
              .text(function(x) { return x.value })
              .on("click",function(d) {
                var data = s._state.formatted_data

                if ((data.row_direction == "forward") && (data.sort_row == d.value)) data.row_direction = "reverse"
                else data.row_direction = "forward"

                data.sort_row = d.value
                s.publish("formatted_data",data)
              })
              .style("display","inline-block")
              .style("padding-left","10px")
              .style("margin-right","5px")
              .style("height","50px")
              .style("overflow","hidden")
              .style("font-weight","bold")
              .style("cursor","pointer")

            if (d.value != "population") d3_updateable(sq,"a.link","a")
              .classed("link fa fa-external-link",true)
              .style("display","inline-block")
              .style("width","19px")
              .style("line-height","50px")
              .style("height","50px")
              .style("vertical-align","top")
              .style("text-align","center")
              .style("font-size","10px")


              

          }



        })
        .draw()

    })
    .subscribe("table.comparison_data",function(error,value) {
      var linear = d3.scale.linear()
        .range([0,.8])

      var d = prepData(value)

      d.scale = d3.scale.linear().range([0,.8]).domain([d.min,d.max])
      d.field = "percent"
      d.row_direction = "forward"

      s.publish("formatted_data", d)

    })

  var asyncPub = function(cb){
    d3.json("/crusher/v2/visitor/testing_category/cache?url_pattern=/",cb)
  }


  s.publish("comparison_data",asyncPub)

  window.s = s


})();
</script>


{% end %}
