{% autoescape None %}
{% block content %}

<head>
  <script type="text/javascript" src="/static/js/d3.js" charset="utf-8"></script>
  <script src="/static/js/jquery.min.js"></script>
  <script src="/static/js/crossfilter.min.js"></script> 
  <script src="/static/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/static/js/chosen/chosen.jquery.min.js"> </script>

  <link href="/static/js/chosen/chosen.min.css" rel="stylesheet"> 
  <link href="/static/css/bootstrap.css" rel="stylesheet"> 

  <style>
    input[type="checkbox"]:disabled + label{ color: #ccc; }
    .loading { display: none; } 
    body { font: 10px sans-serif; }
    .axis path,
    .axis line { fill: none; stroke: #000; shape-rendering: crispEdges; }
    .x.axis path { display: none; }
    .line { fill: none; stroke: steelblue; stroke-width: 1.5px; }
  </style>

  <script>

     var group = {
      add: function(p, v){
        var total_ecp = p.imps*p.ecp || 0, total_eap = p.imps*p.eap || 0;
 
        p.imps += v.imps
        p.ecp = (total_ecp + v.imps*v.ecp)/p.imps
        p.eap = (total_eap + v.imps*v.eap)/p.imps 
 
        return p
      },
      reduce: function(p, v){
        var total_ecp = p.imps*p.ecp || 0, total_eap = p.imps*p.eap || 0;
 
        p.imps -= v.imps
        p.ecp = (total_ecp - v.imps*v.ecp)/p.imps
        p.eap = (total_eap - v.imps*v.eap)/p.imps 
         
        return p
      },
      init: function(){ return { imps:0, ecp:0, eap:0 } }
    }

    var buildCrossfilter = function(dd) {

      var crs = crossfilter(dd)
  
      var dimensions = {
        seller: crs.dimension(function(d){return d.seller}),
        tag: crs.dimension(function(d){return d.tag}),
        size: crs.dimension(function(d){return d.size}),
        domain: crs.dimension(function(d){return d.domain}),
        date: crs.dimension(function(d){return d.timestamp})
      }
  
      var groups = {
        sellers: dimensions.seller.group()
          .order(function(d){return d.imps})
          .reduce(group.add,group.reduce,group.init),
        tags: dimensions.tag.group()
          .order(function(d){return d.imps})
          .reduce(group.add,group.reduce,group.init),
        sizes: dimensions.size.group()
          .order(function(d){return d.imps})
          .reduce(group.add,group.reduce,group.init),
        domain: dimensions.domain.group()
          .order(function(d){return d.imps})
          .reduce(group.add,group.reduce,group.init),
        date: dimensions.date.group()
          .order(function(d){return d.imps})
          .reduce(group.add,group.reduce,group.init),  
      }

      return {
        dimensions: dimensions,
        groups: groups
      }
    }
    
  
    var controller = (function(controller) {
      var URL = window.location.pathname + window.location.search
      var addParam = function(u,p) { return u.indexOf("?") >= 0 ? u + "&" + p : u + "?" + p }
      URL = addParam(URL,"format=json")

      var CRS = {}

      controller.init = function(){
        d3.json(URL, function(dd){
          CRS = buildCrossfilter(dd) 
          controller.render(dd)
        });  
      }

      controller.render = function(dd) {

        var kvs = dd.length == 0 ? false : ["seller","tag","size"].map(function(x){
          var values = Object.keys(dd.reduce(function(p,c){p[c[x]] = true;return p},{}))
          return {"key": x,"values": values}
        })
        
        var data = CRS.groups.date.all();
        container.build(d3.select("#filterable"),kvs,data)  

      }

      controller.select = function(x) {

        var key = d3.select(this.parentElement).datum().key
        var data = d3.selectAll(this.selectedOptions).data()
  
        CRS.dimensions[key].filterFunction(function(x){
          return data.indexOf(x) > -1 || data.length == 0
        })

        controller.render([])
      }

      return controller 

    })(controller || {})
      
  
    var container = (function(c){
  
      c.buildFilter = function(filter){
        filter.append("h5").text(function(x){return x.key})
  
        var select = filter.append("select")
          .attr("multiple",true)
          .classed("filter-select",true)
  
        select.selectAll("option")
          .data(function(x){return x.values})
          .enter()
            .append("option")
            .text(function(x){return x})
  
        $(".filter-select")
          .chosen({width: "100%"})
          .change(controller.select)
  
      }
  
      c.buildFilters = function(target,options){
  
        var filterWrapper = target.append("div")
          .classed("filter-wrapper row",true)
  
        var w = filterWrapper.append("div")
          .classed("col-md-12",true)
  
        var filters = w.selectAll(".filter")
          .data(options)
          .enter()
            .append("div").classed("filter",true)
  
        c.buildFilter(filters)
  
      }
  
      c.buildTimeseries = function(target,data,title) {

        data.map(function(x){
          x.date = new Date(x.key)
          for (var i in x.value) 
            x[i] = x.value[i]
        })
        var margin = {top: 20, right: 20, bottom: 30, left: 50},
          width = 960 - margin.left - margin.right,
          height = 200 - margin.top - margin.bottom;
  
        var parseDate = d3.time.format("%D-%b-%y %H:%M").parse;
  
        var x = d3.time.scale().range([0, width]); 
        var y = d3.scale.linear().range([height, 0]); 
        var xAxis = d3.svg.axis().scale(x).orient("bottom"); 
        var yAxis = d3.svg.axis().scale(y).orient("left");
  
        var line = d3.svg.line()
          .x(function(d) { return x(d.date); })
          .y(function(d) { return y(d.ecp); });
  
        var line2 = d3.svg.line()
          .x(function(d) { return x(d.date); })
          .y(function(d) { return y(d.eap); });
  
        target.selectAll("h2")
          .data([data])
          .enter()
            .append("h2")
            .text(title)
  
        var svg = target.selectAll("svg")
          .data([data])

        var newSvg = svg
          .enter()
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain([0,d3.max(data, function(d) { return d.ecp; })]);
  
        newSvg.append("g")
          .attr("class", "x axis")

        d3.select(".x.axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

  
        newSvg.append("g")
          .attr("class", "y axis")

        d3.select(".y.axis")
          .call(yAxis)
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("ECP");
  
        newSvg.append("path")
          .attr("class", "line1 line")

        d3.select(".line1")
          .datum(data)
          .attr("d", line);
  
        newSvg.append("path")
          .attr("class", "line2 line") 

        d3.select(".line2")
          .datum(data)
          .attr("d", line2);  
      }
  
      c.build = function(target,filters,data){
        if (filters) c.buildFilters(target,filters)
        c.buildTimeseries(d3.select(".container"),data,"t")
      }
  
      return c
        
    })({})
  
     
  
  
  controller.init()
  
  
  

  </script>
 

</head>

<body>

<div class="container">
  <h1>Availability</h1>
  <div id="filterable"></div>


</div>
</body>

{% end %}   
