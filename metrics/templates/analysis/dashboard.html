{% extends "base.html" %}
{% block scripts_top %}
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic%7CUbuntu:300,300italic,400,400italic,500,500italic,700,700italic%7CInconsolata:400,400italic,700,700italic%7CLato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic">
<link type="text/css" rel="stylesheet" href="/static/js/chosen/chosen.min.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap.min.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/fonts.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap-switch.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/bootstrap-select.css"/>

<link type="text/css" rel="stylesheet" href="/static/css/style.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/font-awesome.min.css"/>

<script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.min.js"></script>

<script type="text/javascript" src="/static/js/bootstrap-select.js"></script>


<script type="text/javascript" src="/static/js/d3.js" charset="utf-8"></script>

<script type="text/javascript" src="/js/start/build/start.js"></script>
<script type="text/javascript" src="/js/filter/build/filter.js"></script>
<script type="text/javascript" src="/js/table/build/table.js"></script>
<script type="text/javascript" src="/js/media_plan/build/media_plan.js"></script>
<script type="text/javascript" src="/js/dashboard/build/dashboard.js"></script>
<script type="text/javascript" src="/js/state/build/state.js"></script>
<script type="text/javascript" src="/js/tabular/build/tabular.js"></script>

<script type="text/javascript" src="/js/selectize.js/dist/js/standalone/selectize.js"></script>
<link type="text/css" rel="stylesheet" href="/js/selectize.js/dist/css/selectize.css"/>



<script type="text/javascript" src="/static/js/rockerbox/crusher/sidebar.js"></script>

<script type="text/javascript" src="/static/js/rockerbox/routes/routes.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/routes/routes.navigation.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/menu/menu.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/menu/menu.navbar.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/menu/menu.selectbar.js"></script>

<script type="text/javascript" src="/static/js/rockerbox/helper.js"></script>






<script type="text/javascript">
  /*
    Google analytics
  */
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50457693-2', 'auto');
  ga('send', 'pageview');
</script>
{% end %}
{% block scripts_bottom %}{% end %}
{% block content %}
<div class="hidden" style="position:fixed;width:200px;top:0px;left:0px;height:100%;background:black">
  <div class="row col-md-12">
    <a href="/crusher/funnel/action?source=baublebar">Action</a>
  </div>
  <div class="row col-md-12">
    <a href="/crusher/funnel?source=baublebar">Funnel</a>
  </div>
</div>
<div class="container" style="width:inherit"></div>
<style>
.inner > select, .inner > input {
  height: 36px;
  vertical-align:top
}
.selectize-control.multi {
  display: inline-block
}
.selectize-dropdown.multi {
  padding:5px;
}
</style>

<style>


  .inner .header-wrap, .inner select { flex: 1}

  .head-wrap {
    height: 150px;
    border-bottom:1px solid #ddd
  }
  .body-wrap {
    overflow:hidden
  }
  .head-wrap .item, .body-wrap .item {
    display:table-cell;
    width:50px;
    height:50px;
    position:relative;
    vertical-align:top
  }

  .head-wrap .item {
    display:table-cell;
    width:50px;
    height:150px;
    position:relative
  }

  .tabular-wrapper {
    width:900px
  }

  .head-wrap .item span {
    transform: rotate(-45deg);
    display: block;
    position: absolute;
    bottom: 50px;
    width: 155px;
    text-transform: uppercase;
    font-size: .85em;
    font-weight: normal;
    border-bottom: solid 1px #DDD;
    line-height: 30px;
    right: -120px;
  }
  .versus {

    margin-top:10px;
    margin-right:10px;
    display:inline-block;

    padding:10px;
    border-radius:10px;
    border: 1px solid #ccc;
  }
  a.versus:hover {
    text-decoration:none;

  }

  .versus.selected, .square.selected {
    background-color:white
  }

  .axis { opacity:.7 }
</style>
<script>
(function() {


  RB.menu.routes.roots = [
      {
        "name": "Filter",
        "push_state": "/crusher/dashboard",
        "class": "glyphicon glyphicon-filter",
      }, {
        "name": "Compare",
        "push_state": "/crusher/comparison",
        "class": "glyphicon glyphicon-th",
      }, {
        "name": "Create Segment",
        "push_state": "/crusher/action/recommended",
        "class": "glyphicon glyphicon-plus",
      }, {
        "name": "Settings",
        "push_state": "/crusher/settings",
        "class": "glyphicon glyphicon-cog"
      }
    ]
  RB.menu.render(d3.select("body"),true)

  var centered = d3_updateable(d3.select(".container"),"div","div")
    .style("width","1000px")
    .style("margin-left","auto")
    .style("margin-right","auto")

  var deepcopy = function(x) {
    return JSON.parse(JSON.stringify(x))
  } 

  function buildCategories(value) {
    var categories = d3.nest()
      .key(function(x){ return x.parent_category_name})
      .rollup(function(v) {
        return v.reduce(function(p,c) { return p + c.uniques },0)
      })
      .entries(value.full_urls)

    var total = categories.reduce(function(p,c) { return p + c.values },0)

    categories.map(function(x) {
      x.value = x.values
      x.percent = x.value / total
    })

    value["display_categories"] = {
        "key":"Categories"
      , "values": categories.filter(function(x) { return x.key != "NA" })
    }
  }

  function buildCategoryHour(value) {
    var category_hour = d3.nest()
      .key(function(x){ return x.parent_category_name + x.hour + x.minute})
      .rollup(function(v) {
        return {
            "parent_category_name": v[0].parent_category_name
          , "hour": v[0].hour
          , "minute": v[0].minute 
          , "count":v.reduce(function(p,c) { return p + c.count },0)
        }
      })
      .entries(value.full_urls)
      .map(function(x) { return x.values })

    value["category_hour"] = category_hour
   
  }

  function prepareFilters(filters) {

    var mapping = {
        "Category": "parent_category_name"
      , "Title": "url"
      , "Time": "hour"
    }

    var filters = filters.filter(function(x) { return Object.keys(x).length && x.value }).map(function(z) {
      return { 
          "field": mapping[z.field]
        , "op": z.op
        , "value": z.value
      }
    })

    return filters

  }

  var ops = {
      "is in": function(field,value) {
          return function(x) {
            var values = value.split(",")
            return values.reduce(function(p,value) { return p + String(x[field]).indexOf(String(value)) > -1 }, 0) > 0
          } 
        }
    , "is not in": function(field,value) {
          return function(x) {
            var values = value.split(",")
            return values.reduce(function(p,value) { return p + String(x[field]).indexOf(String(value)) > -1 }, 0) == 0
          } 
        }
     , "does not contain": function(field,value) {
          return function(x) {
            var values = value.split(",")
            return values.reduce(function(p,value) { return p + String(x[field]).indexOf(String(value)) > -1 }, 0) == 0
          } 
        }
      , "contains": function(field,value) {
          return function(x) {
            var values = value.split(",")
            return values.reduce(function(p,value) { return p + String(x[field]).indexOf(String(value)) > -1 }, 0) > 0
          } 
        }
  }

  var s = state.state()
    .subscribe("filter.tabs", function(error,dbo,state) {
      s.publishStatic("formatted_data",state.data)
    })
    .subscribe("filter.dashboard_options", function(error,dbo,state) {
      s.publishStatic("formatted_data",state.data)
    })
    .subscribe("filter.logic_options", function(error,filters,state) {
      s.publish("filters",state.filters)
    })
    .subscribe("filter.filters", function(error,filters,state) {

      var value = state.data
      if (value == undefined) return

      var filters = prepareFilters(filters)

      var logic = state.logic_options.filter(function(x) { return x.selected })
      logic = logic.length > 0 ? logic[0] : state.logic_options[0]

      var full_urls = filter
        .filter_data(value.original_urls)
        .op("is in", ops["is in"])
        .op("is not in", ops["is not in"])
        .op("does not contain", ops["does not contain"])
        .op("contains", ops["contains"])
        .logic(logic.value)
        .by(filters)


      







      // should not filter if...
//debugger

      if ( (value.full_urls) && 
           (value.full_urls.length == full_urls.length) && 
           (state.selected_comparison && (state.comparison_data == value.comparison))) return

      value.full_urls = full_urls

      var compareTo = state.comparison_data ? state.comparison_data.original_urls : value.original_urls;

      value.comparison = compareTo

      // all this logic should be move to the respective views...

      // ----- START : FOR MEDIA PLAN ----- //

      buildCategories(value)
      buildCategoryHour(value)

      // ----- END : FOR MEDIA PLAN ----- //

      var tabs = [
          dashboard.buildDomains(value)
        , dashboard.buildUrls(value)
        , dashboard.buildTopics(value)
      ]

      var summary_data = dashboard.buildSummaryData(value.full_urls)
        , pop_summary_data = dashboard.buildSummaryData(compareTo)

      var summary = dashboard.buildSummaryAggregation(summary_data,pop_summary_data)

      var ts = dashboard.prepData(value.full_urls)
        , pop_ts = dashboard.prepData(compareTo)

      var mappedts = ts.reduce(function(p,c) { p[c.key] = c; return p}, {})

      var prepped = pop_ts.map(function(x) {
        return {
            key: x.key
          , hour: x.hour
          , minute: x.minute
          , value2: x.value
          , value: mappedts[x.key] ?  mappedts[x.key].value : 0
        }
      })

      var cat_roll = d3.nest()
        .key(function(k) { return k.parent_category_name })
        .rollup(function(v) {
          return v.reduce(function(p,c) {
            p.views += c.count
            p.sessions += c.uniques
            return p
          },{ articles: {}, views: 0, sessions: 0})
        })
        .entries(value.full_urls)

      var pop_cat_roll = d3.nest()
        .key(function(k) { return k.parent_category_name })
        .rollup(function(v) {
          return v.reduce(function(p,c) {
            p.views += c.count
            p.sessions += c.uniques
            return p
          },{ articles: {}, views: 0, sessions: 0})
        })
        .entries(compareTo)

      var mapped_cat_roll = cat_roll.reduce(function(p,c) { p[c.key] = c; return p}, {})

      var cat_summary = pop_cat_roll.map(function(x) {
        return {
            key: x.key
          , pop: x.values.views
          , samp: mapped_cat_roll[x.key] ? mapped_cat_roll[x.key].values.views : 0
        }
      }).sort(function(a,b) { return b.pop - a.pop})
        .filter(function(x) { return x.key != "NA" })

      var parseWords = function(p,c) {
        var splitted = c.url.split(".com/")
        if (splitted.length > 1) {
          var last = splitted[1].split("/").slice(-1)[0].split("?")[0]
          var words = last.split("-").join("+").split("+").join("_").split("_").join(" ").split(" ")
          words.map(function(w) { 
            if ((w.length <= 4) || (String(parseInt(w[0])) == w[0] ) || (w.indexOf("asp") > -1) || (w.indexOf("php") > -1) || (w.indexOf("html") > -1) ) return
            p[w] = p[w] ? p[w] + 1 : 1
          })
        }
        return p
      }

      var pop_counts = compareTo.reduce(parseWords,{})
      var samp_counts = value.full_urls.reduce(parseWords,{})


      var entries = d3.entries(pop_counts).filter(function(x) { return x.value > 1})
        .map(function(x) {
          x.samp = samp_counts[x.key]
          x.pop = x.value
          return x
        })
        .sort(function(a,b) { return b.pop - a.pop})
        .slice(0,25)


      var modifyWithComparisons = function(ds) {

        var aggs = ds.reduce(function(p,c) {
          p.pop_max = (p.pop_max || 0) < c.pop ? c.pop : p.pop_max
          p.pop_total = (p.pop_total || 0) + c.pop

          if (c.samp) {
            p.samp_max = (p.samp_max || 0) > c.samp ? p.samp_max : c.samp
            p.samp_total = (p.samp_total || 0) + c.samp
          }

          return p
        },{})

        console.log(aggs)

        ds.map(function(o) {
          o.normalized_pop = o.pop / aggs.pop_max
          o.percent_pop = o.pop / aggs.pop_total

          o.normalized_samp = o.samp / aggs.samp_max
          o.percent_samp = o.samp / aggs.samp_total

          o.normalized_diff = (o.normalized_samp - o.normalized_pop)/o.normalized_pop
          o.percent_diff = (o.percent_samp - o.percent_pop)/o.percent_pop
        })
      }

      modifyWithComparisons(cat_summary)
      modifyWithComparisons(entries)


      if (value.before) {
        var before_urls = filter
          .filter_data(value.before)
          .op("is in", ops["is in"])
          .op("is not in", ops["is not in"])
          .op("does not contain", ops["does not contain"])
          .op("contains", ops["contains"])
          .logic(logic.value)
          .by(filters)

        var after_urls = filter
          .filter_data(value.after)
          .op("is in", ops["is in"])
          .op("is not in", ops["is not in"])
          .op("does not contain", ops["does not contain"])
          .op("contains", ops["contains"])
          .logic(logic.value)
          .by(filters)


        var bu = d3.nest()
          .key(function(x) { return x.parent_category_name })
          .key(function(x) { return x.time_diff_bucket })
          .entries(before_urls)

        var au = d3.nest()
          .key(function(x) { return x.parent_category_name })
          .key(function(x) { return x.time_diff_bucket })
          .entries(after_urls)


        s.publishStatic("before_urls",{"after":after_urls,"before":before_urls,"category":cat_summary}) 
        s.publishStatic("after_urls", after_urls)


      }

      

      s.publishStatic("keyword_summary", entries) 
      s.publishStatic("time_summary", prepped)
      s.publishStatic("category_summary", cat_summary)

      s.publishStatic("summary",summary)
      s.publishStatic("tabs",tabs)
      s.publishStatic("formatted_data",value)
      
    })
    .subscribe("filter.formatted_data", function(error,formatted_data,value) {


      if (value.formatted_data) dashboard.new_dashboard(centered)
        .data(value.formatted_data)
        .actions(value.actions)
        .summary(value.summary)
        .time_summary(value.time_summary)
        .category_summary(value.category_summary)
        .keyword_summary(value.keyword_summary)
        .before(value.before_urls || [])
        .after(value.after_urls || [])

        .logic_options(value.logic_options)
        .logic_categories(value.logic_categories)
        .filters(value.filters)
        .view_options(value.dashboard_options)
        .explore_tabs(value.tabs)
        .on("action.change", function(action) {
          s.publish("selected_action",action)
        })
        .on("comparison.change", function(action) {
          s.publish("selected_comparison",action)
        })

        .on("logic.change", function(logic) {
          s.publish("logic_options",logic)
        })
        .on("filter.change", function(filters) {
          s.publish("filters",filters)
        })
        .on("view.change", function(x) {
          var CP = deepcopy(value.dashboard_options)
          CP.map(function(d) {
            if (x.value == d.value) return d.selected = 1
            d.selected = 0
          })
          s.publish("dashboard_options",CP)
        })
        .on("tab.change", function(x) {
          value.tabs.map(function(t) {
            if (t.key == x.key) return t.selected = 1
            t.selected = 0
          })
          s.publishStatic("tabs",value.tabs)
        })
        .draw()

    })
    .subscribe("raw.data",function(error,value,state) {

      value.actions = state.actions
      s.publishStatic("logic_categories",value.categories)
      s.publish("filters",state.filters)

    })
    .subscribe("raw.comparison_data",function(error,value,state) {

      s.publish("filters",state.filters)

    })
    .subscribe("raw.actions",function(error,value,state) {

      value.map(function(x) { x.key = x.action_name; x.value = x.action_id })
      s.publish("selected_action",value[0])
    })
    .subscribe("raw.selected_action",function(error,value) {
      s.publishStatic("data",asyncPub.bind(false,value))
    })
    .subscribe("raw.selected_comparison",function(error,value) {
      s.publishStatic("comparison_data",asyncPub.bind(false,value))
    })




  var asyncPub = function(action,cb){
    var URL = "/crusher/v2/visitor/domains_full_time_minute/cache?url_pattern=" + action.url_pattern[0] + "&filter_id=" + action.action_id


    d3.json(URL,function(value) {

      var categories = value.summary.category.map(function(x) {x.key = x.parent_category_name; return x})
      value.categories = categories
      value.category = value.summary.category
      value.current_hour = value.summary.hour
      value.category_hour = value.summary.cross_section

      value.original_urls = value.response
      //value.full_urls = value.response

debugger

      cb(false,value)
    })
  }

  var actionPub = function(cb) {
    d3.json("/crusher/funnel/action?format=json",function(value) {
      cb(false,value.response)
    })
  }

  s.publishStatic("actions",actionPub)
  //s.publishStatic("data",asyncPub)
  var SELECTION_STATES = [
        {"key":"Data summary","value":"summary-view","selected":1}
      , {"key":"Explore data","value":"data-view","selected":0}
      , {"key":"Media Plan", "value":"media-view","selected":0}
      //, {"key":"Build Content Brief", "value":"content-view"}
    ]


  var logic = [{"key":"All","value":"and"},{"key":"Any","value":"or"}]
  var categories = []
  var filters = [{}]

  s.publish("logic_options",logic)
  s.publish("logic_categories",categories)
  s.publish("filters",filters)
  s.publish("dashboard_options",SELECTION_STATES)

  window.s = s


})();
</script>


{% end %}
