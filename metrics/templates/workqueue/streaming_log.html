{% autoescape None %}

{% block page_header %}Work Queue Log{% end %}

<div id='messages'>

</div>

<script src="/static/js/jquery.min.js"></script>

<script>
new function() {
    var ws = null;
    var connected = false;

    var serverUrl;
    var connectionStatus;
    var sendMessage;
    
    var connectButton;
    var disconnectButton; 
    var sendButton;

    var open = function() {
        //var url = 'ws://192.168.99.100:8888/admin/websocket?id=154'
        var url = 'ws://portal.getrockerbox.com/admin/websocket?id=1776';
        ws = new WebSocket(url);
        ws.onopen = onOpen;
        ws.onclose = onClose;
        ws.onmessage = onMessage;
        ws.onerror = onError;
    }
    
    var close = function() {
        if (ws) {
            console.log('CLOSING ...');
            ws.close();
        }
        connected = false;
    }
    
    var clearLog = function() {
        $('#messages').html('');
    }
    
    var onOpen = function() {
        console.log('OPENDD')
        connected = true;
        var msg = 'initialize';
        addMessage(msg, 'SENT');
        ws.send(msg);
        var msg = 'start';
        addMessage(msg, 'SENT');
        ws.send(msg);
        var msg = '{"streams":["hindsight_log"]}'
        addMessage(msg, 'SENT');
        ws.send(msg)
    };
    
    var onClose = function() {
        console.log('CLOSED: ' + serverUrl.val());
        ws = null;
    };
    
    var onMessage = function(event) {
        var data = event.data;
        if (String(data).indexOf('workqueue') !== -1){
            addMessage(data);
        }
    };
    
    var onError = function(event) {
        alert(event.data);
    }
    
    var addMessage = function(data, type) {
        var msg = $('<pre>').text(data);
        if (type === 'SENT') {
            msg.addClass('sent');
        }
        var messages = $('#messages');
        messages.append(msg);
        
        var msgBox = messages.get(0);
        while (msgBox.childNodes.length > 1000) {
            msgBox.removeChild(msgBox.firstChild);
        }
        msgBox.scrollTop = msgBox.scrollHeight;
    }

    WebSocketClient = {
        init: function() {
            close();
            open();

        }
    };
}

$(function() {
    WebSocketClient.init();
});
</script>

