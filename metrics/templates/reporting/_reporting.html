{% autoescape None %}
{% extends "../base.html" %}

{% block page_title %}Reporting{% end %}
{% block page_header %}Campaign overview{% end %}

{% block page_css %}
	<link href="/static/css/reporting-style.css" type="text/css" rel="stylesheet" media="screen">
	<link href="/static/css/dc.css" type="text/css" rel="stylesheet" media="screen">
  <style>
    .campaign {cursor:pointer}
    .active-row {font-weight:bold}
    .expansion {
      display:none;
      padding-top:10px;padding-bottom:10px;
      border-top:1px solid rgb(221, 221, 221);
      background:#f0f0f0
    }
    .expansion div div div {background:white}
    .active-row .expansion {display:block}
    .shadow{
      inset 0px 11px 8px -10px #CCC,
      inset 0px -11px 8px -10px #CCC; 
    }
    .row {
      margin-right: -10px;
      margin-left: -10px;
    }
    .col-lg-1, .col-lg-10, .col-lg-11, .col-lg-12, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-md-1, .col-md-10, .col-md-11, .col-md-12, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-sm-1, .col-sm-10, .col-sm-11, .col-sm-12, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-xs-1, .col-xs-10, .col-xs-11, .col-xs-12, .col-xs-2, .col-xs-3, .col-xs-4, .col-xs-5, .col-xs-6, .col-xs-7, .col-xs-8, .col-xs-9 {
      padding-left:10px;
      padding-right:10px
    }
  </style>
{% end %}

{% block page_sidebar %}
	<li class="active"><a href="/reporting"><img src="/static/img/sidebar/reporting-icon.png" alt="Reporting icon" /><span class="sidebar-label">campaign reporting</span></a></li>
    <li><a href="/streaming"><img src="/static/img/sidebar/global-icon.png" alt="Global icon" /><span class="sidebar-label">global streaming</span></a></li>
    <li><a href="/creative/reporting"><img src="/static/img/sidebar/creative-icon.png" alt="Creatives icon" /><span class="sidebar-label">creative reporting</span></a></li>
    <li><a href="/advertiser"><img src="/static/img/sidebar/pixel-icon.png" alt="Pixels icon" /><span class="sidebar-label">pixels</span></a></li>
 <li >
    <a href="/campaign" style="padding:0px;position:relative">
      <div style="opacity:.6;text-align:center;width:50px;line-height:50px;font-size:20px;color:white" class="glyphicon glyphicon-th-list"></div>
      <span class="sidebar-label" style="top:0px;margin-top:0px"> campaign manager</span>
    </a>
  </li>

  <li>
    <a href="/pixel" style="padding:0px;position:relative">
      <div style="opacity:.6;text-align:center;width:50px;line-height:50px;font-size:20px;color:white" class="glyphicon glyphicon glyphicon-star"></div>
      <span class="sidebar-label" style="top:0px;margin-top:0px"> pixel reporting</span>
    </a>
  </li>  
<!--
	<li><a href="global"><img src="/static/img/sidebar/global-icon.png" alt="Global icon" /><span class="sidebar-label">global streaming</span></a></li>
	
	<li><a href="intraweek"><img src="/static/img/sidebar/intraweek-icon.png" alt="Intraweek icon" /><span class="sidebar-label">intraweek overview</span></a></li>
	-->
{% end %}

{% block page_content %}

	<div id="campaign-box" class="box three-quarters-box">
	</div>	

	<div class="clearfix"></div>	
	<div id="campaign-graph-box" class="box three-quarters-box">
		<div id="campaign-graph"></div>
		<div id="campaign-slider">
			<!--<div class="outer-interval-select"><ul class="interval-select"><li>day</li><li class="interval-active">week</li><li>month</li></ul></div>-->
		</div>
	</div>
	<div id="filter-box" class="box quarter-box">
		<div id="graph-interval">
			<div id="interval-title">current interval <span id="outer-interval-reset">| <span id="interval-reset">reset</span></span></div>
			<div id="current-interval"></div>
		</div>
		<div id="filter-options">
			<div class="box-title">Display</div>
			<div class="box-subtitle">Metric</div>
			<ul id="filter-metric">
				<li class="filter-metric-active"><img src="/static/img/general/checked-radio.png" alt="Checked radio button" />imps</li>
				<li><img src="/static/img/general/unchecked-radio.png" alt="Unchecked radio button" />clicks</li>
				<li><img src="/static/img/general/unchecked-radio.png" alt="Unchecked radio button" />conversions</li>
				<li><img src="/static/img/general/unchecked-radio.png" alt="Unchecked radio button" />cost</li>
			</ul>
	
		</div>
		<!--<div id="export-box">export data to csv<img src="" alt="Export image" /></div>-->
    <div id="download-buttons-box">
      <div id="download-buttons-content">
      <div id="download-buttons-list" class="outer-interval-select">download as:<ul class="interval-select"><li><a href="/reporting?format=json&export=1&download=1">json</a></li><li><a href="/reporting?format=csv&export=1&download=1">csv</a></li></ul></div>
            <!--
        <div id="download-buttons-header">download as:</div>
        <div id="download-buttons-buttons"><a href="/reporting?format=json&export=1&download=1">JSON</a><span></span><a href="/reporting?format=csv&export=1&download=1">CSV</a></div>
        -->
      </div>
    </div>
	</div>
	<div class="clearfix"></div>
	<div id="campaign-reports-box" class="box full-box">
		<div class="outer-interval-select">sort by<ul class="interval-select"><li>day</li><li class="interval-active">week</li><li>month</li><!--<li>insertion order</li>--></ul></div>
		<div class="box-title">Campaign reports</div>
		<div id="campaign-reports-table" class="content-table">
			<ul id="reports-header" class="header-row"><li class="reports-date"></li><li class="reports-impressions">impressions</li><li class="reports-thin-small">cpm</li><li class="reports-clicks">clicks</li><li class="reports-conversions">conversions</li><li class="reports-thin-small">cpa</li><li class="reports-cost">total cost</li></ul>		
		</div>
		<div class="show-more">show more</div>
	</div>
  <div id="footer">*Note: Media cost and CPMs are computed weekly. Recent numbers may read as null (showing "-") until the start of the week.</div>
	<div class="clearfix"></div>
{% end %}

{% block page_scripts %}
	<!-- IO GAUGE -->
  <script src="/static/js/d3.v3.min.js"></script> 
  <script src="/static/js/rockerbox/ajax.js"></script>
	<script src="/static/js/rockerbox/data.js"></script> 
  <script src="/static/js/rockerbox/portal/ui.campaign.js"></script>
	<script src="/static/js/gauge.min.js"></script>
	
	<script src="/static/js/crossfilter.min.js"></script>
	<script src="/static/js/dc.mod.js"></script>
	<script src="/static/js/reporting.js"></script>
	<script src="/static/js/reporting-functions.js"></script>
  <script src="/static/js/mixpanel.js"></script>
  <script>
    addMixpanelEvent({{ advertiser_id }}, "{{ user_id }}", "load reporting");
  </script>
	<script>					
		// FORMAT DATE BASED ON DISPLAY MODE
		function createDateValue(dateMode, firstDate){
			if(dateMode == "date-day") return formatDate(firstDate);
			else if(dateMode == "date-week"){
                var endOfWeek = addDays(firstDate, 6);
                if(endOfWeek > CRS.groups.all.summary().date_max) endOfWeek.setTime(CRS.groups.all.summary().date_max.getTime());
				return formatDate(firstDate) + " - " + formatDate(endOfWeek);
			}
			else if(dateMode == "date-month"){
				return formatMonth(firstDate);
			}
		}
		
        // GET TIME DIFFERENCE BETWEEN TWO DATES
        function timeDifference(startDate, endDate){
            return (endDate.getTime() - startDate.getTime()) / 1000 / 60 / 60 / 24;
        }
        
		// INITIALISE TABLES
		var campaignTable = null, campaignReportsTable = null, sliderGraph = null, mainGraph = null;
		
		var extUserID =  {{ advertiser_id }};
		
		var userBudget = 0, userSpent = 0;

    //changes where the selector is on the graph. note that the campaign buckets list above will change to the selection!
    var dt = new Date();
    var ioStartDate = dt.setMonth(dt.getMonth()-3);
    ioStartDate = new Date(ioStartDate);
        
		// GET ADVERTISER BUDGET AND PROGRESS       

		$.getJSON("/api?table=advertiser&external_advertiser_id=" + extUserID, function(data){
      $('#header #right-align #user-name').text(data[0].advertiser_name.toLowerCase());
    });

    RB.portal.data.reporting(function(data){


      var crs = crossfilter(data);
      window.CRS = crossfilterNS(crs, dc);
      console.log(CRS)

      RB.portal.UI.campaign_bucket.buildPanel(CRS,d3.select("#campaign-box"))

      //buildBucketReporting(CRS,d3.select("#campaign-box"))
      campaignReportsTable = dc.customDataTable('#campaign-reports-table', "reports-group")

      var currentCampaign = "Campaign total";
      updateCampaignReports(
        $('#campaign-reports-box .outer-interval-select .interval-select .interval-active').text(), 
        currentCampaign
      );
      dc.renderAll("reports-group");
      
      
      var currentMetric = $('#filter-box #filter-options #filter-metric li.filter-metric-active').text();
      $('#campaign-graph-box').addClass("data-metric-" + currentMetric);
          
      /*// GENERATE SLIDER GRAPH
      sliderGraph = dc.lineChart('#campaign-slider', "graph-group")
        .dimension(CRS.dimensions.daily)
        .group(CRS.groups.daily)
        .height(48)
        .width(843)
        .renderArea(true)
        .elasticY(true)
        .margins({top: 0, right: 0, bottom: 0, left: 0})
        .yAxisPadding("25%")
        .round(d3.time.day.round)
        .xUnits(d3.time.days)
        .valueAccessor(function(d){					
            if(currentMetric == "clicks") return d.value.clicks;
            else if(currentMetric == "conversions") return d.value.conversions;
            else if(currentMetric == "cost") return d.value.cost;
            return d.value.imps;
        })
        // .y(d3.scale.log().nice().domain([impsMin, impsMax]))
        .x(d3.time.scale().domain([
            CRS.groups.all.summary().date_min,
            CRS.groups.all.summary().date_max
        ]))
        .on("preRedraw", function(){
            CRS.dimensions.datetime.filterAll();
        })
      
      sliderGraph.xAxis().ticks(8).tickFormat(d3.time.format("%m/%d"));
      
      
      // GENERATE MAIN GRAPH
      mainGraph = dc.lineChart('#campaign-graph', "graph-group")
        .dimension(CRS.dimensions.datetime)
        .group(CRS.groups.datetime)
        .tooltipType("daily")
        .height(328)
        .width(843)
        .margins({top: 0, right: 0, bottom: 0, left: 0})
        .elasticY(true)
        .renderArea(true)
        .yAxisPadding("25%")
        .round(d3.time.day.round)
        .xUnits(d3.time.days)
        .valueAccessor(function(d){
            return d.value[currentMetric || "imps"]
        })
        .x(d3.time.scale().domain([
            CRS.groups.all.summary().date_min,
            CRS.groups.all.summary().date_max
        ]))
        .renderHorizontalGridLines(true)
        .brushOn(false)
        .renderTitle(true)
        .rangeChart(sliderGraph)
        .on("preRedraw", function(){
          var intervalLength = timeDifference(
            CRS.groups.all.summary().date_min, 
            CRS.groups.all.summary().date_max
          );

          var tooltipType = (intervalLength < 14) ? "hourly" : "daily",
            dimensionType = (intervalLength < 14) ? "datetime" : "daily",
            group = CRS.groups[dimensionType],
            dimension = CRS.dimensions[dimensionType],
            tickFormat = (intervalLength <= 1) ? d3.time.format("%I%p") : d3.time.format("%m/%d");

          mainGraph.dimension(dimension).group(group).tooltipType(tooltipType)
          mainGraph.xAxis().tickFormat(tickFormat)
        });
      
      mainGraph.yAxis().ticks(5);
      mainGraph.xAxis().tickFormat(d3.time.format("%m/%d"));
      */
      
      
      dc.renderAll("graph-group");
      
      // SET TIME INTERVAL
      var baseInterval = formatDate(ioStartDate) + " - " + formatDate(CRS.groups.all.summary().date_max);

      
      intervalBox = dc.customDataBox('.interval-span, #filter-box #graph-interval #current-interval', "graph-group")
      .valueAccessor(function(d){
          var dateMin = formatDate(d.date_min), dateMax = formatDate(d.date_max);
          if(dateMin == dateMax) return dateMin;
          return dateMin + " - " + dateMax;
      })
      .group(CRS.groups.all)
      .on("postRedraw", function(){
          if(intervalBox.value() != baseInterval){
              $('#graph-interval #interval-title #outer-interval-reset').fadeIn();
          }
          else {
              $('#graph-interval #interval-title #outer-interval-reset').fadeOut();
          }
      });				
      
      var campaignGraphPos = $('#campaign-graph').position();

      //mainGraph.focus([ioStartDate, CRS.groups.all.summary().date_max])

      try {
        if(ioStartDate < CRS.groups.all.summary().date_min){
          ioStartDate = new Date(CRS.groups.all.summary().date_min.getTime());
           //mainGraph.focus([ioStartDate, CRS.groups.all.summary().date_max]);
           baseInterval = formatDate(ioStartDate) + " - " + formatDate(CRS.groups.all.summary().date_max);
           intervalBox.redraw();                   
        }     
      } catch(e) {}
      
      // HACKHACKHACK
      //$('#io-completion-box #io-progress #io-estimated-spent').text(formatMoney(CRS.groups.all.value().cost) + "*");
      $('#page-loader').fadeOut();
    });		
	</script>
	<script>		
		// SWITCH CAMPAIGN FOCUS
		
		
		// SWITCH REPORTING MODE ON CLICK
		$('#campaign-reports-box .outer-interval-select .interval-select li').on("click", function(){
			if(!$(this).hasClass('interval-active')){
				$(this).siblings('.interval-active').removeClass('interval-active');
				$(this).addClass('interval-active');
				
				var currentCampaign = $('.active-row .campaign-name-no-style').text();
				if(currentCampaign == "Campaign total"){
					CRS.dimensions.total_campaign_bucket.filterAll();
				}
				else {
					CRS.dimensions.total_campaign_bucket.filter(function(d){return d == currentCampaign});
				}		
				
				updateCampaignReports($(this).text(), currentCampaign);
				
				$('#campaign-reports-table').fadeOut(250, "linear", function(){
					campaignReportsTable.redraw();
				});			
			}
		});
		
		// IF SHOW MORE ON CAMPAIGN REPORTS
		$('#campaign-reports-box .show-more').click(function(){			
        
			var currentCampaign = $('#campaign-table .campaign-row.active-row .campaign-name-no-style').text();
			if(currentCampaign == "Campaign total"){
				CRS.dimensions.total_campaign_bucket.filterAll();
			}
			else {
				CRS.dimensions.total_campaign_bucket.filter(function(d){return d == currentCampaign});
			}		
			updateCampaignReports($('#campaign-reports-box .outer-interval-select .interval-select li.interval-active').text(), currentCampaign, Infinity);

			campaignReportsTable.redraw();		
		});
        
        // IF CLICK ON DATESPAN
		$('#campaign-reports-table').on("click", '.date-span', function(){			
            if($(this).parent().hasClass('date-day')){
                dc.filterAll("graph-group");
                var currentDate = new Date($(this).text());
                //mainGraph.focus([currentDate, addDays(currentDate, 1)])
                dc.redrawAll("graph-group");
            }
            else if($(this).parent().hasClass('date-week')){
                var currentWeek = $(this).text().split(" - ");
                dc.filterAll("graph-group");
                //mainGraph.focus([new Date(currentWeek[0]), addDays(new Date(currentWeek[1]), 1)])
                dc.redrawAll("graph-group");
            }
            else if($(this).parent().hasClass('date-month')){
                var currentMonth = new Date($(this).text());
                var monthEnd = new Date($(this).text());
                monthEnd.setMonth(monthEnd.getMonth() + 1);
                dc.filterAll("graph-group");
                //mainGraph.focus([currentMonth, monthEnd])
                dc.redrawAll("graph-group");
            }
		});
		
		// RESET DATE FILTER
		$('#interval-reset').click(function(){
			// CRS.dimensions.datetime.filterAll();
			//dc.filterAll("graph-group");
      //mainGraph.focus([ioStartDate, CRS.groups.all.summary().date_max])
			//dc.redrawAll("graph-group");
			// $(this).parent().fadeOut(500);
		});
		
		// CHANGE METRIC
		$('#filter-box #filter-options #filter-metric li').click(function(){
			if(!$(this).hasClass('filter-metric-active')){
				var currentMetric = $(this).text();
				$('#campaign-graph-box').removeClass('data-metric-' + $('#filter-box #filter-options #filter-metric li.filter-metric-active').text()).addClass("data-metric-" + currentMetric);

				/*
        mainGraph.valueAccessor(function(d){										
					if(currentMetric == "clicks") return d.value.clicks;
					else if(currentMetric == "conversions") return d.value.conversions;
					else if(currentMetric == "cost") return d.value.cost;
					return d.value.imps;
				});*/

				/*sliderGraph.valueAccessor(function(d){					
					if(currentMetric == "clicks") return d.value.clicks;
					else if(currentMetric == "conversions") return d.value.conversions;
					else if(currentMetric == "cost") return d.value.cost;
					return d.value.imps;
				});*/
				
				var currentCampaign = $('#campaign-table .campaign-row.active-row .campaign-name-no-style').text();
				if(currentCampaign == "Campaign total"){
					CRS.dimensions.total_campaign_bucket.filterAll();
				}
				else {
					CRS.dimensions.total_campaign_bucket.filter(function(d){return d == currentCampaign});
				}		
				
				if(currentMetric == "cost"){
					$('.tooltip').addClass('value-cost');
				}
				else $('.tooltip').removeClass('value-cost');
				
				$('#filter-box #filter-options #filter-metric li.filter-metric-active').removeClass('filter-metric-active').children('img').attr('src', '/static/img/general/unchecked-radio.png').attr('alt', 'Unchecked radio button');
				$(this).addClass('filter-metric-active').children('img').attr('src', '/static/img/general/checked-radio.png').attr('alt', 'Checked radio button');
				
				//sliderGraph.redraw();
				//mainGraph.redraw();
			}
		});
	</script>
{% end %}
