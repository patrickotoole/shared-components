{% autoescape None %}
{% extends "../base.html" %}

{% block page_title %}Reporting{% end %}
{% block page_header %}Campaign overview{% end %}

{% block page_css %}
	<link href="/static/css/reporting-style.css" type="text/css" rel="stylesheet" media="screen">
	<link href="/static/css/dc.css" type="text/css" rel="stylesheet" media="screen">
  <style>
    .active-row {font-weight:bold}
  </style>
{% end %}

{% block page_sidebar %}
	<li class="active"><a href="/reporting"><img src="/static/img/sidebar/reporting-icon.png" alt="Reporting icon" /><span class="sidebar-label">campaign reporting</span></a></li>
    <li><a href="/streaming"><img src="/static/img/sidebar/global-icon.png" alt="Global icon" /><span class="sidebar-label">global streaming</span></a></li>
    <li><a href="/creative/reporting"><img src="/static/img/sidebar/creative-icon.png" alt="Creatives icon" /><span class="sidebar-label">creative reporting</span></a></li>
    <li><a href="/advertiser"><img src="/static/img/sidebar/pixel-icon.png" alt="Pixels icon" /><span class="sidebar-label">pixels</span></a></li>
 <li >
    <a href="/campaign" style="padding:0px;position:relative">
      <div style="opacity:.6;text-align:center;width:50px;line-height:50px;font-size:20px;color:white" class="glyphicon glyphicon-th-list"></div>
      <span class="sidebar-label" style="top:0px;margin-top:0px"> campaign manager</span>
    </a>
  </li>

  <li>
    <a href="/pixel" style="padding:0px;position:relative">
      <div style="opacity:.6;text-align:center;width:50px;line-height:50px;font-size:20px;color:white" class="glyphicon glyphicon glyphicon-star"></div>
      <span class="sidebar-label" style="top:0px;margin-top:0px"> pixel reporting</span>
    </a>
  </li>  
<!--
	<li><a href="global"><img src="/static/img/sidebar/global-icon.png" alt="Global icon" /><span class="sidebar-label">global streaming</span></a></li>
	
	<li><a href="intraweek"><img src="/static/img/sidebar/intraweek-icon.png" alt="Intraweek icon" /><span class="sidebar-label">intraweek overview</span></a></li>
	-->
{% end %}

{% block page_content %}
<!--
	<div id="io-completion-box" class="box quarter-box">
		<div class="box-title">IO Progress</div>
		<div id="io-percentage-bar"><div id="io-percentage-bar-inner"></div></div>
		<canvas id="io-gauge"></canvas>
		<div id="io-progress"><span id="io-estimated-spent" title="Estimate">0</span><span id="io-budget"></span></div>
		<div id="io-remaining">spent/total</div>
	</div>
  -->
	<div id="campaign-box" class="box three-quarters-box">
		<!--<div id="campaign-table" class="content-table">
			<ul id="campaign-header" class="header-row">
				<li class="col-md-6">campaign</li>
        <li class="col-md-1 border-green">impressions</li>
        <li class="col-md-1 border-blue">clicks</li>
        <li class="col-md-1 border-red">conversions</li>
        <li class="col-md-1 border-orange">cost</li>
        <li class="col-md-1 ">viewable</li> 
        <li class="col-md-1 ">visits</li>  
			</ul>
    </div>-->
	</div>	

	<div class="clearfix"></div>	
	<div id="campaign-graph-box" class="box three-quarters-box">
		<div id="campaign-graph"></div>
		<div id="campaign-slider">
			<!--<div class="outer-interval-select"><ul class="interval-select"><li>day</li><li class="interval-active">week</li><li>month</li></ul></div>-->
		</div>
	</div>
	<div id="filter-box" class="box quarter-box">
		<div id="graph-interval">
			<div id="interval-title">current interval <span id="outer-interval-reset">| <span id="interval-reset">reset</span></span></div>
			<div id="current-interval"></div>
		</div>
		<div id="filter-options">
			<div class="box-title">Display</div>
			<div class="box-subtitle">Metric</div>
			<ul id="filter-metric">
				<li class="filter-metric-active"><img src="/static/img/general/checked-radio.png" alt="Checked radio button" />impressions</li>
				<li><img src="/static/img/general/unchecked-radio.png" alt="Unchecked radio button" />clicks</li>
				<li><img src="/static/img/general/unchecked-radio.png" alt="Unchecked radio button" />conversions</li>
				<li><img src="/static/img/general/unchecked-radio.png" alt="Unchecked radio button" />cost</li>
			</ul>
			<!--
			<div class="box-subtitle">Compare to</div>
			<select>
				<option>clicks</option>
				<option>conversions</option>
				<option>cost</option>
			</select>
			-->
		</div>
		<!--<div id="export-box">export data to csv<img src="" alt="Export image" /></div>-->
    <div id="download-buttons-box">
      <div id="download-buttons-content">
      <div id="download-buttons-list" class="outer-interval-select">download as:<ul class="interval-select"><li><a href="/reporting?format=json&export=1&download=1">json</a></li><li><a href="/reporting?format=csv&export=1&download=1">csv</a></li></ul></div>
            <!--
        <div id="download-buttons-header">download as:</div>
        <div id="download-buttons-buttons"><a href="/reporting?format=json&export=1&download=1">JSON</a><span></span><a href="/reporting?format=csv&export=1&download=1">CSV</a></div>
        -->
      </div>
    </div>
	</div>
	<div class="clearfix"></div>
	<div id="campaign-reports-box" class="box full-box">
		<div class="outer-interval-select">sort by<ul class="interval-select"><li>day</li><li class="interval-active">week</li><li>month</li><!--<li>insertion order</li>--></ul></div>
		<div class="box-title">Campaign reports</div>
		<div id="campaign-reports-table" class="content-table">
			<ul id="reports-header" class="header-row"><li class="reports-date"></li><li class="reports-impressions">impressions</li><li class="reports-thin-small">cpm</li><li class="reports-clicks">clicks</li><li class="reports-conversions">conversions</li><li class="reports-thin-small">cpa</li><li class="reports-cost">total cost</li></ul>		
		</div>
		<div class="show-more">show more</div>
	</div>
  <div id="footer">*Note: Media cost and CPMs are computed weekly. Recent numbers may read as null (showing "-") until the start of the week.</div>
	<div class="clearfix"></div>
{% end %}

{% block page_scripts %}
	<!-- IO GAUGE -->
	<script src="/static/js/gauge.min.js"></script>
	<script src="/static/js/d3.v3.min.js"></script>
	<script src="/static/js/crossfilter.min.js"></script>
	<script src="/static/js/dc.mod.js"></script>
	<script src="/static/js/reporting.js"></script>
	<script src="/static/js/reporting-functions.js"></script>
  <script src="/static/js/mixpanel.js"></script>
  <script>
    addMixpanelEvent({{ advertiser_id }}, "{{ user_id }}", "load reporting");
  </script>
	<script>					
		// FORMAT DATE BASED ON DISPLAY MODE
		function createDateValue(dateMode, firstDate){
			if(dateMode == "date-day") return formatDate(firstDate);
			else if(dateMode == "date-week"){
                var endOfWeek = addDays(firstDate, 6);
                if(endOfWeek > CRS.groups.all.summary().date_max) endOfWeek.setTime(CRS.groups.all.summary().date_max.getTime());
				return formatDate(firstDate) + " - " + formatDate(endOfWeek);
			}
			else if(dateMode == "date-month"){
				return formatMonth(firstDate);
			}
		}
		
        // GET TIME DIFFERENCE BETWEEN TWO DATES
        function timeDifference(startDate, endDate){
            return (endDate.getTime() - startDate.getTime()) / 1000 / 60 / 60 / 24;
        }
        
		// INITIALISE TABLES
		var campaignTable = null, campaignReportsTable = null, sliderGraph = null, mainGraph = null;
		
		var extUserID =  {{ advertiser_id }};
		
		var userBudget = 0, userSpent = 0;

    //changes where the selector is on the graph. note that the campaign buckets list above will change to the selection!
    var dt = new Date();
    var ioStartDate = dt.setMonth(dt.getMonth()-3);
    ioStartDate = new Date(ioStartDate);
        
		// GET ADVERTISER BUDGET AND PROGRESS       

		$.getJSON("/api?table=advertiser&external_advertiser_id=" + extUserID, function(data){
          $('#header #right-align #user-name').text(data[0].advertiser_name.toLowerCase());
    });

            // GET DATA
            var getUserData = $.getJSON("/api?deleted=0&active=1&table=campaign_bucket&external_advertiser_id=" + extUserID).done(function(e){
                var buckets = {};

                $.each(e, function(index, bucket){
                    buckets[bucket.campaign_id] = bucket;
                });

                /*
                var data_link = window.location.origin + window.location.pathname;
                data_link += window.location.search.length ? window.location.search : "?";
    */
                d3.json("/reporting?format=json",function(data){
                    window.data = data;

                    // INITIAL DATA TREATMENT AND FORMATTING
                    $.each(data, function(key, d){
                        var name = "Default Campaign";
                        
                        try {
                            name = buckets[d.campaign_id]['bucket_name'];
                        }
                        catch(e) {}
                        
                        d.campaign_bucket = name;
                        d.campaign_id = d.campaign_id;
                        d.dd = new Date(d.date * 1000);
                        d.imps = +d.imps;
                        d.clicks = +d.clicks;
                        d.conversions = +d.is_valid;
                        d.cost = d.media_cost * d.cpm_multiplier;
                        
                        /*d.domain = 0;
                        d.referrer = 0;*/
                    });

                    // INSTANTIATE CROSSFILTER
                    var crs = crossfilter(data);
                    window.CRS = crossfilterNS(crs, dc);
                  
                    
                    
                    // GENERATE CAMPAIGN BOX CONTENT
                    var prevQty = 0;
                    var totalDimension = CRS.groups.all.value();
                    totalDimension['campaign_bucket'] = "Campaign total";

                    var topData = CRS.aggregateDimensions.total_campaign_bucket.top(100)
                    topData.push(totalDimension)


                    d3.select("#campaign-box").append("br")

                    var topCampaigns = d3.select("#campaign-box")
                      .append("div")
                      .classed("campaign-table-new",true)

                    var topHeader = topCampaigns.append("div").classed("header",true)
                      .style("line-height","40px")
                      .style("font-weight","500")
                      .style("font-size","13px")
                      .style("text-transform","uppercase")

                    topHeader.append("div")
                      .classed("col-md-3",true)
                      .text("Campaign Name")

                    names = ["Impressions","Clicks","Conversions","Visits","Cost","Viewable"]

                    var colors = d3.scale.category10()

                    var innerTopHeader = topHeader.append("div")
                      .classed("col-md-8",true)

                    names.map(function(name){
                      innerTopHeader.append("div")
                        .classed("col-md-2",true)
                        .append("div")
                        .style("border-top",function(x,i){
                          return "5px solid " + colors(name)
                        })
                        //.style("border-left","5px solid white")
                        .text(name)
                    })

                    var topBody = topCampaigns.append("div")
                      .classed("campaigns-body",true)


                    var row = topBody.selectAll(".campaign").data(topData)
                      .enter()
                      .append("div").classed("campaign",true)
                      .style("line-height","40px") 
                      .style("margin-bottom","10px")
                      

                    row.selectAll(".campaign-metric")
                      .data(function(x){
                        return [
                            [
                              {"class":"name","value":x.campaign_bucket}
                            ], 
                            [
                              {"class":"metric","value":formatNumber(x.imps)}, 
                              {"class":"metric","value":formatNumber(x.clicks)}, 
                              {"class":"metric","value":formatNumber(x.conversions)}, 
                              {"class":"metric","value":formatNumber(x.visits || 0)}, 
                              {"class":"metric","value":formatMoney(x.cost)}, 
                              {"class":"metric","value":d3.format("%")(x.percent_visible)}
                            ],[
                              {"class":"streaming"}
                            ]
                        ]
                      }).enter()
                        .append("div")
                        .classed("col-md-8",function(x,i){return (i == 1) })
                        .classed("col-md-1",function(x,i){return (i == 2) }) 
                        .classed("campaign-name-no-style col-md-3",function(x,i){return i == 0}) 
                        .style("border-top", "1px solid #ddd")
                        .selectAll(".campaign-metric")
                        .data(function(x){
                          return x
                        })
                        .enter()
                          .append("div")
                          .attr("class",function(x){
                            return x.class == "metric" ? "col-md-2" : "col-md-12"
                          })
                          .style("overflow","hidden")
                          .style("height","40px")
                          .style("font-size",function(x){return x.class == "name" ? "12px": ""})
                          .text(function(x){return typeof(x) != "object" ? x : x.value})

                
                    // GENERATE CAMPAIGN REPORTS SECTION					
                    campaignReportsTable = dc.customDataTable('#campaign-reports-table', "reports-group")

                    var currentCampaign = "Campaign total";
                    //var currentCampaign = $.isEmptyObject(campaignTable.totalDimension()) ? CRS.aggregateDimensions.total_campaign_bucket.top(1)[0].campaign_bucket : "Campaign total";
                    updateCampaignReports($('#campaign-reports-box .outer-interval-select .interval-select .interval-active').text(), currentCampaign);				
                    dc.renderAll("reports-group");
                    // console.log(CRS.aggregateDimensions.daily.bottom(Infinity).length, CRS.aggregateDimensions.weekly.bottom(Infinity).length);
                    // var dateTimeObj = CRS.groups.datetime.all();
                    // var impsMax = impsMin = dateTimeObj[1].value.imps;
                    // $.each(dateTimeObj, function(key, data){
                        // if(data.value.imps > impsMax) impsMax = data.value.imps;
                        // else if(data.value.imps < impsMin) impsMin = data.value.imps;
                    // });
                    
                    var currentMetric = $('#filter-box #filter-options #filter-metric li.filter-metric-active').text();
                    $('#campaign-graph-box').addClass("data-metric-" + currentMetric);
                        
                    // GENERATE SLIDER GRAPH
                    sliderGraph = dc.lineChart('#campaign-slider', "graph-group")
                    .dimension(CRS.dimensions.daily)
                    .group(CRS.groups.daily)
                    .height(48)
                    .width(843)
                    .renderArea(true)
                    .elasticY(true)
                    .margins({top: 0, right: 0, bottom: 0, left: 0})
                    .yAxisPadding("25%")
                    .round(d3.time.day.round)
                    .xUnits(d3.time.days)
                    .valueAccessor(function(d){					
                        if(currentMetric == "clicks") return d.value.clicks;
                        else if(currentMetric == "conversions") return d.value.conversions;
                        else if(currentMetric == "cost") return d.value.cost;
                        return d.value.imps;
                    })
                    // .y(d3.scale.log().nice().domain([impsMin, impsMax]))
                    .x(d3.time.scale().domain([
                        CRS.groups.all.summary().date_min,
                        CRS.groups.all.summary().date_max
                    ]))
                    .on("preRedraw", function(){
                        CRS.dimensions.datetime.filterAll();
                    })
                    // .on("postRedraw", function(){
                        // $('#campaign-slider .axis.x .tick line').attr("y2", "13");
                    // })
                    // .on("postRender", function(){
                        // $('#campaign-slider .axis.x .tick line').attr("y2", "13");
                    // })			
                    // .renderHorizontalGridLines(true)
                    
                    // sliderGraph.yAxis().ticks(5);
                    sliderGraph.xAxis().ticks(8).tickFormat(d3.time.format("%m/%d"));
                    
                    /*
                    var intervalStart = removeDays(new Date(), 14);
                    intervalStart.setSeconds(0);
                    intervalStart.setMinutes(0);
                    intervalStart.setHours(0);
                    */
                    
                    // GENERATE MAIN GRAPH
                    mainGraph = dc.lineChart('#campaign-graph', "graph-group")
                    .dimension(CRS.dimensions.datetime)
                    .group(CRS.groups.datetime)
                    .tooltipType("daily")
                    .height(328)
                    .width(843)
                    .margins({top: 0, right: 0, bottom: 0, left: 0})
                    .elasticY(true)
                    .renderArea(true)
                    .yAxisPadding("25%")
                    .round(d3.time.day.round)
                    .xUnits(d3.time.days)
                    .valueAccessor(function(d){
                        if(currentMetric == "clicks") return d.value.clicks;
                        else if(currentMetric == "conversions") return d.value.conversions;
                        else if(currentMetric == "cost") return d.value.cost;
                        return d.value.imps;
                    })
                    .x(d3.time.scale().domain([
                        CRS.groups.all.summary().date_min,
                        CRS.groups.all.summary().date_max
                    ]))
                    .renderHorizontalGridLines(true)
                    .brushOn(false)
                    .renderTitle(true)
                    .rangeChart(sliderGraph)
                    .on("preRedraw", function(){
                        try {
                        var intervalLength = timeDifference(CRS.groups.all.summary().date_min, CRS.groups.all.summary().date_max);
                        if(intervalLength < 14){
                            mainGraph.dimension(CRS.dimensions.datetime).group(CRS.groups.datetime).tooltipType("hourly");
                        }
                        else {
                            mainGraph.dimension(CRS.dimensions.daily).group(CRS.groups.daily).tooltipType("daily");                       
                        }
                        } catch(e) {}
                        
                        if(intervalLength <= 1){
                            mainGraph.xAxis().tickFormat(d3.time.format("%I%p"));
                        }
                        else {
                            mainGraph.xAxis().tickFormat(d3.time.format("%m/%d"));
                        }
                    });
                    
                    mainGraph.yAxis().ticks(5);
                    mainGraph.xAxis().tickFormat(d3.time.format("%m/%d"));
                    
                    
                    dc.renderAll("graph-group");
                    
                    // SET TIME INTERVAL
                    var baseInterval = formatDate(ioStartDate) + " - " + formatDate(CRS.groups.all.summary().date_max);
                    
                    intervalBox = dc.customDataBox('#filter-box #graph-interval #current-interval', "graph-group")
                    .valueAccessor(function(d){
                        var dateMin = formatDate(d.date_min), dateMax = formatDate(d.date_max);
                        if(dateMin == dateMax) return dateMin;
                        return dateMin + " - " + dateMax;
                    })
                    .group(CRS.groups.all)
                    .on("postRedraw", function(){
                        if(intervalBox.value() != baseInterval){
                            $('#graph-interval #interval-title #outer-interval-reset').fadeIn();
                        }
                        else {
                            $('#graph-interval #interval-title #outer-interval-reset').fadeOut();
                        }
                    });				
                    
                    var campaignGraphPos = $('#campaign-graph').position();

                    mainGraph.focus([ioStartDate, CRS.groups.all.summary().date_max])

                    try {
                      if(ioStartDate < CRS.groups.all.summary().date_min){
                        ioStartDate = new Date(CRS.groups.all.summary().date_min.getTime());
                         mainGraph.focus([ioStartDate, CRS.groups.all.summary().date_max]);
                         baseInterval = formatDate(ioStartDate) + " - " + formatDate(CRS.groups.all.summary().date_max);
                         intervalBox.redraw();                   
                      }     
                    } catch(e) {}
                    
                    // HACKHACKHACK
                    //$('#io-completion-box #io-progress #io-estimated-spent').text(formatMoney(CRS.groups.all.value().cost) + "*");
                    $('#page-loader').fadeOut();
                });		
        });
	</script>
	<script>		
		// SWITCH CAMPAIGN FOCUS
		$('body').on("click", '.campaign', function(){
			if(!$(this).hasClass('active-row')){
				$('.campaign.active-row').removeClass('active-row');
				$(this).addClass('active-row');
				
				var currentCampaign = $(this).children('.campaign-name-no-style').text();
				if(currentCampaign == "Campaign total"){
					CRS.dimensions.total_campaign_bucket.filterAll();
				}
				else {
					CRS.dimensions.total_campaign_bucket.filter(function(d){return d == currentCampaign});
				}				
				
				sliderGraph.redraw();				
				mainGraph.redraw();	
				
				updateCampaignReports($('#campaign-reports-box .outer-interval-select .interval-select li.interval-active').text(), currentCampaign);
				
				$('#campaign-reports-table').fadeOut(250, "linear", function(){
					campaignReportsTable.redraw();
				});	
			}
		});
		
		// SWITCH REPORTING MODE ON CLICK
		$('#campaign-reports-box .outer-interval-select .interval-select li').on("click", function(){
			if(!$(this).hasClass('interval-active')){
				$(this).siblings('.interval-active').removeClass('interval-active');
				$(this).addClass('interval-active');
				
				var currentCampaign = $('#campaign-table .campaign-row.active-row .campaign-name-no-style').text();
				if(currentCampaign == "Campaign total"){
					CRS.dimensions.total_campaign_bucket.filterAll();
				}
				else {
					CRS.dimensions.total_campaign_bucket.filter(function(d){return d == currentCampaign});
				}		
				
				updateCampaignReports($(this).text(), currentCampaign);
				
				$('#campaign-reports-table').fadeOut(250, "linear", function(){
					campaignReportsTable.redraw();
				});			
			}
		});
		
		// IF SHOW MORE ON CAMPAIGN REPORTS
		$('#campaign-reports-box .show-more').click(function(){			
        
			var currentCampaign = $('#campaign-table .campaign-row.active-row .campaign-name-no-style').text();
			if(currentCampaign == "Campaign total"){
				CRS.dimensions.total_campaign_bucket.filterAll();
			}
			else {
				CRS.dimensions.total_campaign_bucket.filter(function(d){return d == currentCampaign});
			}		
			updateCampaignReports($('#campaign-reports-box .outer-interval-select .interval-select li.interval-active').text(), currentCampaign, Infinity);

			campaignReportsTable.redraw();		
		});
        
        // IF CLICK ON DATESPAN
		$('#campaign-reports-table').on("click", '.date-span', function(){			
            if($(this).parent().hasClass('date-day')){
                dc.filterAll("graph-group");
                var currentDate = new Date($(this).text());
                mainGraph.focus([currentDate, addDays(currentDate, 1)])
                dc.redrawAll("graph-group");
            }
            else if($(this).parent().hasClass('date-week')){
                var currentWeek = $(this).text().split(" - ");
                dc.filterAll("graph-group");
                mainGraph.focus([new Date(currentWeek[0]), addDays(new Date(currentWeek[1]), 1)])
                dc.redrawAll("graph-group");
            }
            else if($(this).parent().hasClass('date-month')){
                var currentMonth = new Date($(this).text());
                var monthEnd = new Date($(this).text());
                monthEnd.setMonth(monthEnd.getMonth() + 1);
                dc.filterAll("graph-group");
                mainGraph.focus([currentMonth, monthEnd])
                dc.redrawAll("graph-group");
            }
		});
		
		// RESET DATE FILTER
		$('#interval-reset').click(function(){
			// CRS.dimensions.datetime.filterAll();
			dc.filterAll("graph-group");
            mainGraph.focus([ioStartDate, CRS.groups.all.summary().date_max])
			dc.redrawAll("graph-group");
			// $(this).parent().fadeOut(500);
		});
		
		// CHANGE METRIC
		$('#filter-box #filter-options #filter-metric li').click(function(){
			if(!$(this).hasClass('filter-metric-active')){
				var currentMetric = $(this).text();
				$('#campaign-graph-box').removeClass('data-metric-' + $('#filter-box #filter-options #filter-metric li.filter-metric-active').text()).addClass("data-metric-" + currentMetric);
				mainGraph.valueAccessor(function(d){										
					if(currentMetric == "clicks") return d.value.clicks;
					else if(currentMetric == "conversions") return d.value.conversions;
					else if(currentMetric == "cost") return d.value.cost;
					return d.value.imps;
				});
				sliderGraph.valueAccessor(function(d){					
					if(currentMetric == "clicks") return d.value.clicks;
					else if(currentMetric == "conversions") return d.value.conversions;
					else if(currentMetric == "cost") return d.value.cost;
					return d.value.imps;
				});
				
				var currentCampaign = $('#campaign-table .campaign-row.active-row .campaign-name-no-style').text();
				if(currentCampaign == "Campaign total"){
					CRS.dimensions.total_campaign_bucket.filterAll();
				}
				else {
					CRS.dimensions.total_campaign_bucket.filter(function(d){return d == currentCampaign});
				}		
				
				if(currentMetric == "cost"){
					$('.tooltip').addClass('value-cost');
				}
				else $('.tooltip').removeClass('value-cost');
				
				$('#filter-box #filter-options #filter-metric li.filter-metric-active').removeClass('filter-metric-active').children('img').attr('src', '/static/img/general/unchecked-radio.png').attr('alt', 'Unchecked radio button');
				$(this).addClass('filter-metric-active').children('img').attr('src', '/static/img/general/checked-radio.png').attr('alt', 'Checked radio button');
				
				sliderGraph.redraw();
				mainGraph.redraw();
			}
		});
	</script>
{% end %}
