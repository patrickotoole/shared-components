{% autoescape None %}
<!DOCTYPE html>
<html>

<head>

<script type="text/javascript" src="/static/js/rockerbox/helper.js"></script>
<title>Rockerbox - Create Advertiser</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<link rel="icon" type="image/png" href="https://s3.amazonaws.com/getrockerbox.com/Fav_icon.png">

<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic%7CUbuntu:300,300italic,400,400italic,500,500italic,700,700italic%7CInconsolata:400,400italic,700,700italic%7CLato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic">

<link type="text/css" rel="stylesheet" href="/static/css/bootstrap.min.css"/>
<link type="text/css" rel="stylesheet" href="/static/css/style.css"/>

<style>
  .hidden {display:none}
  body {padding-top:0px}
  body > .container {margin-left:0px}
  .window_content {text-align: left}
</style>

<script type="text/javascript" src="/static/js/d3.js" charset="utf-8"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/crusher/start/build/start.js"></script>
<script type="text/javascript" src="/static/js/rockerbox/crusher/signup/build/signup.js"></script>
<script type="text/javascript" src="/static/js/queue.js"></script>



<script type="text/javascript" src="/static/js/analytics.js"></script>

<script type="text/javascript">
  window.analytics.google()
  window.analytics.mixpanel()
</script>


</head>
<body class="create" style="background:#40495c">
  <img src="/static/img/general/hindsight.png" style="padding:10px;height:50px;margin-left:10px;display:block;margin-bottom:-5px" />
  <div class="container" style="width:inherit">
    <div class="row funnels"></div>
  </div>
</body>

<script>
//signup.signup(d3.select(".funnels"))
//  .data({})
//  .draw()
//
//if (false) 
d3.json("/account/permissions")
  .get(function(err,x){

      var s = window.location.search;
      var nonce = (s.indexOf("nonce") > -1 ) ?
        s.split("nonce=")[1].split("&")[0] : 
        "";

      var slide_position = !!nonce ? 
        3 : (!!err) ? 
        0 : (x.results.advertisers[0].external_advertiser_id == 0) ?
        1 : 2;

          
    
      var funcs = [
          0
        , 1
        , function(x,pane) {
            slideshow.next()
          }
        , function(x,pane) {
            var password = pane.selectAll(".envelope_description input").node().value
            if ( !(password.length > 5) ) return pane.selectAll(".message").text("Password length is too short.")
           
            var obj = { "password": password, "nonce":nonce}
            d3.xhr("/signup")
              .send("PUT", JSON.stringify(obj), function(err,x){
                if (!err) document.location = "/crusher"
                pane.selectAll(".message").text(JSON.parse(err.response).error)
    
              })
    
          }
      ]
    
      var slides = [
        function slide1(){
          var d = d3.select(this)                                                                                    
    
          signup.email(d)
            .on("success",function(){slideshow.next()})
            .draw()
    
        } 
      , function slide2(){
          var d = d3.select(this)
            
          signup.domain(d)
            .on("success",function(){slideshow.next()})
            .draw()
          
        }                                                                                                            
      , function slide3(){
          
          var d = d3.select(this)
          var stage = start.stage(d)
            .title("Almost there!")                                                                                
            .subtitle("Paste the code below before the </head> tag on every page of your site.")
            .left("<div class='codepeek_text'>This pixel allows us to collect a pool of data about the users in your audience. <br><br> </div>")
            .right("<div class='codepeek_text'>After the pixel is implemented, you will receive the Hindsight Daily Digest. <br><br> It will show content you should engage with and recommend stories that matches your audience.</div>")
            .draw()
        
          var cp_row = stage._stage
          d3.json("/advertiser")
            .get(function(err,a){
              d3.json("/pixel?implementation=hindsight")
                .get(function(err,j){
                
                  var advertiser = { 
                    "segments": j.segment_pixels.map(function(s){ s.segment_implemented = s.compiled; return s}) ,
                    "client_sld": a[0].client_sld
                  }

                  var click = codepeek_click(cp_row,advertiser,uid,slideshow.next.bind(slideshow))
        
                  start.codepeek(cp_row)
                    .data(advertiser)
                    .button("check")
                    .click(click)
                    .draw()

                })
            })

    
    
        }
      , function slide4(){
          var d = d3.select(this)                                                                                    
    
          var stage = start.stage(d)
            .title("Activate Account")                                                                                
            .subtitle("Choose a password to complete account activation.")
            .left("")
            .right("")                                                                                               
            .draw()                                                                                                  
          
          var cp_row = stage._stage                                                                                  
          
          var env = start.envelope(cp_row)
            .data([])
            .title("Choose a password")
            .description("")
            .button("activate")
            .click(funcs[3])
            .draw()
    
          var row = d3_updateable(env._desc_wrapper,".row","div")
            .classed("row",true)
    
          d3_updateable(row,"input","input")
            .attr("type","password")
            .attr("placeholder","password")
            .style("width","300px")
    
          d3_updateable(row,".message","div")
            .classed("message",true)
    
    
          cp_row.selectAll(".envelope")
            .style("margin-bottom","0px")
    
          cp_row.selectAll("h3")
            .style("margin-bottom","0px")
    
          cp_row.selectAll(".envelope_description")
            .style("margin-bottom","-20px")
    
    
    
        }
      ]                                                                                                                

      slides = slides.slice(slide_position)
                                                                     
    
     
    
    var slideshow = start.slideshow(d3.select(".funnels"))
      .data(slides)
      .draw()
    
    //slideshow
    //  .slides()
    //  .each(function(x,i){
    //    return x.bind(this)(x,i)
    //  })

    var stop = false;

    var validation = {
      success: function(row,data,next) {

        var desc = "Your implementation appears to be successful. <br><br>We detected " + 
          data.length + 
          " recent page views to the following pages on your site by your web browser:"

        start.envelope(row)
          .data(data)
          .description(desc)
          .title("congrats!")
          .button("next")
          .click(next)
          .draw()

        var to_hide = row.selectAll(".codepeek_content")
          , h = -to_hide.node().clientHeight;

        to_hide.transition()
          .style("margin-top",(h+20) + "px")
          .duration(500)
      }
    , failure: function(advertiser,all_pages) {

        var url = 'http://' + advertiser.client_sld
          , dims = "status=1,width=50,height=50,right=50,bottom=50," + 
              "titlebar=no,toolbar=no,menubar=no,location=no,directories=no,status=no"
          , validation_popup = window.open(url, "validation_popup", dims);
    
        if (!stop) {
          setTimeout(function(){
            stop = true
            all_pages.uuid = advertiser.uid;
            validation_popup.close()
          },8000)
        } else {
          validation_popup.close()
        }
    
      }
  }

  var pixel_check = function(segment,uid,run) {

    var path = "/crusher/pixel/status/lookup?format=json&segment="
    d3.json(path + segment.external_segment_id + "&uid=" + segment.uuid, run)

  }

  var uid = 0
  var codepeek_click = function(row,advertiser,uid,next) {

    advertiser.uid = uid

    var click = function(x){

      var all_pages = x.segments.filter(function(x){return x.segment_name.indexOf("All Pages") > -1})[0]
        , stop = false;

      var uuid = document.cookie.split("an_uuid=")[1].split(";")[0]

      all_pages.uuid = uuid;
      d3.select(this).property("value","validating...")

      pixel_check(all_pages,uid,function(data){
          if (!!data.length) validation.success(row,data,next)
          else validation.failure(advertiser,all_pages)
        }
      )

    }

    return click
 
  }


})





</script>

</html>
