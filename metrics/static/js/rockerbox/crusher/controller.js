var RB = RB || {}
RB.crusher = RB.crusher || {}

RB.crusher.controller = (function(controller) {

  // requires: api.js, d3.js

  var crusher = RB.crusher
  var source = crusher.api.source 

  controller.init = function(type,data) {

    //var type = (type == "/crusher") ? "" : type
    var id = data ? data.funnel_id : false
     
    var state = controller.states[type]
    if (state) {
      RB.routes.navigation.forward(state)
    }
    //if (type.length) controller.initializers[type](id)
    
    $.getJSON("/crusher/funnel/action/recommended", function(data) {
      data = data.slice(0,10)
      console.log(data)
      RB.rho.ui.buildChart(".ct-chart#actions", data, "first_word", "views", title="Top actions", description=null, type="bar");
    })
    
    $.getJSON("/crusher/stats?format=json", function(data) {
      
      var description = "Number of pageviews per day generated by visitors to your site"
      RB.rho.ui.buildChart('.ct-chart#views', data, "date", "views", title="Views", description=description);
      
      description = "Number of engaged users (visited 5 or more pages) on your site"
      RB.rho.ui.buildChart('.ct-chart#engaged', data, "date", "engaged", title="Engaged", description=description);
      
      description = "Number of distinct users visiting your site per day"
      RB.rho.ui.buildChart('.ct-chart#visitors', data, "date", "visitors", title="Visitors", description=description);
      
      description = "Ratio of visitors who are considered to be engaged users"
      RB.rho.ui.buildChart('.ct-chart#engagement', data, "date", "engagement", title="Engagement", description=description,"line","average",d3.format(".1%"));
      
      description = "This is the number of advertising opportunities Rockerbox has seen for your users"
      RB.rho.ui.buildChart('.ct-chart#advertising-ops', data, "date", "advertising_ops", title="AD OPPORTUNITIES", description=description);
      
      description = "This is the average number of pageviews per visitor to your site"
      RB.rho.ui.buildChart(
	'.ct-chart#views-per-user',
	data,
	"date",
	"views_per_user",
	title="Views per user",
	description=description,
        "line",
        "average",
        d3.format(".3r")
      );
    });
  }

  controller.initializers = {
    "": function(){
      var target = d3.selectAll(".container")

      var funnelRow = d3_splat(target,".row","div",[{"id":"about"}],function(x){return x.id})
        .classed("row funnels",true)

      funnelRow.exit().remove()
    },
    "funnel/existing": function(funnel) {

      var events = ["actions","funnels","campaigns","lookalikes","lookalikeCampaigns"]

      crusher.ui.funnel.buildBase() 

      events.map(function(x){ crusher.subscribe.publishers[x]() })
      crusher.subscribe.publishers["funnel_all"](funnel)
    },
    "funnel/new": function(){
      crusher.ui.funnel.buildBase()
      var target = d3.selectAll(".funnel-view-wrapper").selectAll(".funnel-wrapper")

      RB.crusher.controller.funnel.new(target)
    },
    "action/existing": function(action) {
      
      crusher.ui.action.buildBase()

      var target = d3.selectAll(".action-view-wrapper")
      target.datum(action)
      
      crusher.subscribe.add_subscriber(["actions"], function(){
        crusher.ui.action.edit(target,controller.action.save)
      },"existing_edit",true,true)   

      crusher.subscribe.add_subscriber(["actions"] , function() {
        crusher.cache.actionData.map(function(x) { x.values = crusher.cache.urls_wo_qs })
        crusher.ui.action.view(target)
      },"existing_view",true,true)
         
    },
    "action/new": function(action) {
      crusher.ui.action.buildBase()

      var target = d3.selectAll(".action-view-wrapper")

      crusher.subscribe.add_subscriber(["actions"], function(actionsw){

        var override = (action.action_name) ? action : false
        controller.action.new(target,crusher.cache.urls_wo_qs, override)
      }, "new",true,true)
    },
    "action/recommended": function(action) {
      crusher.ui.action.buildBase()

      var target = d3.selectAll(".action-view-wrapper")

      crusher.subscribe.add_subscriber(["actions"], function(actionsw){

        var override = (action.action_name) ? action : false
        controller.action.new(target,crusher.cache.urls_wo_qs, override)
      }, "new",true,true)
    }
  }

  controller.get_bloodhound = function(cb) {

    var compare = function(a,b) {
      return (a.count < b.count) ? -1 : 1
    }

    controller.bloodhound = controller.bloodhound || new Bloodhound({
      datumTokenizer: Bloodhound.tokenizers.whitespace,
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      remote: { 
        url: "/crusher/search/urls?advertiser=" + source + "&search=%QUERY&format=json&logic=and&timeout=4",
        wildcard: "%QUERY",
        transform: function(resp) {
          return resp.results
        },
        prepare: function(x,settings) {
          var q = x.split(" ").join(","),
            split = settings.url.split("%QUERY")

          settings.url = split[0] + q + split[1]
          return settings
        }
      },
      sorter:compare
    }); 

    cb(controller.bloodhound)
 
  }

  

  controller.routes = {
    roots: [{
      "name":"On-page Analytics",
      "push_state": "/crusher/"
    }],
    renderers: controller.initializers,
    transforms: {
      "funnel/new": function(menu_obj){
        menu_obj.values = RB.crusher.cache.funnelData
        RB.menu.methods.transform(menu_obj,menu_obj.values_key)
      },
      "funnel/existing": function(menu_obj){
        menu_obj.values = RB.crusher.cache.funnelData
        RB.menu.methods.transform(menu_obj,menu_obj.values_key)
      },
      "action/existing": function(menu_obj){
        menu_obj.values = RB.crusher.cache.actionData
        RB.menu.methods.transform(menu_obj,menu_obj.values_key)
      },
      "action/recommended": function(menu_obj){

        crusher.cache.recommendedActionData = crusher.cache.recommendations
          .slice(0,20)
          .map(function(x){
            return {"action_name":x.first_word,"url_pattern":[x.first_word]}
          })

        menu_obj.values = RB.crusher.cache.recommendedActionData
        RB.menu.methods.transform(menu_obj,menu_obj.values_key)
      }
    },
    apis: {
      "funnel/new": [],
      "funnel/existing": ['funnels'],
      "action/existing": ['actions'],
      "action/new": [],
      "action/recommended": ["recommended_actions"],
      "": [{
          "name":"Actions",
          "push_state":"/crusher/action",
        },
        {
          "name":"Funnels",
          "push_state":"/crusher/funnel",
        }] ,
      "funnel": [{
          "name":"Create New Funnel",
          "push_state":"/crusher/funnel/new",
        },
        {
          "name": "View Existing Funnels",
          "push_state":"/crusher/funnel/existing",
          "skipRender": true,
          "values_key":"funnel_name"    
        }],
      "action": [{
          "name": "Create New Action",
          "push_state":"/crusher/action/new",
          "values_key": "action_name"
        },
        {
          "name": "Recommmended Actions",
          "push_state":"/crusher/action/recommended",
          "values_key": "action_name"
        },
        {
          "name": "View Existing Actions",
          "push_state":"/crusher/action/existing",
          "skipRender": true,
          "values_key":"action_name"
        }]
    }
  }
  
  controller.states = {}  

  Object.keys(controller.routes.apis).map(function(k){
    if (controller.routes.apis[k].length > 0 && typeof(controller.routes.apis[k][0]) == "object") {
      controller.routes.apis[k].map(function(state) {
        controller.states[state.push_state] = state
      })
    }
  })

  RB.routes.register(controller.routes)



  return controller

})(RB.crusher.controller || {}) 
