<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
				<script src="http://mbostock.github.com/d3/d3.v2.js"></script>
				<script src="http://metrics.getrockerbox.com:8080/static/bar.js"></script>
				<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
				<script src="http://getbootstrap.com/dist/js/bootstrap.min.js"></script>

				<link href="http://getrockerbox.com/css/bootstrap.css" rel="stylesheet">
				<link href="http://getbootstrap.com/examples/dashboard/dashboard.css" rel="stylesheet">
				<style>
						td {max-width:200px;max-height:40px;overflow:hidden}
						path { stroke: steelblue; stroke-width: 1; fill: none; }
						.axis {font-size:8px}
						.bar { fill: steelblue; }
						.bar:hover { fill: brown; }
						.axis { font: 10px sans-serif; }
						.axis path, .axis line { fill: none; stroke: #000; shape-rendering: crispEdges; }
						.x.axis path { display: none; }
				</style>
		</head>
   <body data-spy="scroll" data-target=".navbar" data-offset="150"> 
   <div class="navbar-wrapper">
	 	 <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	            <span class="sr-only">Toggle navigation</span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	          </button>
	          <a class="navbar-brand" href="#">
				      <img src="http://getrockerbox.com/img/logo.png" width="150px" style="margin-top:-5px">
	          </a>
	        </div>
	        <div class="navbar-collapse collapse">
	          <ul class="nav navbar-nav">
	            <li><a href="#about">About</a></li>
 							<li><a href="#technology">Tech</a></li>
	            <li><a href="#team">Team</a></li>
							 <li><a href="#contact">Contact</a></li>
	           
	            <!-- <li><a href="demo.html">Demo</a></li> -->
	          </ul>
	        </div><!--/.nav-collapse -->
	    </nav>
		</div>
 		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-4 col-md-2 sidebar">
          <ul class="nav nav-sidebar">
            <li class=""><a href="/streaming">Streaming</a></li>
            <li class="active"><a href="/debug">Arbitrage</a></li>
            <li><a href="/lookback">Lookback</a></li>
            <li><a href="#">Export</a></li>
          </ul>
        </div>
				<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
          <div class="col-sm-5">
            <h3 class="page-header">Arbitrage Dashboard</h3>
            <h5>Impressions</h5>
            <div id="imps" style="width:300px; height:100px"></div>
            <h5>Price</h5>
            <div id="price" style="width:300px; height:100px"></div>
            <h5>Potential Price</h5>
            <div id="potential" style="width:300px; height:100px"></div>
            <h5>Differential</h5>
            <div id="differential" style="width:300px; height:100px"></div>
          </div>
					
					<div class="col-sm-7">
            <h3 class="page-header">Arbitrage Opportunities</h3>        
            <div id="messages" style=""></div>

          </div>
				</div>
			</div>
		</div>
    </body>
		<script>
    window.running_total = 0
		Element.prototype.prependChild = function(child) { this.insertBefore(child, this.firstChild); };

		var socketWrapper = function(params) {
			var self = this;
			this.id = Math.round(Math.random() * 10000000);

			this.createSocket = function(params){
				var socket = new WebSocket("ws://107.170.18.93/websocket?id=" + this.id);

				socket.onopen = function() {
					self.sendMessage("initialize")
				}

				socket.onmessage = function(event) {
					var parsed = JSON.parse(event.data)
					self.onMessage(parsed,event)
				}
				this.socket = socket;
			}

			this.sendMessage = function(message){
				if (!this.socket) this.createSocket()
				this.socket.send(message)
			}

			this.onMessage = function(json,event) { }
			this.createSocket(params)

		}

		var streamingBarWrapper = function(id,steps,width,height,formatter){
			var self = this;
			this.t = 0
			this.data = d3.range(steps).map(function(){
				self.t++;
				return {"time":self.t,"value":0}
			})
			
			this.graph = dynamicBar(id,this.data,width,height)
      this.defaultFormatter = function(time,json) {
        return {"time":time,"value":json.length}
      }
      this.formatter = formatter || this.defaultFormatter

			this.add = function(json) {
				this.t++;
				this.data.shift()
				this.data.push(this.formatter(this.t,json))
				this.graph(this.data)
			}
		}

		var rawDataWrapper = function(steps){
			this.data = d3.range(steps)
			this.add = function(json) {
				this.data.shift()
				this.data.push(json)
				this.onAdd.bind(this)(json)
			}
      this.spread = function(){
        var m = [], a = [];
        this.data.map(function(x){
          var n = [];
          for (var y in x) {
            var w = parseFloat(x[y]['debug']['second_price']) - parseFloat(x[y]['result']['price'])
            x[y]['result']['differential'] = w
            window.running_total += (x[y]['result']['differential'] > 0.20) ? 
              x[y]['result']['differential'] : 
              0
            
            if (w > 0) {
              n.push(w)
              x[y]['arbitrage'] = {
                "domain": x[y]['result']['domain'],
                "uid" : x[y]['result']['uid'],
                "seller" : x[y]['result']['seller'],
                "tag" : x[y]['result']['tag'],
                "price": x[y]['result']['price'],
                "potential_price": x[y]['debug']['second_price']
              }
              a.push(x[y])
            }
          }
          if (n.length > 0) {
            m.push(n)
          }
        })
        return a
      }
			this.group_user = function() {
				var m = [], n = {}
				this.data.map(function(x){
					var r = []
					for (var y in x) {
						var q = []
						for (var z in x[y]['result']) {
							q.push(x[y]['result'][z])
						}
						m.push(q)
					}
				})
				m.map(function(x){
					if (n[x[1]] === undefined) {
						n[x[1]] = []
					}
					n[x[1]].push(x)
				})
				return n
			}
			this.group_domain = function() {
				var m = [], n = {}
				this.data.map(function(x){
					var r = []
					for (var y in x) {
						var q = []
						for (var z in x[y]['result']) {
							q.push(x[y]['result'][z])
						}
						m.push(q)
					}
				})
				m.map(function(x){
					if (n[x[0]] === undefined) {
						n[x[0]] = []
					}
					n[x[0]].push(x)
				})
				return n
			}
			this.onAdd = function(){}
			
		}
		

		var messageProcessor = function() {

			var messageContainer = document.getElementById("messages"),
					imps = new streamingBarWrapper('#imps',60,5,80,
            function(t,json){
              return {"time":t,"value":json.length}
            }
          ),
          spent = new streamingBarWrapper('#price',60,5,80,
            function(t,json){
              var m = json.
                map(function(x){return parseFloat(x['result']['price'])}).
                reduce(function(pv, cv) { return pv + cv; });

              return {"time":t,"value":m > 0 ? m : 0 }
            }
          ),
          potential = new streamingBarWrapper('#potential',60,5,80,
            function(t,json){
              var m = json.
                map(function(x){return parseFloat(x['debug']['winning_bid'])}).
                reduce(function(pv, cv) { return pv + cv; })

              return {"time":t,"value":m > 0 ? m : 0 }
            }
          ),
          differential = new streamingBarWrapper('#differential',60,5,80,
            function(t,json){
              var m = json.
                map(function(x){return x['result']['differential']}).
                reduce(function(pv, cv) { return pv + cv; })

              return {"time":t,"value":m > 0 ? m : 0 }
            }
          ),


					self = this;

			this.raw_data = new rawDataWrapper(60);
      window.raw_data = this.raw_data;
			this.raw_data.onAdd = function(json){
        var j = this.spread()

				var table = messageContainer.getElementsByTagName("table"),
						keys = Object.keys(j[0]['arbitrage']);

				if (table.length == 0) 
					self.createHeaders(keys);

				var header = messageContainer.getElementsByTagName("thead")[0];
				self.insertRows(j.map(function(x){return x['arbitrage']}),keys,header);
        
				//self.domainTable(this.group_domain());
				//self.userTable(this.group_user());
			}

			this.userTable = function(data) {
				var table = "<table class='table table-condensed'><thead><tr>" + 
					"<th>user</th>"+
					"<th>count</th>"+
					"<th>approved</th>"+
					"<th>price</th>"+
					"</tr></thead>"
				var sorted = []

				for (var key in data) {
					sorted.push([
						key, 
						data[key].length, 
						data[key].map(function(r){return r[7]}).reduce(function(pv, cv) { return pv + cv; }, 0),
						(data[key].map(function(r){return parseFloat(r[2])}).reduce(function(pv, cv) { return pv + cv; }, 0)/data[key].length).toFixed(2)
					])
				}
				sorted = sorted.sort(function(x,y){return y[1]-x[1]})
				for (var key in sorted) {
					table += "<tr><td>" + 
						sorted[key][0] + "</td><td>" + 
						sorted[key][1] + "</td><td>" + 
						sorted[key][2] + "</td><td>" + 
						sorted[key][3] + "</td><td>" 
				}
				

				table += "</table>"
				document.getElementById("users").innerHTML = table

			}


			
			this.domainTable = function(data) {
				var table = "<table class='table table-condensed'><thead><tr>" + 
					"<th>domain</th>"+
					"<th>count</th>"+
					"<th>uniques</th>"+
					"<th>approved</th>"+
					"<th>advertisers</th>"+
					"<th>price</th>"+
					"</tr></thead>"
				var sorted = []

				for (var key in data) {
					sorted.push([
						key, 
						data[key].length, 
						data[key].map(function(r){return r[1]}).filter(function (e, i, arr) { return arr.indexOf(e, i+1) === -1; }).length,
            data[key].map(function(r){return r[7]}).reduce(function(pv, cv) { return pv + cv; }, 0),
						data[key].map(function(r){return r[4]}).filter(function (e, i, arr) { return arr.indexOf(e, i+1) === -1; }).length,
						(data[key].map(function(r){return parseFloat(r[2])}).reduce(function(pv, cv) { return pv + cv; }, 0)/data[key].length).toFixed(2)
					])
				}
				sorted = sorted.sort(function(x,y){return y[1]-x[1]})
				for (var key in sorted) {
					table += "<tr><td>" + 
						sorted[key][0] + "</td><td>" + 
						sorted[key][1] + "</td><td>" + 
						sorted[key][2] + "</td><td>" + 
						sorted[key][3] + "</td><td>" + 
						sorted[key][4] + "</td><td>" + 
						sorted[key][5] + "</td></tr>"		
				}
				

				table += "</table>"
				document.getElementById("domains").innerHTML = table

			}

			this.createHeaders = function(keys) {
				headers = "<table class='table'><thead><tr id='msgHeader'>"
				for (var key in keys) {
					headers += "<th>"+keys[key]+"</th>"
				}
				headers += "</tr></thead></table>"
				messageContainer.innerHTML = headers
			}
			this.insertRows = function(values,keys,loc) {
				for (var row in values) {
					var html_row = document.createElement("tr"),
							content = "";

					for (var key in keys) {
							content += "<td>"+values[row][keys[key]]+"</td>"
					}
					html_row.innerHTML = content
					loc.parentNode.insertBefore(html_row,loc.nextSibling)
				}	
			}
			this.onMessage = function(json,event) {
				self.raw_data.add(json);
				imps.add(json);
        spent.add(json);
        potential.add(json);
        differential.add(json);
				
			}
		}
		
		var socket = new socketWrapper();
		var processor = new messageProcessor()
		socket.onMessage = processor.onMessage

		$('#filter').click(socket.sendMessage)
    setTimeout(function(){socket.sendMessage('start')},1000)
		</script>
</html>
