From 82130397220b98f5a57ae54edc79190a8870e87b Mon Sep 17 00:00:00 2001
From: Hari Shreedharan <harishreedharan@gmail.com>
Date: Sun, 9 Sep 2012 14:46:01 -0700
Subject: [PATCH 03/56] CLOUDERA-BUILD. CDH-5900. Flume-NG version should read the hash from build properties file

---
 flume-ng-core/pom.xml                |    4 +++-
 flume-ng-core/scripts/saveVersion.sh |   13 ++++++++++---
 2 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/flume-ng-core/pom.xml b/flume-ng-core/pom.xml
index 8d8975c..547fc65 100644
--- a/flume-ng-core/pom.xml
+++ b/flume-ng-core/pom.xml
@@ -146,10 +146,12 @@ limitations under the License.
                 <phase>generate-sources</phase>
                 <configuration>
                   <target>
+                    <property file = "${basedir}/../cloudera/build.properties" />
+                    <property name = "cloudera.hash" value = "" />
                     <mkdir dir="${project.build.directory}/generated-sources/java"/>
                     <exec executable="sh">
                       <arg
-                        line = "${basedir}/scripts/saveVersion.sh ${project.version} ${project.build.directory}" />
+                        line = "${basedir}/scripts/saveVersion.sh ${project.version} ${project.build.directory} ${cloudera.hash}" />
                     </exec>
                   </target>
                 </configuration>
diff --git a/flume-ng-core/scripts/saveVersion.sh b/flume-ng-core/scripts/saveVersion.sh
index ad3f8b1..6c7a0e1 100755
--- a/flume-ng-core/scripts/saveVersion.sh
+++ b/flume-ng-core/scripts/saveVersion.sh
@@ -24,23 +24,30 @@ unset LC_CTYPE
 unset LC_TIME
 version=$1
 buildDirectory=$2
+revision=$3
 user=`whoami`
 date=`date`
 dir=`pwd`
 cwd=`dirname $dir`
 if [ -d ../.svn ]; then
-  revision=`svn info ../ | sed -n -e 's/Last Changed Rev: \(.*\)/\1/p'`
+  if [ "$revision" = "" ]; then
+    revision=`svn info ../ | sed -n -e 's/Last Changed Rev: \(.*\)/\1/p'`
+  fi
   url=`svn info  ../ | sed -n -e 's/URL: \(.*\)/\1/p'`
   branch=`echo $url | sed -n -e 's,.*\(branches/.*\)$,\1,p' \
                              -e 's,.*\(tags/.*\)$,\1,p' \
                              -e 's,.*trunk$,trunk,p'`
 elif git rev-parse HEAD 2>/dev/null > /dev/null ; then
-  revision=`git log -1 --pretty=format:"%H"`
+  if [ "$revision" = "" ]; then
+    revision=`git log -1 --pretty=format:"%H"`
+  fi
   hostname=`hostname`
   branch=`git branch | sed -n -e 's/^* //p'`
   url="git://${hostname}${cwd}"
 else
-  revision="Unknown"
+  if [ "$revision" = "" ]; then
+    revision="Unknown"
+  fi
   branch="Unknown"
   url="file://$cwd"
 fi
-- 
1.7.0.4

