From 0f3653ae376b14f9d1c2baf9fc907a85ad7c8304 Mon Sep 17 00:00:00 2001
From: Mike Percy <mpercy@cloudera.com>
Date: Tue, 8 Oct 2013 18:12:10 -0700
Subject: [PATCH 40/56] FLUME-2208. Jetty's default SocketSelector leaks File descriptors

(Hari Shreedharan via Mike Percy)
---
 .../instrumentation/http/HTTPMetricsServer.java    |    8 +++++++-
 .../org/apache/flume/source/http/HTTPSource.java   |    6 ++++--
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/flume-ng-core/src/main/java/org/apache/flume/instrumentation/http/HTTPMetricsServer.java b/flume-ng-core/src/main/java/org/apache/flume/instrumentation/http/HTTPMetricsServer.java
index 373e344..2c2c6f3 100644
--- a/flume-ng-core/src/main/java/org/apache/flume/instrumentation/http/HTTPMetricsServer.java
+++ b/flume-ng-core/src/main/java/org/apache/flume/instrumentation/http/HTTPMetricsServer.java
@@ -29,9 +29,11 @@ import javax.servlet.http.HttpServletResponse;
 import org.apache.flume.Context;
 import org.apache.flume.instrumentation.MonitorService;
 import org.apache.flume.instrumentation.util.JMXPollUtil;
+import org.mortbay.jetty.Connector;
 import org.mortbay.jetty.Request;
 import org.mortbay.jetty.Server;
 import org.mortbay.jetty.handler.AbstractHandler;
+import org.mortbay.jetty.nio.SelectChannelConnector;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -55,9 +57,13 @@ public class HTTPMetricsServer implements MonitorService {
 
   @Override
   public void start() {
-    jettyServer = new Server(port);
+    jettyServer = new Server();
     //We can use Contexts etc if we have many urls to handle. For one url,
     //specifying a handler directly is the most efficient.
+    SelectChannelConnector connector = new SelectChannelConnector();
+    connector.setReuseAddress(true);
+    connector.setPort(port);
+    jettyServer.setConnectors(new Connector[] {connector});
     jettyServer.setHandler(new HTTPMetricsHandler());
     try {
       jettyServer.start();
diff --git a/flume-ng-core/src/main/java/org/apache/flume/source/http/HTTPSource.java b/flume-ng-core/src/main/java/org/apache/flume/source/http/HTTPSource.java
index de79e8b..48c6492 100644
--- a/flume-ng-core/src/main/java/org/apache/flume/source/http/HTTPSource.java
+++ b/flume-ng-core/src/main/java/org/apache/flume/source/http/HTTPSource.java
@@ -28,7 +28,7 @@ import org.apache.flume.instrumentation.SourceCounter;
 import org.apache.flume.source.AbstractSource;
 import org.mortbay.jetty.Connector;
 import org.mortbay.jetty.Server;
-import org.mortbay.jetty.bio.SocketConnector;
+import org.mortbay.jetty.nio.SelectChannelConnector;
 import org.mortbay.jetty.security.SslSocketConnector;
 import org.mortbay.jetty.servlet.ServletHolder;
 import org.slf4j.Logger;
@@ -174,9 +174,11 @@ public class HTTPSource extends AbstractSource implements
       SslSocketConnector sslSocketConnector = new SslSocketConnector();
       sslSocketConnector.setKeystore(keyStorePath);
       sslSocketConnector.setKeyPassword(keyStorePassword);
+      sslSocketConnector.setReuseAddress(true);
       connectors[0] = sslSocketConnector;
     } else {
-      SocketConnector connector = new SocketConnector();
+      SelectChannelConnector connector = new SelectChannelConnector();
+      connector.setReuseAddress(true);
       connectors[0] = connector;
     }
 
-- 
1.7.0.4

