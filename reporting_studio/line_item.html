
{% autoescape None %}

<!DOCTYPE html>
<meta charset="utf-8">

<head>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/colorbrewer.v1.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.5/nv.d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.28.10/js/jquery.tablesorter.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/nv.css">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="/static/helper.js"></script>


</head>

<style>
 
    table {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
        margin: auto;
    }
/*    table td th {
        border: 1px solid #ddd;
        padding: 8px;
    }
*/    table tr:nth-child(even){background-color: #f2f2f2;}
    table tr:hover:not(.expanded) {background-color: #ddd;}
    
    .chart {
      height: 150px;
      width: 1000px;
    }
    h2 {
        margin: auto;
        display : table;
        margin-bottom: 10px;
        margin-top: 10px;
    }
}
</style>

<body>
    <div id="metrics" >
        <h2 > Line Item Summary </h2>
    </div>

<script>
    var dranges = ["_30d","_7d","_yest"]
    var line_columns = ["funnel","line_item_name", "num_campaigns_yest", "imps_yest","media_cost_yest", "clicks_yest","attr_conv_yest"]
                        .concat(dranges.map(function(d){ return "cpa_attr"+d}))
                        .concat(dranges.map(function(d){ return "cpa"+d}))
                        .concat(dranges.map(function(d){ return "ctr"+d}))
                        .concat(dranges.map(function(d){ return "cpc"+d}))
    
    var line_columns = line_columns
        .map(function(x){
            var obj =  {
                'name': x,
                'type': 'text',
                'formatter': formatter(x),
            }
            return obj
        })
    
    var url = "line-item-metrics" + window.location.search
    d3.xhr(url, function(error, response){
        if( error ){ console.log(error) }
        var data = JSON.parse(response['response'])
        var table = make_table(d3.select("#metrics"), line_columns, data)
        table.style({'width': "50px"})
        table.selectAll("th").style({"font-size":"12px"})
        table.selectAll("tr").on("click", function(d){
            if(this.nextSibling.className === "expanded"){
                this.parentElement.removeChild(this.nextSibling)
            }
            else{
                var t = document.createElement('tr');
                this.parentNode.insertBefore(t, this.nextSibling)
                d3.select(t).classed("expanded", true)
                var td = d3.select(t).append("td")
                td.attr("colspan", this.childElementCount)
                
                var data = JSON.parse(d['data'])

                var metrics = ["media_cost","imps","clicks","conv","attr_conv","CPA_attr_7d","CPA_proj","conv_rate_7d","CPM", "CTR", "CTR_7d", "CPC", "CPC_7d", "optimizations"]
                var select = td.selectAll("select").data([metrics]).enter().append("select")
                select.attr("multiple", true)
                select.selectAll("option").data(function(d){return d})
                .enter()
                .append("option")
                .property("value", function(d){return d})
                .text(function(d){return d})
                .property("selected", function(d){
                    if(d == "media_cost" || d == "attr_conv"){
                        return true
                    } else{
                        return false
                    }
                })
                td.selectAll("select").on("change", function(x){
                    var metrics = d3.select(this).selectAll("option").filter(function (d, i) { return this.selected })[0].map(function(d){return d.value })
                    drawMetrics(td, data,  d['line_item_name'] , metrics)
                })
                drawMetrics(td, data,  d['line_item_name'] , ["media_cost","attr_conv"])
            }
        })
    });

function reshapeByDate(data){

    data = data.sort(function(a,b){return d3.ascending(a.date, b.date)})
    data = data.map(function(d,i){
        d['clicks_7d'] = d3.sum(data.slice(Math.max(0,i-6),i+1), function(x) {return x['clicks']})
        d['imps_7d'] = d3.sum(data.slice(Math.max(0,i-6),i+1), function(x) {return x['imps']})
        d['media_cost_7d'] = d3.sum(data.slice(Math.max(0,i-6),i+1), function(x) {return x['media_cost']})
        d['conv_7d'] = d3.sum(data.slice(Math.max(0,i-6),i+1), function(x) {return x['conv']})  
        d['attr_conv_7d'] = d3.sum(data.slice(Math.max(0,i-6),i+1), function(x) {return x['attr_conv']})                
        return d
    })
    data = data.map(function(d){
        d['CPA_attr'] = d['attr_conv'] >0 ? d['media_cost'] / d['attr_conv'] : NaN
        d['CPM'] = d['imps'] >0 ? d['media_cost']*1000 / ['imps'] : NaN
        d['CTR'] = d['imps'] >0 ? d['clicks'] / d['imps'] : NaN
        d['CPC'] = d['clicks'] >0 ? d['media_cost'] / d['clicks'] : NaN
        d['conv_rate_7d'] = d['imps_7d'] >0 ? d['attr_conv_7d'] / d['imps_7d'] : NaN
        d['CPA_attr_7d'] = d['attr_conv_7d'] >0 ? d['media_cost_7d'] / d['attr_conv_7d'] : NaN
        d['CTR_7d'] = d['imps_7d'] >0 ? d['clicks_7d'] / d['imps_7d'] : NaN
        d['CPC_7d'] = d['clicks_7d'] >0 ? d['media_cost_7d'] / d['clicks_7d'] : NaN
        return d
    })
    data = data.map(function(d){
        d['CPA_proj'] = d['conv_rate_7d'] >0 ? (d['CPM']/1000) / d['conv_rate_7d'] : NaN
        return d
    })

    return data
}


var drawMetrics = function(wrapper, data, name, metrics){
    wrapper.selectAll("svg").remove()
    
    var data = reshapeByDate(data)

    grouped = [{'key':name, 'values': data}]
    var opts = []
    data.map(function(d){
        Object.keys(d['optimizations']).map(function(x){
            opts.push({'date':d.date,'opt_name': x, 'num_opts': d['optimizations'][x]  })
        })
    })
    optGrouped = d3.nest().key(function(d){return d.opt_name}).rollup(function(d){return d}).entries(opts)
    
    var divs = wrapper.selectAll("div").data(metrics)
    divs.enter().append('div')
    divs.classed("chart",true)
    divs.exit().remove()
    divs.each(function(d){
        var self = d3.select(this)
        self.selectAll("*").remove()
        self.append("h4").text(d)
        var chart;
        if ( d.indexOf("media_cost") > -1 || d.indexOf("imps") > -1 || d == "conv" || d=="attr_conv" || d=="clicks" || d == "num_campaigns" || d=="optimizations"){
            chart = nv.models.stackedAreaChart()
        }
        else {
            chart = nv.models.lineChart()
                .interpolate("basis")
                .options({'strokeWidth':5})
        }
        // var valueMin = d3.min(grouped.map(function(i){   return d3.min(i, function(j){return j[d]}) }) , function(x){return x})
        // var valueMax = d3.max(grouped.map(function(i){   return d3.max(i, function(j){return j[d]}) }) , function(x){return x})
        // chart.forceY([valueMin*.9, valueMax*1.1])
        chart
            .x(function(x){return parseInt(new Date(x.date).getTime())})
            .y(function(x){return d === "optimizations" ? x['num_opts'] : x[d]})
            .useInteractiveGuideline(true)
            .clipEdge(true)
        
        chart.xAxis
            .showMaxMin(false)
            .tickFormat(function(x) {  return d3.time.format('%x')(new Date(x)) });
        
        if(d.indexOf("media_cost") > -1 || d.indexOf('CPM')>-1 || d.indexOf('CPA') > -1){
            chart.yAxis.tickFormat(d3.format('$,.2f'));
        }
        else if (d.indexOf("rate") > -1){
            chart.yAxis.tickFormat(d3.format(".4%"));
        }
        else{
            chart.yAxis.tickFormat(d3.format(",.0f"));
        }
        if(d === "optimizations"){
            self.append('svg').datum(optGrouped).classed("chart",true)
                .transition().duration(500).call(chart);
        } else{        
            self.append('svg').datum(grouped).classed("chart",true)
                .transition().duration(500).call(chart);
        }
    })
}


    function formatter(x){
        if( x.indexOf('cpa') > -1 || x.indexOf('media_cost') > -1  || x.indexOf('cpm') > -1 || x.indexOf('cpc') > -1){
            return d3.format("$,.2f")
        }
        if( x.indexOf('imps') > -1 || x.indexOf('conv') > -1 || x.indexOf('num_campaigns') > -1 ){
            return d3.format(",.0f")
        }
        if( x.indexOf('ctr') > -1){
            return d3.format(",.4%")
        }
    }
</script>
</body>