{% autoescape None %}

<!DOCTYPE html>
<meta charset="utf-8">

<head>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/colorbrewer.v1.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.5/nv.d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.28.10/js/jquery.tablesorter.min.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="/static/radialtree.js"></script>
<script src="/static/helper.js"></script>

</head>

<style>

/* tables */
    table.tablesorter {
        font-family:arial;background-color: #CDCDCD;margin:10px 0pt 15px;font-size: 10pt;width: 100%;text-align: left;
    }

    table.tablesorter thead tr th, table.tablesorter tfoot tr th {
        background-color: #e6EEEE;border: 1px solid #FFF;font-size: 10pt;padding: 4px;
    }

    table.tablesorter thead tr .header {background-image: url(bg.gif);background-repeat: no-repeat;background-position: center right;cursor: pointer;}

    table.tablesorter tbody td {
        color: #3D3D3D;padding: 4px;background-color: #FFF;vertical-align: top;
    }
/*    table.tablesorter tbody tr.odd td {
        background-color:#F0F0F6;}table.tablesorter thead tr .headerSortUp {background-image: url(asc.gif);
    }*/
    table.tablesorter thead tr .headerSortDown {
        background-image: url(desc.gif);
    }

    table.tablesorter thead tr .headerSortDown, table.tablesorter thead tr .headerSortUp {background-color: #8dbdd8;}

/*    tr:nth-child(even){background-color: #f2f2f2}
*/

    .chart {
      height: 350px;
      width: 850px;
    }
    .node {
        cursor: pointer;
    }

    .node text {
      font: 10px sans-serif;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
    div.tooltip {   
    position: absolute;         
    text-align: center;         
/*    width: 60px;                    
    height: 28px;                   
*/    padding: 2px;               
    font: 10px sans-serif;      
    background: lightsteelblue; 
    border: 0px;        
    border-radius: 8px;         
    pointer-events: none;           
}



</style>

<body>
    <div id="line_items"></div>
    <div id="optTree"></div>
    <div id="campaigns">
        <div id="adjustments" style="float:left; width:50%"></div>
        <div id="timeseries" style="float:right; width:50%"></div>
    </div>


<script>


var line_metrics = {{line_item_metrics}}
var line_columns = [ 'line_item_name','imps_30d','cpa_attr_7d','attr_conv_7d','imps_yest','media_cost_yest']
    .map(function(x){
        var obj =  {
            'name': x,
            'type': 'text',
            'formatter': formatter(x)
        }
        return obj
    })

var line_table = make_table(d3.select("#line_items"), line_columns, line_metrics)
line_table.attr("border", "1px solid gray").attr("rules","rows")
line_table.style({'width': "50px"})
line_table.selectAll("input").classed("input-small",true)


var campaign_metrics = {{campaign_metrics}};

var nodeSize = "media_cost_yest";
var nodeColor = "cpa_attr_total";

var cc = d3.extent(campaign_metrics, function(d){ return d[nodeColor] } )
cc.reverse()

var colorScale = d3.scale.quantize()
    .domain( cc )
    .range(colorbrewer.RdYlGn[9])


var nodeSizeScale = d3.scale.linear()
    .domain(d3.extent(campaign_metrics, function(d){return d[nodeSize]}))
    .range([3, 15])

root = {{tree}};

var svg = radialTree(root, d3.select("#optTree"), colorScale, nodeSizeScale, nodeSize, nodeColor)


d3.select(self.frameElement).style("height", "1300px");

// Tooltip
var tooltip = d3.select("#optTree").append("div")   
.attr("class", "tooltip")               
.style("opacity", 0);

var tooltipColumns = ["media_cost_yest","cpa_attr_total"]

svg.selectAll("text")
    .on("mouseover", function(d) {      
        tooltip.style("opacity", 2);      
        tooltip.html(
            function(x){
                
                var tooltipString = tooltipColumns.map(function(t){
                    return t + ": "  + (formatter(t) ? formatter(t)(d['campaign_metrics'][t]) : d['campaign_metrics'][t]) + "<br>" 
                })
                .join("")
                tooltipString = d.name + "<br>" + tooltipString
                return tooltipString
            }

        ) 
            .style("left", (d3.event.pageX) + "px")     
            .style("top", (d3.event.pageY - 28) + "px");  
        })  
    .on("mousemove", function(d) {      
        tooltip.style("opacity", 2);      
        tooltip.html(
            function(x){
                var tooltipString = tooltipColumns.map(function(t){
                    return t + ": "  + (formatter(t) ? formatter(t)(d['campaign_metrics'][t]) : d['campaign_metrics'][t]) + "<br>" 
                })
                .join("")
                tooltipString = d.name + "<br>" + tooltipString
                return tooltipString
            }

        ) 
            .style("left", (d3.event.pageX) + "px")     
            .style("top", (d3.event.pageY - 28) + "px");  
        })                 
    .on("mouseout", function(d) {       
        tooltip.transition()        
            .style("opacity", 0);   
    });


d3.select("#adjustments").data([campaign_metrics]).enter().append('div').classed("campaign_metrics",true)

svg.selectAll("text").on("click", function(d){
    d3.select("#adjustments").selectAll("*").remove()

    var commit = d3.select("#adjustments").append("a")
        .classed("btn-success btn btn-small btn-default commit-all", true)
        .text("Commit All")
        .style("margin","5px")


    var columns = [ 'campaign_id','campaign_name','cpa_attr_total','imps_30d', 'conv_30d','cpa_attr_30d','cpa_attr_30d',
                     'cpa_attr_7d','attr_conv_7d', 'imps_yest','media_cost_yest', 'cpm','bid','budget', 
                     'enable_pacing', 'state']

    var campaigns = d3.select("#adjustments").data()[0].filter(function(x){
        return d.campaigns.indexOf(x.campaign_id) > - 1
    })

    columns = columns.map(function(x){
        var obj =  {
            'name': x,
            'type': 'text',
            'formatter': formatter(x)
        }
        if (x == "budget" || x == "bid"  || x == "enable_pacing" || x=="state"){
            obj['class'] = x
            obj['type'] = "input"
        }
        return obj
    })
    var table = make_table(d3.select("#adjustments"), columns, campaigns)
    table.classed("tablesorter table-striped table-hover table-bordered",true).attr("id","optTable")
    table.attr("border", "1px solid gray").attr("rules","rows")
    table.style({'width': "50px"})
    table.selectAll("input").classed("input-small",true)

    commit.on("click", function(x){
        var adjustments = table.selectAll("input")[0].map(function(x){  

            var old = d3.select(x).datum()['value']
            var value = d3.select(x).property("value")
            var field = d3.select(x).datum()['name']
            var campaign_id = d3.select(x.parentNode.parentNode).datum()['campaign_id']

            if (field == "budget"){
                field = d3.select(x.parentNode.parentNode).datum()['budget_type']
            }
            if (field == "bid"){
                field = d3.select(x.parentNode.parentNode).datum()['bid_type']
            }

            if( d3.select(x).property("value") != "" ){
                return {'field':field, 'new':value, "campaign_id": campaign_id, "old":old ? old : "NA"}
            }
        }) 
        adjustments = adjustments.filter(function(n){ return n != undefined })

        var advertiser = getParameterByName("advertiser")
        d3.xhr("/adjustments?advertiser="+advertiser).post(JSON.stringify(adjustments))


    })

    $("#optTable").tablesorter()

})



function formatter(x){
    if( x.indexOf('cpa') > -1 || x.indexOf('media_cost') > -1  || x.indexOf('cpm') > -1){
        return d3.format("$,.2f")
    }

    if( x.indexOf('imps') > -1 || x.indexOf('conv') > -1){
        return d3.format(",.0f")
    }
}



</script>
</body>