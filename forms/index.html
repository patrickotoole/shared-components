{% autoescape None %}
<head>
  <style>
    .hidden { display:none }
    .build-form .row { padding:1px; padding-left:5px;  }
    .form-description { padding-bottom: 20px }
    .label { display:inline-block; width:175px; vertical-align:top }
    .field { display:inline-block; width:200px; vertical-align:top }
    .field select, .field input { width: 180px }
    .description{ display:inline-block; width:500px; vertical-align:top }

    .row span { min-width:250px; display:inline-block }

  </style>
  <script data-require="d3@3.5.3" data-semver="3.5.3" src="/js/d3.js"></script>

  <script src="/js/forms/build/form_builder.js"></script>
  <script src="/js/state/build/state.js"></script>

  <script>

    var d3_updateable = function(target,selector,type,data,joiner) {
      var type = type || "div"
      var updateable = target.selectAll(selector).data(
        function(x){return data ? [data] : [x]},
        joiner || function(x){return [x]}
      )
    
      updateable.enter()
        .append(type)
    
      return updateable
    }
    
    var d3_splat = function(target,selector,type,data,joiner) {
      var type = type || "div"
      var updateable = target.selectAll(selector).data(
        data || function(x){return x},
        joiner || function(x){return x}
      )
    
      updateable.enter()
        .append(type)
    
      return updateable
    }

  </script>
  
</head>

<body style="width:1200px;margin-left:auto;margin-right:auto">
  <h4 id="page-title">Forms</h4>
  <div class="content"></div>
  <div class="completed"></div>
  <script>

    var content = d3.select(".content")

    var forms = [
        {"name":"first_form", "fields":[{"name":"1","type":"input"}], "script":"yo"}
      , {"name":"second_form", "fields":[{"name":"hello","type":"input"},{"name":"yo","type":"select","values":[]}],"script":"yo2"}
    ]

    forms = {{forms}}

  </script>
  <script>
    var obj = state.qs().from(document.location.search)


    var index = form_builder.form_index(content)
      .forms(forms)
      .on("click", function(x) {
        history.pushState({},"", "/" + state.qs().to(x))
        index.render_back(x.name)
        index.render_form.bind(index)(index._show,x)
      })
      .on("submit", function(x) {
        d3.xhr("/submit").post(JSON.stringify(x), function(err,resp){
          var target = d3.select(".completed")
          if (err) return target.text("error")
          return target.text(resp.response)
        })
      })
      .on("create", function(x) {
        d3.xhr("/").post(JSON.stringify(x), function(){
          debugger
        })
      })
      .draw()


    var new_obj = forms.filter(function(x) { return x.name == obj.name})[0]
    if (obj.name) index.on("click").bind(index)(new_obj)

  </script>
</body>
