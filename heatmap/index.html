<!doctype html>
<html>
  <head>
    <title>Realtime Ads</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
      }

      div#map {
        position: fixed;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- <script src="https://maps.google.com/maps/api/js"></script> -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?libraries=visualization&callback=initMap">
    </script>
    <script type="text/javascript">
    function initMap() {
      var map_style = [{"featureType":"all","elementType":"all","stylers":[{"invert_lightness":true},{"saturation":10},{"lightness":30},{"gamma":0.5},{"hue":"#435158"}]}];

      var map = new google.maps.Map(document.getElementById('map'), {
        center: {
          lat: 40,
          lng: -100
        },
        styles: map_style,
        zoom: 5
      });

      var heatmap_points = [];
      
      var getPoints = function() {
        return heatmap_points
      }

      setTimeout(function() {
        heatmap = new google.maps.visualization.HeatmapLayer({
          data: getPoints(),
          map: map,
          radius: 20
        });
      }, 10000)
      var addImpression = function(latitude, longitude) {
        if(!isNaN(latitude) && !isNaN(longitude)) {
          heatmap_points.push(new google.maps.LatLng(latitude, longitude));
        }
        // new google.maps.Circle({
        //   strokeColor: '#FF0000',
        //   strokeOpacity: 0,
        //   strokeWeight: 1,
        //   fillColor: '#FF0000',
        //   fillOpacity: .05,
        //   map: map,
        //   center: new google.maps.LatLng(latitude, longitude),
        //   radius: 10000
        // });
      };

      var ws = new WebSocket("ws://localhost:9000/");
      ws.onopen = function() {
        ws.send("Let's go!");
      };
      ws.onmessage = function (e) {
        var impression = JSON.parse(e.data);
        addImpression(impression.location.latitude, impression.location.longitude)
      };
      ws.onclose = function() { };
    }


      //
      // function init_heatmap() {
      //
      //   var gradient = [
      //     'rgba(0, 255, 255, 0)',
      //     'rgba(0, 255, 255, 1)',
      //     'rgba(0, 191, 255, 1)',
      //     'rgba(0, 127, 255, 1)',
      //     'rgba(0, 63, 255, 1)',
      //     'rgba(0, 0, 255, 1)',
      //     'rgba(0, 0, 223, 1)',
      //     'rgba(0, 0, 191, 1)',
      //     'rgba(0, 0, 159, 1)',
      //     'rgba(0, 0, 127, 1)',
      //     'rgba(63, 0, 91, 1)',
      //     'rgba(127, 0, 63, 1)',
      //     'rgba(191, 0, 31, 1)',
      //     'rgba(255, 0, 0, 1)'
      //   ]
      //   heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
      //   heatmap.set('radius', heatmap.get('radius') ? null : 20);
      //   heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
      // };

    </script>
  </body>
</html>
